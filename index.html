<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智慧雲端記帳本 (Pro版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- QR Code Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- Excel Export Library (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Markdown Parser for AI Chat -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6;
            width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal Animation */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #imageViewerModal { transition: opacity 0.3s ease; }
        #imageViewerModal.hidden { opacity: 0; pointer-events: none; }
        #imageViewerModal:not(.hidden) { opacity: 1; pointer-events: auto; }
        
        .archived-ledger { filter: grayscale(1); opacity: 0.7; }
        .archived-ledger:hover { filter: grayscale(0); opacity: 1; }

        /* Item Row Animation */
        .item-row { transition: all 0.2s; }
        .item-row:hover { background-color: #f8fafc; }
        
        /* Category Chips */
        .cat-chip { transition: all 0.2s; }
        .cat-chip:hover { transform: scale(1.05); }

        /* Tab Styles */
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: bold; }
        
        /* Custom Details Marker */
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }

        /* Grouped Transaction Styles */
        .tx-group-header { cursor: pointer; transition: background-color 0.2s; }
        .tx-group-header:hover { background-color: #f0f9ff; }
        .tx-detail-row { background-color: #f8fafc; animation: fadeIn 0.2s ease-out; }

        /* Chart Mode Buttons */
        .chart-mode-btn { transition: all 0.2s; }
        .chart-mode-btn.active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-800 text-white flex flex-col shadow-xl z-20 hidden md:flex">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-wallet text-emerald-400"></i> AI 雲端記帳
            </h1>
            <!-- User Profile Trigger -->
            <div id="currentUserDisplay" class="mt-6 p-3 bg-slate-700/50 rounded-xl cursor-pointer hover:bg-slate-700 transition group" onclick="ui.openUserProfile()">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-lg">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-bold text-white group-hover:text-emerald-300 transition truncate"><span id="sidebarUserName">未登入</span></p>
                        <p class="text-xs text-slate-400">設定 / 切換</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 flex-1 overflow-y-auto">
            <div class="flex justify-between items-center mb-4 text-slate-400 text-sm font-bold uppercase">
                <span>我的帳本</span>
                <button onclick="ui.openModal('ledgerModal')" class="hover:text-white transition"><i class="fa-solid fa-plus"></i></button>
            </div>
            <ul id="ledgerList" class="space-y-2"></ul>
            
            <div id="archivedSection" class="mt-6 hidden">
                <div class="text-xs text-slate-500 font-bold uppercase mb-2 border-t border-slate-700 pt-4">已歸檔 / 結算</div>
                <ul id="archivedLedgerList" class="space-y-2"></ul>
            </div>
        </div>

        <div class="p-4 border-t border-slate-700 space-y-2">
            <!-- Import Excel Button (New) -->
            <button onclick="ui.openModal('importModal')" class="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-700 transition text-slate-300 hover:text-white">
                <i class="fa-solid fa-file-import text-emerald-400"></i> 匯入 Excel
            </button>
            <button onclick="ui.openSettings()" class="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-700 transition text-slate-300 hover:text-white">
                <i class="fa-solid fa-gear"></i> 系統設定
            </button>
            <button onclick="ui.logout()" class="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-700 transition text-slate-300 hover:text-white">
                <i class="fa-solid fa-right-from-bracket"></i> 登出
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-y-auto">
        <header class="bg-white p-4 shadow-sm flex justify-between items-center md:hidden sticky top-0 z-30">
            <h1 class="font-bold text-lg"><i class="fa-solid fa-wallet text-emerald-500"></i> 記帳本</h1>
            <button onclick="ui.toggleMobileMenu()" class="text-gray-600"><i class="fa-solid fa-bars text-xl"></i></button>
        </header>

        <!-- Top Control Bar: Optimized for Mobile -->
        <div class="bg-white border-b border-gray-200 p-4 md:p-6 flex flex-col md:flex-row md:justify-between md:items-center gap-4 sticky top-0 z-20 shadow-sm md:static">
            
            <!-- Left Side: Title & Info -->
            <div class="flex flex-col gap-1">
                <div class="flex items-center justify-between md:justify-start gap-3">
                    <h2 id="currentLedgerTitle" class="text-xl md:text-2xl font-bold text-gray-800 truncate max-w-[200px] md:max-w-md">載入中...</h2>
                    <!-- Date Filter moved here for mobile convenience or keep inline -->
                </div>
                <div class="flex items-center gap-2">
                    <span id="ledgerTypeBadge" class="hidden px-2 py-0.5 rounded text-xs font-bold bg-blue-100 text-blue-700">個人</span>
                    <span id="ledgerStatusBadge" class="hidden px-2 py-0.5 rounded text-xs font-bold bg-gray-200 text-gray-600">已歸檔</span>
                    <p id="ledgerMembers" class="text-gray-500 text-xs md:text-sm hidden truncate max-w-[250px]"></p>
                </div>
            </div>

            <!-- Right Side: Actions (Wrapped for mobile) -->
            <div class="flex flex-wrap items-center gap-2 justify-end">
                <!-- Date Filters -->
                <div class="flex bg-gray-100 rounded-lg p-1" id="globalDateFilter">
                    <select id="ledgerYear" class="bg-transparent text-sm font-bold text-gray-700 p-1 outline-none max-w-[70px]" onchange="app.updateLedgerView()"></select>
                    <div class="w-[1px] bg-gray-300 my-1"></div>
                    <select id="ledgerMonth" class="bg-transparent text-sm font-bold text-gray-700 p-1 outline-none" onchange="app.updateLedgerView()">
                        <option value="all">全年</option>
                        <option value="01">1月</option><option value="02">2月</option><option value="03">3月</option>
                        <option value="04">4月</option><option value="05">5月</option><option value="06">6月</option>
                        <option value="07">7月</option><option value="08">8月</option><option value="09">9月</option>
                        <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <button id="settleBtn" onclick="app.calculateDebt()" class="hidden bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-lg shadow transition flex items-center gap-1 font-medium text-xs md:text-sm">
                        <i class="fa-solid fa-calculator"></i> <span class="hidden sm:inline">分帳</span>
                    </button>
                    
                    <button onclick="ui.openRecurringModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg shadow transition flex items-center gap-1 font-medium text-xs md:text-sm">
                        <i class="fa-solid fa-calendar-check"></i> <span class="hidden sm:inline">固定</span>
                    </button>

                    <button id="addTxBtn" onclick="ui.openTransactionModal()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow transition flex items-center gap-1 font-medium text-xs md:text-sm">
                        <i class="fa-solid fa-plus"></i> 記一筆
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Cards -->
        <div class="p-4 grid grid-cols-3 gap-2 md:gap-6">
            <div class="bg-white p-2 md:p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                <p class="text-gray-500 text-[10px] md:text-xs font-bold uppercase mb-1">總支出</p>
                <p id="totalExpense" class="text-base md:text-3xl font-bold text-rose-600">$0</p>
            </div>
            <div class="bg-white p-2 md:p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                <p class="text-gray-500 text-[10px] md:text-xs font-bold uppercase mb-1">總收入</p>
                <p id="totalIncome" class="text-base md:text-3xl font-bold text-emerald-600">$0</p>
            </div>
            <div class="bg-white p-2 md:p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                <p class="text-gray-500 text-[10px] md:text-xs font-bold uppercase mb-1">結餘</p>
                <p id="totalBalance" class="text-base md:text-3xl font-bold text-blue-600">$0</p>
            </div>
        </div>

        <!-- UPDATED: Collapsible In-Ledger Analysis Section with Merchant Stats -->
        <div class="px-4 md:px-6 py-2 md:py-4">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <!-- Header / Toggle -->
                <div class="p-4 bg-gray-50 cursor-pointer flex justify-between items-center hover:bg-gray-100 transition" onclick="ui.toggleStatsSection()">
                    <h3 class="font-bold text-gray-700 text-sm flex items-center gap-2">
                        <i class="fa-solid fa-chart-pie text-blue-500"></i> 收支與商店分析
                    </h3>
                    <i id="statsToggleIcon" class="fa-solid fa-chevron-down text-gray-400 transition-transform"></i>
                </div>
                
                <!-- Content (Default Hidden) -->
                <div id="statsContent" class="hidden p-4 border-t border-gray-100">
                    <div class="flex gap-4 overflow-x-auto pb-2">
                        <!-- Expense Categories -->
                        <div class="flex-1 min-w-[250px] md:min-w-[300px]">
                            <h4 class="text-xs font-bold text-rose-500 uppercase mb-2 border-b border-rose-100 pb-1">消費統計 (依類別)</h4>
                            <div id="topExpenseList" class="space-y-2"></div>
                        </div>
                        <!-- Merchant Stats (New) -->
                        <div class="flex-1 min-w-[250px] md:min-w-[300px]">
                            <h4 class="text-xs font-bold text-blue-500 uppercase mb-2 border-b border-blue-100 pb-1">商店/對象消費統計</h4>
                            <div id="topMerchantList" class="space-y-2"></div>
                        </div>
                        <!-- Income Categories -->
                        <div class="flex-1 min-w-[250px] md:min-w-[300px]">
                            <h4 class="text-xs font-bold text-emerald-500 uppercase mb-2 border-b border-emerald-100 pb-1">收入來源 (依類別)</h4>
                            <div id="topIncomeList" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- List -->
        <div class="flex-1 p-4 md:p-6 pt-0">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-[500px] md:h-[600px]">
                <div class="p-3 md:p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-gray-700 text-sm md:text-base" id="listHeaderTitle">交易紀錄</h3>
                    <div class="flex items-center gap-2">
                          <button id="bulkDeleteBtn" onclick="app.deleteSelected()" class="hidden text-xs bg-red-100 hover:bg-red-200 text-red-600 px-2 py-1 rounded font-bold transition flex items-center gap-1">
                             <i class="fa-solid fa-trash-can"></i> <span class="hidden md:inline">刪除</span>(<span id="selectedCount">0</span>)
                          </button>
                          
                          <!-- List Export Button -->
                          <button onclick="app.exportCurrentList()" class="text-xs bg-emerald-100 hover:bg-emerald-200 text-emerald-700 px-2 py-1 rounded font-bold transition flex items-center gap-1">
                             <i class="fa-solid fa-file-export"></i> <span class="hidden md:inline">匯出</span>
                          </button>

                          <button id="clearFilterBtn" onclick="app.clearDateFilter()" class="hidden text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-600"><i class="fa-solid fa-filter-circle-xmark"></i></button>
                        <div id="loadingIndicator" class="hidden flex items-center gap-1 text-xs text-gray-500">
                            <div class="loader w-4 h-4"></div> <span class="hidden md:inline">同步中...</span>
                        </div>
                    </div>
                </div>
                <div class="overflow-y-auto flex-1 relative">
                    <table class="w-full text-left border-collapse">
                        <thead class="sticky top-0 bg-gray-50 z-10 shadow-sm">
                            <tr class="text-gray-500 text-xs md:text-sm border-b border-gray-100">
                                <!-- Hide Checkbox on Mobile -->
                                <th class="hidden md:table-cell p-2 md:p-4 w-10 text-center"><input type="checkbox" id="selectAllTx" onchange="ui.toggleSelectAll(this)" class="w-4 h-4 cursor-pointer"></th>
                                <th class="p-2 md:p-4 font-medium w-24 md:w-32">日期</th>
                                <th class="p-2 md:p-4 font-medium">項目</th>
                                <th class="p-2 md:p-4 font-medium text-right w-24 md:w-32">金額</th>
                                <th class="p-2 md:p-4 font-medium text-center w-8 md:w-16"></th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <tr><td colspan="5" class="p-8 text-center text-gray-400">尚未選擇帳本或無資料</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Recurring Transactions -->
    <div id="recurringModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 m-4 animate-fade-in max-h-[90vh] overflow-y-auto flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-calendar-check text-purple-500"></i> 固定收支設定
                </h3>
                <button onclick="ui.closeModal('recurringModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <!-- List of Rules -->
            <div id="recurringListSection" class="flex-1 overflow-y-auto mb-4">
                <div id="recurringRulesList" class="space-y-3">
                    <div class="text-center text-gray-400 py-8">載入中...</div>
                </div>
            </div>

            <!-- Add/Edit Form (Hidden by default) -->
            <div id="recurringFormSection" class="hidden bg-gray-50 p-4 rounded-xl border border-gray-200">
                <h4 class="font-bold text-gray-700 mb-3 text-sm" id="recurringFormTitle">新增規則</h4>
                <form onsubmit="app.saveRecurringRule(event)" class="space-y-3">
                    <input type="hidden" id="recRuleId">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">類型</label>
                            <select id="recType" class="w-full p-2 border border-gray-300 rounded text-sm bg-white" onchange="ui.updateCategoriesForRecurring()">
                                <option value="expense">支出</option>
                                <option value="income">收入</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">週期</label>
                            <select id="recFreq" class="w-full p-2 border border-gray-300 rounded text-sm bg-white">
                                <option value="monthly">每月一次</option>
                                <option value="yearly">每年一次</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">項目名稱</label>
                            <input type="text" id="recName" required placeholder="例如：Netflix" class="w-full p-2 border border-gray-300 rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">金額</label>
                            <input type="number" id="recAmount" required placeholder="0" class="w-full p-2 border border-gray-300 rounded text-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">分類</label>
                            <select id="recCategory" class="w-full p-2 border border-gray-300 rounded text-sm bg-white"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">下次到期日</label>
                            <input type="date" id="recNextDate" required class="w-full p-2 border border-gray-300 rounded text-sm">
                        </div>
                    </div>
                    
                    <div class="flex gap-2 pt-2">
                        <button type="button" onclick="ui.toggleRecurringForm(false)" class="flex-1 py-2 text-gray-500 hover:bg-gray-200 rounded text-sm font-bold">取消</button>
                        <button type="submit" class="flex-1 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm font-bold shadow">儲存設定</button>
                    </div>
                </form>
            </div>

            <button id="btnAddRecurring" onclick="ui.toggleRecurringForm(true)" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-purple-400 hover:text-purple-600 transition font-bold flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus"></i> 新增固定收支規則
            </button>
        </div>
    </div>

    <!-- Modal: Create Ledger (Fixed) -->
    <div id="ledgerModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 m-4 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">📘 建立新帳本</h3>
                <button onclick="ui.closeModal('ledgerModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">帳本名稱</label>
                    <input type="text" id="newLedgerName" placeholder="例如：2024日本遊、公司報帳..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">類型</label>
                        <select id="newLedgerType" class="w-full p-3 border border-gray-300 rounded-lg bg-white text-sm" onchange="ui.toggleMemberInput()">
                            <option value="personal">個人帳本</option>
                            <option value="group">多人共用</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">預設幣別</label>
                        <select id="newLedgerCurrency" class="w-full p-3 border border-gray-300 rounded-lg bg-white text-sm">
                            <option value="TWD">TWD (台幣)</option>
                            <option value="JPY">JPY (日幣)</option>
                            <option value="USD">USD (美金)</option>
                            <option value="EUR">EUR (歐元)</option>
                            <option value="KRW">KRW (韓元)</option>
                            <option value="CNY">CNY (人民幣)</option>
                        </select>
                    </div>
                </div>
                <div id="memberInputDiv" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">選擇成員</label>
                    <div id="memberSelectionList" class="max-h-32 overflow-y-auto border border-gray-300 rounded p-2 bg-gray-50 grid grid-cols-2 gap-2 text-sm">
                        <!-- Checkboxes will be injected here -->
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1"><i class="fa-solid fa-circle-info"></i> 僅顯示已建立的使用者。若找不到成員，請先登出並建立新角色。</p>
                </div>
                <!-- 移除帳本密碼欄位 -->
                <button onclick="app.createLedger()" class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-lg mt-2">立即建立</button>
            </div>
        </div>
    </div>

    <!-- Modal: Image Viewer -->
    <div id="imageViewerModal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center" onclick="ui.closeImageModal()">
        <div class="relative max-w-4xl max-h-[90vh] p-2" onclick="event.stopPropagation()">
            <button onclick="ui.closeImageModal()" class="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300 transition"><i class="fa-solid fa-times"></i></button>
            <img id="imageViewerSrc" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl border-2 border-gray-800" src="" referrerpolicy="no-referrer" onerror="this.src='https://placehold.co/600x400?text=Image+Load+Error'">
            <div class="text-center mt-4"><a id="imageViewerLink" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm underline"><i class="fa-solid fa-external-link-alt"></i> 開啟原圖</a></div>
        </div>
    </div>

    <!-- Modal: Login / User Select -->
    <div id="loginModal" class="fixed inset-0 bg-slate-900/95 z-[90] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-8 m-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl"><i class="fa-solid fa-user-group"></i></div>
                <h3 class="text-xl font-bold text-gray-800">請選擇您的身分</h3>
                <p class="text-gray-500 text-sm">多人帳本將依據此身分進行分帳</p>
            </div>

            <!-- Existing User Select -->
            <div id="existingUserSection" class="mb-6 space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">選擇現有角色</label>
                    <select id="loginUserSelect" class="w-full p-3 border border-gray-300 rounded-lg mb-2 bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">載入中...</option>
                    </select>
                </div>
                <div>
                    <input type="password" id="loginPasswordInput" placeholder="請輸入密碼 (舊用戶若無則留空)" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="app.loginExistingUser()" class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold transition">登入</button>
            </div>

            <div class="relative flex py-2 items-center mb-6">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">或</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <!-- Create New User -->
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">建立新角色</label>
                <div class="space-y-2">
                    <input type="text" id="newUserNameInput" placeholder="輸入新暱稱" class="w-full p-3 border border-gray-300 rounded-lg text-sm">
                    <input type="password" id="newUserNamePassword" placeholder="設定登入密碼" class="w-full p-3 border border-gray-300 rounded-lg text-sm">
                    <button onclick="app.registerNewUser()" class="w-full bg-gray-800 text-white py-3 rounded-lg hover:bg-gray-900 transition font-bold">建立並登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: User Profile & Rename -->
    <div id="userProfileModal" class="fixed inset-0 bg-slate-900/90 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl p-6 m-4 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-id-card text-indigo-500"></i> 個人中心</h3>
                <button onclick="ui.closeModal('userProfileModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>

            <!-- Tabs -->
            <div class="flex gap-4 border-b border-gray-200 mb-4 overflow-x-auto">
                <button onclick="ui.switchProfileTab('overview')" id="tab-overview" class="tab-btn active px-2 py-2 text-sm text-gray-600 hover:text-blue-600 transition whitespace-nowrap">帳本概況</button>
                <button onclick="ui.switchProfileTab('assets')" id="tab-assets" class="tab-btn px-2 py-2 text-sm text-gray-600 hover:text-blue-600 transition whitespace-nowrap">我的資產</button>
                <button onclick="ui.switchProfileTab('ai-assistant')" id="tab-ai-assistant" class="tab-btn px-2 py-2 text-sm text-gray-600 hover:text-blue-600 transition whitespace-nowrap">AI 帳務助理</button>
                <button onclick="ui.switchProfileTab('settings')" id="tab-settings" class="tab-btn px-2 py-2 text-sm text-gray-600 hover:text-blue-600 transition whitespace-nowrap">個人設定</button>
            </div>

            <div class="overflow-y-auto flex-1 pr-2">
                <!-- TAB 1: Overview -->
                <div id="content-overview">
                    <div class="flex flex-wrap items-center gap-3 mb-4 bg-gray-50 p-3 rounded-xl sticky top-0 z-10 shadow-sm">
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-bold text-gray-500">年份</label>
                            <select id="statYear" class="p-1.5 border border-gray-300 rounded text-sm" onchange="app.loadUserStats()"></select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-bold text-gray-500">月份</label>
                            <select id="statMonth" class="p-1.5 border border-gray-300 rounded text-sm" onchange="app.loadUserStats()">
                                <option value="all">全年</option>
                                <option value="01">1月</option><option value="02">2月</option><option value="03">3月</option>
                                <option value="04">4月</option><option value="05">5月</option><option value="06">6月</option>
                                <option value="07">7月</option><option value="08">8月</option><option value="09">9月</option>
                                <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-auto">
                            <input type="checkbox" id="showDetailsCheck" class="w-4 h-4 text-blue-600 rounded" onchange="app.loadUserStats()">
                            <label for="showDetailsCheck" class="text-sm text-gray-600 select-none cursor-pointer">顯示詳細統計</label>
                        </div>
                        <button onclick="app.exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1 shadow-sm">
                            <i class="fa-solid fa-file-excel"></i> 匯出Excel
                        </button>
                    </div>
                    <div id="statsLoader" class="hidden text-center py-10 text-gray-500"><div class="loader mx-auto mb-2"></div>數據分析中...</div>
                    <div id="ledgerStatsContainer" class="space-y-4"></div>
                </div>

                <!-- TAB 2: Assets (New) -->
                <div id="content-assets" class="hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-5 text-white mb-6 shadow-lg">
                        <p class="text-blue-100 text-sm mb-1">個人資產總計</p>
                        <h2 class="text-3xl font-bold" id="totalAssetDisplay">$0</h2>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                        <h4 class="font-bold text-gray-700 mb-3 text-sm" id="assetActionTitle">新增 / 更新資產</h4>
                        <div class="flex gap-2 mb-2">
                            <!-- Updated: Input with Datalist for Dropdown -->
                            <input type="text" id="assetNameInput" list="assetNamesList" placeholder="帳戶名稱 (如: 玉山銀行)" class="flex-1 p-2 border border-gray-300 rounded text-sm">
                            <datalist id="assetNamesList"></datalist>
                            <input type="number" id="assetBalanceInput" placeholder="目前金額" class="w-1/3 p-2 border border-gray-300 rounded text-sm">
                        </div>
                        <button onclick="app.saveAsset()" class="w-full bg-slate-800 text-white py-2 rounded text-sm font-bold hover:bg-slate-900 transition">更新餘額</button>
                        <p class="text-xs text-gray-400 mt-2">* 若名稱相同則會更新餘額並記錄歷史。</p>
                    </div>

                    <h4 class="font-bold text-gray-700 mb-3 text-sm border-b border-gray-200 pb-2">資產列表</h4>
                    <div id="assetsList" class="space-y-3">
                        <div class="text-center text-gray-400 py-4 text-sm">暫無資產紀錄</div>
                    </div>
                </div>

                <!-- TAB 3: AI Assistant -->
                <div id="content-ai-assistant" class="hidden h-full flex flex-col">
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4 flex-1 flex flex-col min-h-[300px]">
                        <div class="text-center mb-4">
                            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-2 text-indigo-600 text-xl"><i class="fa-solid fa-robot"></i></div>
                            <h4 class="font-bold text-indigo-900">AI 帳務助理</h4>
                            <p class="text-xs text-indigo-500">我可以根據您的帳本資料回答問題，例如：「上個月餐費多少？」、「哪個帳本花最兇？」</p>
                        </div>
                        <div id="aiChatHistory" class="flex-1 overflow-y-auto space-y-3 mb-3 p-2 bg-white/50 rounded-lg max-h-[300px]">
                            <div class="text-xs text-gray-400 text-center italic">-- 對話紀錄 --</div>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="aiChatInput" placeholder="輸入您的問題..." class="flex-1 p-3 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm" onkeypress="if(event.key==='Enter') app.askAI()">
                            <button onclick="app.askAI()" id="btnAiSend" class="bg-indigo-600 text-white px-4 rounded-lg hover:bg-indigo-700 transition"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: Settings -->
                <div id="content-settings" class="hidden">
                    <div class="bg-gray-50 p-5 rounded-xl border border-gray-100 mb-4">
                        <label class="block text-xs font-bold text-gray-800 uppercase mb-2">修改顯示名稱</label>
                        <div class="flex gap-2">
                            <input type="text" id="renameInput" placeholder="輸入新名稱" class="flex-1 p-3 border border-gray-300 rounded-lg font-bold text-gray-700">
                            <button onclick="app.renameUser()" id="renameBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-6 rounded-lg font-bold transition whitespace-nowrap">確認</button>
                        </div>
                        <p class="text-xs text-gray-400 mt-2"><i class="fa-solid fa-circle-exclamation"></i> 這會更新所有帳本中的顯示名稱。</p>
                    </div>

                    <div class="bg-yellow-50 p-5 rounded-xl border border-yellow-100">
                        <label class="block text-xs font-bold text-yellow-800 uppercase mb-2">重設登入密碼</label>
                        <div class="flex gap-2 items-center">
                            <button onclick="app.changeUserPassword()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg font-bold transition whitespace-nowrap">立即重設密碼</button>
                            <span class="text-xs text-yellow-600">忘記密碼請重設，無需舊密碼</span>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h4 class="font-bold text-gray-700 mb-2">常用商店管理</h4>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="newMerchantName" placeholder="商店名稱" class="flex-1 p-2 border border-gray-300 rounded text-sm">
                                <button onclick="app.addMerchant()" class="bg-blue-600 text-white px-3 rounded hover:bg-blue-700"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <div id="merchantListSetting" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <div class="mt-8 text-center">
                         <button onclick="ui.logout()" class="text-sm text-red-500 hover:underline"><i class="fa-solid fa-right-from-bracket"></i> 登出/切換帳號</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Settlement & Archive -->
    <div id="settleModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 m-4 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">💰 結算分帳</h3>
                <button onclick="ui.closeModal('settleModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="settleContent" class="space-y-4 mb-6"></div>
            <div class="border-t border-gray-100 pt-4 bg-yellow-50 p-4 rounded-lg">
                <h4 class="font-bold text-gray-700 mb-2 flex items-center gap-2"><i class="fa-solid fa-box-archive text-yellow-600"></i> 結算並歸檔</h4>
                <p class="text-xs text-gray-500 mb-3">將此帳本封存，並將您的應付金額 ($<span id="settleShareAmount">0</span>) 記錄到個人帳本。</p>
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-500 mb-1">選擇要記入的個人帳本</label>
                    <select id="targetPersonalLedger" class="w-full p-2 border border-gray-300 rounded text-sm bg-white"></select>
                </div>
                <button onclick="app.archiveLedger()" class="w-full py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm font-bold shadow">確認歸檔並記帳</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Import Excel -->
    <div id="importModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 m-4 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-file-import text-emerald-500"></i> 匯入 Excel 紀錄
                </h3>
                <button onclick="ui.closeModal('importModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-6">
                <!-- Step 1: Download Template -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h4 class="font-bold text-blue-800 mb-2 text-sm">步驟 1：下載標準範本</h4>
                    <p class="text-xs text-blue-600 mb-3">請先下載 Excel 範本，並依照格式填入您的舊帳本資料。</p>
                    <button onclick="app.downloadTemplate()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-2">
                        <i class="fa-solid fa-download"></i> 下載 Excel 範本 (.xlsx)
                    </button>
                </div>

                <!-- Step 2: Upload File -->
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-emerald-400 transition relative bg-gray-50 group">
                    <input type="file" id="importFile" accept=".xlsx, .xls, .csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="app.handleFileSelect(this)">
                    <div id="importPlaceholder">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-500 text-2xl group-hover:bg-emerald-100 group-hover:text-emerald-500 transition">
                            <i class="fa-solid fa-upload"></i>
                        </div>
                        <p class="font-bold text-gray-600">點擊或拖曳檔案至此</p>
                        <p class="text-xs text-gray-400 mt-1">支援格式: .xlsx, .csv</p>
                    </div>
                    <div id="importFileDisplay" class="hidden">
                        <p class="font-bold text-emerald-600 mb-1" id="importFileName"></p>
                        <p class="text-xs text-gray-500">已準備好匯入</p>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-3 justify-end">
                    <button onclick="ui.closeModal('importModal')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-bold">取消</button>
                    <button onclick="app.processImport()" id="btnStartImport" class="px-6 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-bold shadow disabled:opacity-50 disabled:cursor-not-allowed">
                        開始匯入
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Settings -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 m-4 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">⚙️ 系統設定</h3>
                <button onclick="ui.closeModal('settingsModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <label class="block text-sm font-bold text-blue-800 mb-1">Google Drive 上傳網址</label>
                    <input type="text" id="scriptUrlInput" placeholder="https://script.google.com/macros/s/..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-xs font-mono">
                </div>
                <div>
                    <label id="apiKeyLabel" class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key</label>
                    <input type="password" id="geminiKeyInput" placeholder="貼上您的 API Key" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">自訂 AI 辨識提示詞 (選填)</label>
                    <textarea id="aiPromptInput" rows="2" placeholder="例如：請將『拿鐵』分類為『娛樂』。遇到全家便利商店請自動帶入商店名稱。" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                    <p class="text-xs text-gray-400 mt-1">您可以輸入特定規則來引導 AI 辨識收據內容。</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Firebase Config (已鎖定)</label>
                    <textarea id="firebaseConfigInput" rows="4" readonly class="w-full p-3 border border-gray-300 bg-gray-100 rounded-lg font-mono text-xs text-gray-600 cursor-not-allowed"></textarea>
                </div>
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <h4 class="font-bold text-gray-700 mb-2">當前帳本設定 (<span id="settingLedgerName"></span>)</h4>
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg flex-wrap gap-2">
                        <span class="text-sm text-gray-600 w-full sm:w-auto">密碼保護</span>
                        <div class="flex gap-2">
                            <button onclick="app.setLedgerPassword()" class="text-sm text-blue-500 hover:text-blue-700 font-bold border border-blue-200 px-3 py-1 rounded hover:bg-blue-50 transition"><i class="fa-solid fa-key"></i> 修改/設定密碼</button>
                            <button onclick="app.removeLedgerPassword()" class="text-sm text-red-500 hover:text-red-700 font-bold border border-red-200 px-3 py-1 rounded hover:bg-red-50 transition"><i class="fa-solid fa-unlock"></i> 解除密碼</button>
                        </div>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <h4 class="font-bold text-gray-700 mb-2">自訂分類管理</h4>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex gap-2 mb-2">
                            <select id="newCatType" class="p-2 border border-gray-300 rounded text-sm"><option value="expense">支出</option><option value="income">收入</option></select>
                            <input type="text" id="newCatName" placeholder="新分類名稱" class="flex-1 p-2 border border-gray-300 rounded text-sm">
                            <button onclick="app.addCategory()" class="bg-emerald-600 text-white px-3 rounded hover:bg-emerald-700"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div><p class="text-xs font-bold text-rose-500 mb-1">支出類別</p><div id="expenseCatList" class="flex flex-wrap gap-2"></div></div>
                            <div><p class="text-xs font-bold text-emerald-500 mb-1">收入類別</p><div id="incomeCatList" class="flex flex-wrap gap-2"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button onclick="ui.closeModal('settingsModal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">取消</button>
                <button onclick="app.saveSettings()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">儲存設定</button>
            </div>
        </div>
    </div>

    <!-- TRANSACTION MODAL -->
    <div id="transactionModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 m-4 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="txModalTitle">📝 新增紀錄</h3>
                <button onclick="ui.closeModal('transactionModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="uploadContainer" class="mb-4 bg-indigo-50 border border-indigo-100 rounded-xl p-3 text-center relative group">
                <div id="uploadZone">
                    <input type="file" id="receiptUpload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="ai.handleImageUpload(this)">
                    <div id="aiUploadLabel">
                        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-2 text-indigo-500 text-2xl group-hover:scale-110 transition"><i class="fa-solid fa-camera"></i></div>
                        <p class="text-sm font-bold text-indigo-800">拍照或上傳收據</p>
                        <p class="text-xs text-indigo-500 mt-1">AI 自動掃描品項 (支援電子發票)</p>
                    </div>
                </div>
                <div id="aiLoading" class="hidden relative z-20 mt-2 py-4"><div class="loader mx-auto mb-2 border-indigo-500 border-t-transparent"></div><p class="text-sm font-bold text-indigo-600 animate-pulse" id="aiStatusText">AI 正在辨識收據內容...</p></div>
                <div id="imagePreviewContainer" class="hidden mt-2 relative z-10"><img id="imagePreview" class="h-32 mx-auto rounded object-contain mb-2 border border-gray-200 shadow"><button type="button" onclick="ai.clearImage()" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-600 text-xs rounded-full font-bold transition">清除重選</button></div>
            </div>
            <div id="editHistoryBox" class="hidden mb-4 p-3 bg-gray-50 border border-gray-200 rounded-lg text-xs text-gray-500"><p class="font-bold mb-1">修訂紀錄：</p><ul id="editHistoryList" class="list-disc pl-4 space-y-1"></ul></div>
            <form id="transactionForm" onsubmit="app.addTransaction(event)" class="space-y-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">類型</label><select id="tType" class="w-full p-2 bg-white border border-gray-200 rounded-lg text-sm" onchange="ui.updateCategoriesForRows()"><option value="expense">支出</option><option value="income">收入</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">日期</label><input type="date" id="tDate" required class="w-full p-2 bg-white border border-gray-200 rounded-lg text-sm cursor-pointer hover:bg-gray-50"></div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">商店/對象 (選填)</label>
                        <div class="relative">
                            <input type="text" id="tMerchant" list="merchantDatalist" placeholder="輸入或選擇..." class="w-full p-2 bg-white border border-gray-200 rounded-lg text-sm">
                            <datalist id="merchantDatalist"></datalist>
                        </div>
                    </div>
                    <div id="groupPayerField" class="hidden col-span-2 md:col-span-2"><label class="block text-xs font-bold text-yellow-700 uppercase mb-1">先墊錢的人</label><select id="tPaidBy" class="w-full p-2 bg-white border border-yellow-200 rounded-lg text-sm"></select></div>
                    
                    <!-- NEW Currency Wrapper -->
                    <div class="col-span-2 md:col-span-4 bg-yellow-50 p-2 rounded-lg border border-yellow-100 transition-all" id="currencyWrapper">
                        <!-- View Mode -->
                        <div id="currencyViewMode" class="flex items-center justify-between cursor-pointer" onclick="ui.toggleCurrencyEdit(true)">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-yellow-700">幣別</span>
                                <span id="currencyViewText" class="text-sm font-bold text-gray-700">TWD (匯率: 1)</span>
                            </div>
                            <i class="fa-solid fa-pen text-yellow-600 text-xs"></i>
                        </div>
                        <!-- Edit Mode -->
                        <div id="currencyEditMode" class="hidden flex gap-2 items-center mt-2">
                            <label class="whitespace-nowrap text-xs font-bold text-yellow-700">修改</label>
                            <select id="tCurrency" class="w-24 p-1.5 bg-white border border-yellow-200 rounded text-sm" onchange="app.updateRate()">
                                <option value="TWD">TWD</option><option value="JPY">JPY</option><option value="USD">USD</option><option value="KRW">KRW</option><option value="EUR">EUR</option><option value="CNY">CNY</option>
                            </select>
                            <input type="number" id="tRate" step="0.0001" placeholder="匯率" class="w-20 p-1.5 bg-white border border-yellow-200 rounded text-sm" oninput="app.calcTwd()">
                            <span id="rateHint" class="text-xs text-yellow-600"></span>
                            <button type="button" class="ml-auto text-xs text-gray-400 hover:text-gray-600" onclick="ui.toggleCurrencyEdit(false)"><i class="fa-solid fa-check"></i> 完成</button>
                        </div>
                    </div>

                    <!-- NEW: Split Among Section -->
                    <div id="splitSection" class="col-span-2 md:col-span-4 hidden transition-all duration-300 ease-in-out">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 flex justify-between items-center">
                            <span>分攤給誰 (預設全員)</span>
                            <span class="text-[10px] text-blue-500 cursor-pointer hover:underline" onclick="ui.toggleAllSplit(true)">全選</span>
                        </label>
                        <div class="flex flex-wrap gap-2 bg-gray-50 p-2 border border-gray-200 rounded-lg max-h-24 overflow-y-auto" id="splitUserContainer">
                            <!-- Checkboxes injected by JS -->
                        </div>
                    </div>
                </div>
                <div class="border rounded-xl overflow-hidden border-gray-200">
                    <div class="bg-gray-100 p-2 grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 text-center"><div class="col-span-5 text-left pl-2">項目名稱</div><div class="col-span-3">分類</div><div class="col-span-3">金額</div><div class="col-span-1"></div></div>
                    <div id="transactionItemsList" class="max-h-60 overflow-y-auto"></div>
                    <div class="p-2 bg-gray-50 border-t border-gray-200"><button type="button" id="btnAddItem" onclick="ui.addItemRow()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-emerald-400 hover:text-emerald-500 transition text-sm font-bold"><i class="fa-solid fa-plus"></i> 新增品項</button></div>
                </div>
                <div class="flex justify-between items-center px-2"><div class="text-sm text-gray-500">共 <span id="itemCount">1</span> 筆項目</div><div class="text-right"><p class="text-xs text-gray-400 mb-1" id="totalLabel">總金額 (TWD)</p><p class="text-3xl font-bold text-emerald-600" id="displayTotal">$0</p><p id="twdPreview" class="text-xs text-emerald-600 font-bold hidden">= NT$ <span>0</span></p></div></div>
                <input type="hidden" id="hiddenImageUrl"><input type="hidden" id="editingTxId">
                <div class="pt-2"><button type="submit" id="submitBtn" class="w-full py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-bold shadow-md hover:shadow-lg transition">確認儲存</button></div>
            </form>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="fixed inset-0 bg-slate-900/95 z-40 hidden flex flex-col p-6 md:hidden">
        <div class="flex justify-end mb-6"><button onclick="ui.toggleMobileMenu()" class="text-white text-2xl"><i class="fa-solid fa-times"></i></button></div>
        <div id="mobileLedgerList" class="space-y-4 text-white text-lg font-medium text-center"></div>
        <button onclick="ui.openSettings(); ui.toggleMobileMenu()" class="mt-8 w-full py-3 bg-slate-700 text-slate-200 rounded-lg">設定</button>
        <button onclick="ui.logout()" class="mt-4 w-full py-3 bg-red-900/30 text-red-200 rounded-lg hover:bg-red-900/50 transition">登出</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, deleteDoc, doc, updateDoc, setDoc, getDoc, getDocs, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const FIREBASE_CONFIG = { apiKey: "AIzaSyDqFr0ZkTb9ZdYFaf8S95pjJLEezTF4QwQ", authDomain: "mony-a292c.firebaseapp.com", projectId: "mony-a292c", storageBucket: "mony-a292c.firebasestorage.app", messagingSenderId: "1012872104399", appId: "1:1012872104399:web:8289e7b26d846246fdaaba", measurementId: "G-N5RQB4GCZD" };
        
        // Updated Categories with more comprehensive market standard options
        const DEFAULT_CATEGORIES = { 
            expense: [
                '早餐', '午餐', '晚餐', '飲料', '點心', '食材', 
                '交通', '加油', '停車', '維修',
                '日用', '服飾', '美妝', '3C', 
                '娛樂', '旅遊', '訂閱', '社交',
                '房租', '水電', '網路', '話費',
                '醫療', '保險', '教育', '書籍',
                '親子', '寵物', '孝親', '稅務', '其他'
            ], 
            income: [
                '薪資', '獎金', '兼職', 
                '投資', '股利', '租金', 
                '禮金', '退款', '其他'
            ] 
        };
        const DEFAULT_BANKS = [
            "中華郵政", "台北富邦商業銀行", "中國信託商業銀行", "玉山商業銀行", 
            "永豐商業銀行", "台新國際商業銀行", "凱基商業銀行", "國泰世華商業銀行", 
            "第一商業銀行", "合作金庫", "華南商業銀行", "彰化商業銀行", 
            "遠東國際商業銀行", "星展(台灣)商業銀行"
        ];
        
        const DEFAULT_MERCHANTS = [
            "7-ELEVEN", "全家便利商店", "萊爾富", "OK超商", 
            "全聯福利中心", "家樂福", "大潤發", "好市多", 
            "屈臣氏", "康是美", "寶雅", "蝦皮購物", 
            "麥當勞", "肯德基", "摩斯漢堡", "星巴克", 
            "路易莎", "50嵐", "清心福全", "台灣中油"
        ];

        // --- NEW: Local Keyword Mapping for Auto-Categorization ---
        const CATEGORY_KEYWORDS = {
            '早餐': ['蛋餅', '吐司', '漢堡', '豆漿', '奶茶', '飯糰', '早餐', '美而美', '三明治'],
            '午餐': ['便當', '自助餐', '午餐', '飯', '麵', '水餃', '丼', '粥'],
            '晚餐': ['晚餐', '火鍋', '壽司', '牛排', '鐵板燒', '熱炒', '麥當勞', '肯德基', '必勝客', '餐廳'],
            '飲料': ['咖啡', '茶', '星巴克', '拿鐵', '飲料', '手搖', '50嵐', '可不可', '烏弄', '麻古'],
            '點心': ['蛋糕', '甜點', '冰', '餅乾', '糖果', '雞排', '滷味', '零食'],
            '食材': ['全聯', '家樂福', '大潤發', '菜市場', '肉', '菜', '蛋', '水果', '好市多'],
            '交通': ['捷運', '公車', '台鐵', '高鐵', 'Uber', '計程車', '車票', '悠遊卡', 'eTag', '過路費'],
            '加油': ['加油', '中油', '全國', '台塑', '95', '92'],
            '停車': ['停車', '停車場'],
            '日用': ['衛生紙', '洗髮', '沐浴', '牙膏', '洗衣', '全聯', '屈臣氏', '康是美', '寶雅', '小北'],
            '娛樂': ['電影', 'Netflix', 'Spotify', 'Youtube', 'Steam', '遊戲', '門票', '好樂迪', '錢櫃', 'KTV'],
            '醫療': ['診所', '掛號', '藥', '醫生', '醫院', '牙醫'],
            '房租': ['房租', '租金'],
            '水電': ['電費', '水費', '瓦斯'],
            '網路': ['網路', '寬頻', '光纖'],
            '話費': ['電話費', '手機費', '中華電信', '遠傳', '台哥大']
        };

        const state = {
            db: null, geminiKey: localStorage.getItem('acc_gemini_key') || 'AIzaSyA2WZwhP-dG_37EEW9MDrlUQ_TG-d1TAdY', scriptUrl: localStorage.getItem('acc_script_url') || 'https://script.google.com/macros/s/AKfycbwNIaGFsgcePv5Sp3jLNZHYMGPDxroDjAez_K2r0L5WihkcC2waA6J5-LwBLjg1gz7Img/exec',
            userName: localStorage.getItem('acc_username') || '', ledgers: [], currentLedger: null, transactions: [], allTransactionsCache: [], usersList: [], unsubscribeTrans: null, unsubscribeLedgers: null, isOnline: false, currentImage: null, lastQrData: null, rates: { TWD: 1, JPY: 0.22, USD: 31.5, KRW: 0.024, EUR: 34.5, CNY: 4.4 }, unlockedLedgers: [], pendingLedgerId: null, categories: JSON.parse(localStorage.getItem('acc_custom_categories')) || DEFAULT_CATEGORIES,
            merchants: JSON.parse(localStorage.getItem('acc_custom_merchants')) || DEFAULT_MERCHANTS,
            filterDay: null,
            customAiPrompt: localStorage.getItem('acc_ai_prompt') || '',
            assets: [], 
            unsubscribeAssets: null,
            chartMode: 'weekly', // weekly, monthly, quarterly, yearly
            chartFilters: {
                selectedYear: new Date().getFullYear(),
                compareYear: new Date().getFullYear() - 1, // For YoY
                selectedYears: [new Date().getFullYear()] // For Yearly mode
            },
            currentChartStats: {},
            currentListData: [], // New: stores currently filtered transactions for export
            importFile: null, // For Excel Import
            recurringRules: [],
            unsubscribeRecurring: null,
            pwAttempts: 0 // New: Track password attempts
        };

        const app = {
            init: async () => {
                const k = localStorage.getItem('acc_gemini_key');
                if (k && k.endsWith('SW8o')) { localStorage.setItem('acc_gemini_key', 'AIzaSyA2WZwhP-dG_37EEW9MDrlUQ_TG-d1TAdY'); state.geminiKey = 'AIzaSyA2WZwhP-dG_37EEW9MDrlUQ_TG-d1TAdY'; }
                document.getElementById('geminiKeyInput').value = state.geminiKey; document.getElementById('scriptUrlInput').value = state.scriptUrl; document.getElementById('firebaseConfigInput').value = JSON.stringify(FIREBASE_CONFIG, null, 2);
                document.getElementById('aiPromptInput').value = state.customAiPrompt; 
                app.fetchRates(); await app.connectFirebase(FIREBASE_CONFIG); await app.loadGlobalSettings();
                document.getElementById('tDate').valueAsDate = new Date();
                
                const yr = new Date().getFullYear(); 
                const ySel = document.getElementById('ledgerYear');
                
                // 年度選單升級：加入「全部年度」與「近三年」
                let opts = '<option value="all">全部年度</option><option value="last3">近三年</option>';
                for (let i = yr; i >= yr - 5; i--) opts += `<option value="${i}">${i}年</option>`;
                ySel.innerHTML = opts;
                ySel.value = yr; // 預設選中今年
                
                document.getElementById('ledgerMonth').value = (new Date().getMonth() + 1).toString().padStart(2, '0');
                
                // 個人中心統計年份維持單純年份選擇，避免邏輯衝突
                let statOpts = '';
                for (let i = yr; i >= yr - 5; i--) statOpts += `<option value="${i}">${i}年</option>`;
                document.getElementById('statYear').innerHTML = statOpts;

                document.getElementById('statMonth').value = document.getElementById('ledgerMonth').value;

                if (!state.userName) { 
                    await app.loadUsersList(); 
                    document.getElementById('loginModal').classList.remove('hidden'); 
                } else { 
                    document.getElementById('sidebarUserName').innerText = state.userName; 
                    document.getElementById('renameInput').value = state.userName; 
                    app.listenLedgers(); 
                    app.listenAssets();
                    // Always ensure user list is loaded for group ledger creation
                    app.loadUsersList();
                }
            },
            loadUsersList: async () => { try { const q = query(collection(state.db, "users")); const s = await getDocs(q); state.usersList = []; const sl = document.getElementById('loginUserSelect'); sl.innerHTML = '<option value="">請選擇角色...</option>'; s.forEach(d => { state.usersList.push(d.id); sl.innerHTML += `<option value="${d.id}">${d.id}</option>`; }); if (state.usersList.length === 0) document.getElementById('existingUserSection').classList.add('hidden'); } catch (e) { console.error("Login List Error", e); } },
            
            // --- UPDATED LOGIN LOGIC ---
            loginExistingUser: async () => { 
                const n = document.getElementById('loginUserSelect').value;
                const p = document.getElementById('loginPasswordInput').value.trim();
                
                if (!n) return alert("請選擇一個角色");
                
                try {
                    const userDoc = await getDoc(doc(state.db, "users", n));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        // If user has a password set, verify it
                        if (userData.password && userData.password !== p) {
                            return alert("密碼錯誤！");
                        }
                        // If no password set (legacy user), allow login but maybe warn
                        if (!userData.password && p) {
                            // Optional: Could auto-set password here, but better let them do it in settings
                        }
                        app.performLogin(n);
                    } else {
                        alert("用户不存在");
                    }
                } catch (e) {
                    console.error(e);
                    alert("登入失敗: " + e.message);
                }
            },
            registerNewUser: async () => { 
                const n = document.getElementById('newUserNameInput').value.trim();
                const p = document.getElementById('newUserNamePassword').value.trim();
                
                if (!n) return alert("請輸入名稱");
                if (!p) return alert("請設定登入密碼");
                
                try { 
                    const d = doc(state.db, "users", n); 
                    if ((await getDoc(d)).exists()) return alert("此名稱已存在"); 
                    await setDoc(d, { 
                        createdAt: new Date().toISOString(),
                        password: p 
                    }); 
                    app.performLogin(n); 
                } catch(e) { 
                    alert("註冊失敗: " + e.message); 
                } 
            },
            performLogin: (n) => { state.userName = n; localStorage.setItem('acc_username', n); document.getElementById('sidebarUserName').innerText = n; document.getElementById('renameInput').value = n; document.getElementById('loginModal').classList.add('hidden'); app.listenLedgers(); app.listenAssets(); },
            
            changeUserPassword: async () => {
                const newPw = prompt("請輸入新密碼:");
                if (newPw) {
                    try {
                        await updateDoc(doc(state.db, "users", state.userName), { password: newPw });
                        alert("密碼修改成功！下次登入請使用新密碼。");
                    } catch (e) {
                        alert("修改失敗: " + e.message);
                    }
                }
            },

            renameUser: async () => { const n = document.getElementById('renameInput').value.trim(), o = state.userName, b = document.getElementById('renameBtn'); if (!n || n === o) return; if (!confirm(`確定要改名為 "${n}"？`)) return; b.disabled = true; b.innerText = '更新中...'; try { const bat = writeBatch(state.db); 
                // Copy user data including password
                const oldUserDoc = await getDoc(doc(state.db, "users", o));
                const oldUserData = oldUserDoc.exists() ? oldUserDoc.data() : { createdAt: new Date().toISOString() };
                
                bat.set(doc(state.db, "users", n), oldUserData); 
                
                (await getDocs(query(collection(state.db, "ledgers"), where("members", "array-contains", o)))).forEach(d => { const m = d.data().members.map(x => x === o ? n : x); bat.update(d.ref, { members: m, ...(d.data().createdBy === o && { createdBy: n }) }); }); (await getDocs(query(collection(state.db, "transactions"), where("paidBy", "==", o)))).forEach(d => bat.update(d.ref, { paidBy: n })); (await getDocs(query(collection(state.db, "transactions"), where("lastEditedBy", "==", o)))).forEach(d => bat.update(d.ref, { lastEditedBy: n })); bat.delete(doc(state.db, "users", o)); await bat.commit(); alert("更名成功"); app.performLogin(n); location.reload(); } catch (e) { alert("更名失敗:" + e.message); b.disabled = false; b.innerText = '確認'; } },
            
            // --- NEW: Ledger Management Functions ---
            editLedger: async (id, oldName) => {
                const newName = prompt("請輸入新的帳本名稱：", oldName);
                if (newName && newName.trim() !== "" && newName !== oldName) {
                    try {
                        await updateDoc(doc(state.db, "ledgers", id), { name: newName.trim() });
                        // UI updates via snapshot listener automatically
                    } catch (e) {
                        alert("修改失敗: " + e.message);
                    }
                }
            },
            
            unarchiveLedger: async (id, name) => {
                if(!confirm(`確定要取消「${name}」的結算狀態並還原為一般帳本嗎？`)) return;
                try {
                    await updateDoc(doc(state.db, "ledgers", id), { status: 'active' });
                    alert("帳本已還原");
                    if (state.currentLedger?.id === id) {
                        // Refresh view state if needed, though listener handles list
                        document.getElementById('addTxBtn').classList.remove('hidden');
                        document.getElementById('ledgerStatusBadge').classList.add('hidden');
                    }
                } catch (e) {
                    alert("還原失敗: " + e.message);
                }
            },

            deleteLedger: async (id, name) => {
                // Confirmation 1
                if (!confirm(`確定要刪除帳本「${name}」嗎？`)) return;
                
                // Confirmation 2 (Double Check)
                if (!confirm(`⚠️ 警告：此動作無法復原！\n\n帳本「${name}」及其所有交易紀錄、固定收支設定都將被永久刪除。\n\n請再次確認是否執行刪除？`)) return;

                try {
                    // 1. Delete transactions
                    const q = query(collection(state.db, "transactions"), where("ledgerId", "==", id));
                    const snapshot = await getDocs(q);
                    
                    // Batch delete (chunking just in case, though 500 is limit)
                    const chunks = [];
                    let batch = writeBatch(state.db);
                    let count = 0;
                    
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                        count++;
                        if (count >= 400) {
                            chunks.push(batch.commit());
                            batch = writeBatch(state.db);
                            count = 0;
                        }
                    });
                    if (count > 0) chunks.push(batch.commit());
                    await Promise.all(chunks);

                    // 2. Delete recurring rules
                    const qRules = query(collection(state.db, "recurring_rules"), where("ledgerId", "==", id));
                    const snapRules = await getDocs(qRules);
                    const batchRules = writeBatch(state.db);
                    snapRules.forEach(d => batchRules.delete(d.ref));
                    await batchRules.commit();

                    // 3. Delete ledger document
                    await deleteDoc(doc(state.db, "ledgers", id));

                    alert("帳本已成功刪除");
                    
                    // Switch to another ledger if current was deleted
                    if (state.currentLedger && state.currentLedger.id === id) {
                        const next = state.ledgers.find(l => l.id !== id);
                        if (next) ui.switchLedger(next.id);
                        else location.reload(); 
                    }

                } catch (e) {
                    console.error(e);
                    alert("刪除失敗: " + e.message);
                }
            },

            // --- AUTO CATEGORIZE LOGIC ---
            detectCategory: (name) => {
                if (!name) return null;
                for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
                    if (keywords.some(k => name.includes(k))) {
                        return category;
                    }
                }
                return null;
            },

            autoCategorize: (input) => {
                const row = input.parentElement.parentElement;
                const name = input.value.trim();
                const catSelect = row.querySelector('.item-cat');
                
                // Only auto-categorize for Expense type, or if we expand logic for income later
                if (document.getElementById('tType').value !== 'expense') return;

                const detected = app.detectCategory(name);
                
                if (detected) {
                    // Check if the detected category exists in the current select options
                    const options = Array.from(catSelect.options).map(o => o.value);
                    if (options.includes(detected)) {
                        catSelect.value = detected;
                        // Add a subtle visual cue (optional)
                        catSelect.classList.add('bg-blue-50');
                        setTimeout(() => catSelect.classList.remove('bg-blue-50'), 500);
                    }
                }
            },

            // --- RECURRING RULES LOGIC ---
            listenRecurringRules: () => {
                if(!state.currentLedger) return;
                if(state.unsubscribeRecurring) state.unsubscribeRecurring();
                
                const q = query(collection(state.db, "recurring_rules"), where("ledgerId", "==", state.currentLedger.id));
                state.unsubscribeRecurring = onSnapshot(q, (snapshot) => {
                    state.recurringRules = [];
                    snapshot.forEach(doc => state.recurringRules.push({ id: doc.id, ...doc.data() }));
                    ui.renderRecurringList();
                });
            },

            saveRecurringRule: async (e) => {
                e.preventDefault();
                const id = document.getElementById('recRuleId').value;
                const type = document.getElementById('recType').value;
                const freq = document.getElementById('recFreq').value;
                const name = document.getElementById('recName').value.trim();
                const amount = parseFloat(document.getElementById('recAmount').value);
                const category = document.getElementById('recCategory').value;
                const nextDate = document.getElementById('recNextDate').value;

                if (!name || !amount || !nextDate) return alert("請填寫完整資訊");

                const ruleData = {
                    ledgerId: state.currentLedger.id,
                    type,
                    frequency: freq,
                    name,
                    amount,
                    category,
                    nextDueDate: nextDate,
                    currency: 'TWD', // Default simple for now
                    updatedAt: new Date().toISOString()
                };

                try {
                    if (id) {
                        await updateDoc(doc(state.db, "recurring_rules", id), ruleData);
                    } else {
                        await addDoc(collection(state.db, "recurring_rules"), {
                            ...ruleData,
                            createdAt: new Date().toISOString()
                        });
                    }
                    ui.toggleRecurringForm(false);
                } catch(err) {
                    alert("儲存失敗: " + err.message);
                }
            },

            deleteRecurringRule: async (id) => {
                if(confirm("確定刪除此固定收支規則？")) {
                    await deleteDoc(doc(state.db, "recurring_rules", id));
                }
            },

            executeRecurring: async (ruleId) => {
                const rule = state.recurringRules.find(r => r.id === ruleId);
                if(!rule) return;

                if(!confirm(`確認將「${rule.name}」($${rule.amount}) 加入今日帳本？`)) return;

                const batch = writeBatch(state.db);
                const txRef = doc(collection(state.db, "transactions"));
                batch.set(txRef, {
                    ledgerId: state.currentLedger.id,
                    type: rule.type,
                    date: rule.nextDueDate, 
                    amount: rule.amount,
                    originalAmount: rule.amount,
                    currency: 'TWD',
                    exchangeRate: 1,
                    paidBy: state.userName,
                    name: rule.name,
                    category: rule.category,
                    merchant: '',
                    groupId: Date.now().toString(),
                    createdAt: new Date().toISOString(),
                    lastEditedBy: state.userName,
                    lastEditedAt: new Date().toISOString()
                });

                const currentDue = new Date(rule.nextDueDate);
                let nextDue = new Date(currentDue);
                if(rule.frequency === 'monthly') {
                    nextDue.setMonth(nextDue.getMonth() + 1);
                } else if (rule.frequency === 'yearly') {
                    nextDue.setFullYear(nextDue.getFullYear() + 1);
                }
                
                batch.update(doc(state.db, "recurring_rules", ruleId), {
                    nextDueDate: nextDue.toISOString().split('T')[0]
                });

                await batch.commit();
                alert("已成功記帳，並更新下次到期日！");
            },

            // --- EXCEL IMPORT LOGIC ---
            downloadTemplate: () => {
                const headers = [['日期 (YYYY-MM-DD)', '收支類型 (支出/收入)', '類別', '項目名稱', '金額', '商店/對象 (選填)', '幣別 (選填)', '備註 (選填)']];
                const example = [['2024-02-01', '支出', '飲食', '午餐便當', 120, '7-11', 'TWD', '公司聚餐']];
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([...headers, ...example]);
                ws['!cols'] = [{wch:15}, {wch:15}, {wch:10}, {wch:20}, {wch:10}, {wch:15}, {wch:10}, {wch:20}];
                XLSX.utils.book_append_sheet(wb, ws, "匯入範本");
                XLSX.writeFile(wb, "記帳本匯入範本.xlsx");
            },

            handleFileSelect: (input) => {
                const file = input.files[0];
                if (!file) return;
                document.getElementById('importFileName').innerText = file.name;
                document.getElementById('importFileDisplay').classList.remove('hidden');
                document.getElementById('importPlaceholder').classList.add('hidden');
                state.importFile = file;
            },

            processImport: async () => {
                if (!state.importFile) return alert("請先選擇檔案");
                if (!state.currentLedger) return alert("請先選擇要匯入的帳本");

                const btn = document.getElementById('btnStartImport');
                btn.disabled = true;
                btn.innerText = "處理中...";

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                        if (jsonData.length < 2) throw new Error("檔案內容為空或格式錯誤");

                        const rows = jsonData.slice(1);
                        const batch = writeBatch(state.db);
                        let count = 0;
                        const groupIdBase = Date.now().toString();

                        rows.forEach((row, index) => {
                            if (!row[0] || !row[4]) return;
                            const getVal = (idx) => row[idx] ? String(row[idx]).trim() : '';
                            let dateStr = '';
                            if (row[0] instanceof Date) {
                                dateStr = row[0].toISOString().split('T')[0];
                            } else {
                                const d = new Date(row[0]);
                                if (!isNaN(d.getTime())) {
                                    dateStr = d.toISOString().split('T')[0];
                                } else {
                                    dateStr = new Date().toISOString().split('T')[0];
                                }
                            }

                            const type = getVal(1).includes('收') ? 'income' : 'expense';
                            const category = getVal(2) || '其他';
                            const name = getVal(3) || '未命名項目';
                            const amount = parseFloat(row[4]);
                            const merchant = getVal(5);
                            const currency = getVal(6) || state.currentLedger.defaultCurrency || 'TWD';
                            const note = getVal(7);
                            const finalName = note ? `${name} (${note})` : name;

                            const docRef = doc(collection(state.db, "transactions"));
                            const txData = {
                                ledgerId: state.currentLedger.id,
                                type: type,
                                date: dateStr,
                                amount: amount,
                                originalAmount: amount,
                                currency: currency,
                                exchangeRate: 1,
                                paidBy: state.userName,
                                name: finalName,
                                category: category,
                                merchant: merchant,
                                groupId: groupIdBase + index,
                                createdAt: new Date().toISOString(),
                                lastEditedBy: state.userName,
                                lastEditedAt: new Date().toISOString()
                            };
                            batch.set(docRef, txData);
                            count++;
                        });

                        if (count > 0) {
                            await batch.commit();
                            alert(`成功匯入 ${count} 筆資料！`);
                            ui.closeModal('importModal');
                            document.getElementById('importFile').value = '';
                            document.getElementById('importFileName').innerText = '';
                            document.getElementById('importFileDisplay').classList.add('hidden');
                            document.getElementById('importPlaceholder').classList.remove('hidden');
                            state.importFile = null;
                        } else {
                            alert("沒有讀取到有效資料，請檢查格式");
                        }

                    } catch (err) {
                        console.error(err);
                        alert("匯入失敗: " + err.message);
                    } finally {
                        btn.disabled = false;
                        btn.innerText = "開始匯入";
                    }
                };
                reader.readAsArrayBuffer(state.importFile);
            },
            
            // --- CHART LOGIC ---
            setChartMode: (mode) => {
                state.chartMode = mode;
                document.querySelectorAll('.chart-mode-btn').forEach(b => {
                    b.classList.toggle('active', b.id === `mode-${mode}`);
                    b.classList.toggle('bg-gray-200', b.id !== `mode-${mode}`);
                    b.classList.toggle('text-gray-600', b.id !== `mode-${mode}`);
                });
                app.renderChartControls();
                app.updateLedgerView(); 
            },

            renderChartControls: () => {
                const container = document.getElementById('chartControls');
                container.innerHTML = '';
                const currentYear = new Date().getFullYear();

                if (state.chartMode === 'monthly') {
                    container.innerHTML = `
                        <select onchange="state.chartFilters.selectedYear=parseInt(this.value); app.updateLedgerView()" class="p-1 rounded border text-xs">
                            ${Array.from({length: 6}, (_, i) => currentYear - i).map(y => `<option value="${y}" ${y===state.chartFilters.selectedYear?'selected':''}>${y}</option>`).join('')}
                        </select>
                        <span class="text-gray-400">vs</span>
                        <select onchange="state.chartFilters.compareYear=parseInt(this.value); app.updateLedgerView()" class="p-1 rounded border text-xs">
                            <option value="">無</option>
                            ${Array.from({length: 6}, (_, i) => currentYear - i).map(y => `<option value="${y}" ${y===state.chartFilters.compareYear?'selected':''}>${y}</option>`).join('')}
                        </select>
                    `;
                } else if (state.chartMode === 'quarterly') {
                    container.innerHTML = `
                        <select onchange="state.chartFilters.selectedYear=parseInt(this.value); app.updateLedgerView()" class="p-1 rounded border text-xs">
                            ${Array.from({length: 6}, (_, i) => currentYear - i).map(y => `<option value="${y}" ${y===state.chartFilters.selectedYear?'selected':''}>${y}</option>`).join('')}
                        </select>
                    `;
                } else if (state.chartMode === 'yearly') {
                    container.innerHTML = `<span class="text-gray-400">近 5 年</span>`;
                }
            },

            updateLedgerView: () => {
                if (!state.currentLedger) return;
                
                let listData = [];
                
                if (state.filterMode === 'range') {
                      const start = document.getElementById('filterStartDate').value;
                      const end = document.getElementById('filterEndDate').value;
                      if (start && end) {
                          listData = state.transactions.filter(t => t.date >= start && t.date <= end);
                      } else {
                          listData = state.transactions; 
                      }
                } else {
                    const y = document.getElementById('ledgerYear').value;
                    const m = document.getElementById('ledgerMonth').value;
                    const mSel = document.getElementById('ledgerMonth');

                    // 智慧月份連動：若是大範圍統計，鎖定月份選單
                    if (y === 'all' || y === 'last3') {
                        mSel.disabled = true;
                        mSel.classList.add('text-gray-400', 'cursor-not-allowed');
                    } else {
                        mSel.disabled = false;
                        mSel.classList.remove('text-gray-400', 'cursor-not-allowed');
                    }
                    
                    listData = state.transactions.filter(t => { 
                        // 1. 全部年度
                        if (y === 'all') return true;
                        
                        const d = new Date(t.date);
                        
                        // 2. 近三年
                        if (y === 'last3') {
                            const currentYear = new Date().getFullYear();
                            return d.getFullYear() >= currentYear - 2;
                        }

                        // 3. 單一年度 + 月份篩選
                        return d.getFullYear().toString() === y && (m === 'all' || (d.getMonth() + 1).toString().padStart(2, '0') === m); 
                    });
                }

                // Update Top Stats
                ui.renderTopStats(listData);

                // Save list data for Export
                state.currentListData = listData;

                // Render List
                let inc = 0, exp = 0;
                listData.forEach(t => { if (t.type === 'expense') exp += t.amount; else inc += t.amount; });
                
                document.getElementById('totalIncome').innerText = '$' + Math.round(inc).toLocaleString(); 
                document.getElementById('totalExpense').innerText = '$' + Math.round(exp).toLocaleString(); 
                document.getElementById('totalBalance').innerText = '$' + Math.round(inc - exp).toLocaleString();
                ui.renderTransactionListHTML(listData);
            },
            
            filterByDay: (day) => { state.filterDay = state.filterDay === day ? null : day; app.updateLedgerView(); },
            filterByMonth: (m, y) => { 
                document.getElementById('ledgerYear').value = y;
                document.getElementById('ledgerMonth').value = m.toString().padStart(2, '0');
                app.setChartMode('weekly'); 
            },
            filterByQuarter: (q) => {
                document.getElementById('ledgerYear').value = state.chartFilters.selectedYear;
                document.getElementById('ledgerMonth').value = 'all'; 
                app.updateLedgerView();
                alert(`已切換至 ${state.chartFilters.selectedYear} 年，交易紀錄顯示全年 (進階季度篩選開發中)`);
            },
            filterByYear: (y) => {
                document.getElementById('ledgerYear').value = y;
                document.getElementById('ledgerMonth').value = 'all';
                app.setChartMode('weekly'); 
            },
            clearDateFilter: () => { state.filterDay = null; app.updateLedgerView(); },
            
            // --- EXPORT FUNCTIONS ---
            exportToExcel: () => { if (!state.allTransactionsCache.length) return alert("無資料"); const y = document.getElementById('statYear').value, m = document.getElementById('statMonth').value, d = state.allTransactionsCache.map(t => ({ 日期: t.date, 帳本: t.ledgerName, 類型: t.type, 金額: t.amount, 項目: t.name, 分類: t.category, 商店: t.merchant || '' })); const w = XLSX.utils.json_to_sheet(d), b = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(b, w, "Data"); XLSX.writeFile(b, `帳本_${y}_${m}.xlsx`); },
            
            exportTrendReport: () => {
                const stats = state.currentChartStats;
                const rows = [];
                Object.keys(stats).forEach(key => {
                    const s = stats[key];
                    rows.push({
                        '時間區段': s.label, 
                        '總收入': s.income,
                        '總支出': s.expense,
                        '淨利': s.income - s.expense
                    });
                });
                
                if (rows.length === 0) return alert("目前圖表無資料可匯出");
                
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Income_Expense_Report");
                XLSX.writeFile(wb, `收支報表_${state.chartMode}_${new Date().toISOString().slice(0,10)}.xlsx`);
            },

            exportCurrentList: () => {
                const list = state.currentListData;
                if (list.length === 0) return alert("目前列表無資料可匯出");
                
                const exportData = list.map(t => ({
                    '日期': t.date,
                    '商店/對象': t.merchant || '',
                    '項目名稱': t.name,
                    '類別': t.category,
                    '類型': t.type === 'expense' ? '支出' : '收入',
                    '金額': t.amount,
                    '幣別': t.currency,
                    '付款人': t.paidBy || '',
                    '備註': ''
                }));

                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Transactions");
                XLSX.writeFile(wb, `交易明細清單_${new Date().toISOString().slice(0,10)}.xlsx`);
            },

            askAI: async () => { const i = document.getElementById('aiChatInput'), h = document.getElementById('aiChatHistory'), b = document.getElementById('btnAiSend'), q = i.value.trim(); if (!q || !state.geminiKey) return; h.innerHTML += `<div class="bg-indigo-100 p-2 rounded-lg ml-auto w-fit mb-2 text-sm text-indigo-900">${q}</div>`; b.disabled = true; i.value = ''; try { const p = `Role: Financial Assistant. Context JSON: ${JSON.stringify(state.allTransactionsCache.slice(0, 50).map(t => ({ d: t.date, a: t.amount, c: t.category, i: t.name })))}. Question: "${q}". Answer in Traditional Chinese, concise.`; const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.geminiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: p }] }] }) }); const d = await r.json(); h.innerHTML += `<div class="bg-white border p-2 rounded-lg w-fit mb-2 text-sm text-gray-700">${marked.parse(d.candidates[0].content.parts[0].text)}</div>`; } catch (e) { h.innerHTML += `<div class="text-red-500 text-xs">Error</div>`; } b.disabled = false; h.scrollTop = h.scrollHeight; },
            
            deleteSelected: async () => {
                const checked = document.querySelectorAll('.tx-checkbox:checked');
                if(checked.length === 0) return;
                if(!confirm(`確定要刪除選取的 ${checked.length} 筆/組交易紀錄嗎？`)) return;
                const btn = document.getElementById('bulkDeleteBtn'); btn.disabled = true; btn.innerHTML = '<div class="loader w-3 h-3 border-red-200 border-t-red-600 mr-2"></div> 刪除中...';
                try { const batch = writeBatch(state.db); checked.forEach(cb => { cb.getAttribute('data-ids').split(',').forEach(id => batch.delete(doc(state.db, "transactions", id))); }); await batch.commit(); document.getElementById('selectAllTx').checked = false; ui.updateBulkActionState(); } catch (e) { alert("刪除失敗"); console.error(e); } finally { btn.disabled = false; btn.innerHTML = `<i class="fa-solid fa-trash-can"></i> <span class="hidden md:inline">刪除選取</span> (<span id="selectedCount">0</span>)`; }
            },

            archiveLedger: async () => { if(!state.currentLedger) return; const p=document.getElementById('targetPersonalLedger').value; if(!p)return alert("選帳本"); const a=parseInt(document.getElementById('settleShareAmount').innerText.replace(/,/g,''))||0; const b=writeBatch(state.db); b.update(doc(state.db,"ledgers",state.currentLedger.id),{status:'archived'}); if(a>0) b.set(doc(collection(state.db,"transactions")),{ledgerId:p,type:'expense',date:new Date().toISOString().split('T')[0],amount:a,originalAmount:a,currency:'TWD',exchangeRate:1,name:`${state.currentLedger.name}(分帳)`,category:'娛樂',createdAt:new Date().toISOString(),lastEditedBy:state.userName}); await b.commit(); alert("歸檔成功"); ui.closeModal('settleModal'); },
            fetchRates: async()=>{try{const r=await fetch('https://api.exchangerate-api.com/v4/latest/TWD');const d=await r.json();if(d.rates)state.rates={TWD:1,JPY:1/d.rates.JPY,USD:1/d.rates.USD,KRW:1/d.rates.KRW,EUR:1/d.rates.EUR,CNY:1/d.rates.CNY};}catch{}},
            connectFirebase: async(c)=>{try{const a=initializeApp(c);state.db=getFirestore(a);try{await enableIndexedDbPersistence(state.db)}catch{}state.isOnline=true;}catch(e){console.error(e);alert("連線失敗: "+e.message)}},
            loadGlobalSettings: async()=>{if(!state.db)return;try{const d=await getDoc(doc(state.db,"settings","global"));if(d.exists()&&d.data().gemini_api_key){state.geminiKey=d.data().gemini_api_key;document.getElementById('geminiKeyInput').value=state.geminiKey;document.getElementById('apiKeyLabel').innerHTML+='(雲端)';}}catch{}},
            saveSettings: async()=>{const k=document.getElementById('geminiKeyInput').value.trim(),s=document.getElementById('scriptUrlInput').value.trim(),p=document.getElementById('aiPromptInput').value.trim();if(!k)return alert("API Key Empty");try{localStorage.setItem('acc_script_url',s);localStorage.setItem('acc_ai_prompt', p);state.customAiPrompt = p;await setDoc(doc(state.db,"settings","global"),{gemini_api_key:k,updatedAt:new Date().toISOString(),updatedBy:state.userName},{merge:true});localStorage.setItem('acc_gemini_key',k);alert("設定已儲存！");location.reload();}catch{alert("Err");}},
            setLedgerPassword: async() => { const p = prompt("請輸入新密碼 (空白則為無密碼):"); if(p !== null) { await updateDoc(doc(state.db, "ledgers", state.currentLedger.id), { password: p }); alert("密碼已更新"); } },
            removeLedgerPassword: async()=>{if(!confirm("確定要移除密碼保護嗎?"))return;await updateDoc(doc(state.db,"ledgers",state.currentLedger.id),{password:""});alert("已移除");ui.closeModal('settingsModal');},
            addCategory: ()=>{const t=document.getElementById('newCatType').value,n=document.getElementById('newCatName').value.trim();if(!n)return;state.categories[t].push(n);app.saveCategories();ui.renderSettings();},
            removeCategory: (t,n)=>{if(confirm("Del?")){state.categories[t]=state.categories[t].filter(c=>c!==n);app.saveCategories();ui.renderSettings();}},
            
            // --- NEW: Merchant Management ---
            addMerchant: () => {
                const n = document.getElementById('newMerchantName').value.trim();
                if (!n) return;
                if (!state.merchants.includes(n)) {
                    state.merchants.push(n);
                    app.saveMerchants();
                    ui.renderSettings();
                }
                document.getElementById('newMerchantName').value = '';
            },
            removeMerchant: (n) => {
                if (confirm(`確定要刪除「${n}」嗎？`)) {
                    state.merchants = state.merchants.filter(m => m !== n);
                    app.saveMerchants();
                    ui.renderSettings();
                }
            },
            saveMerchants: () => localStorage.setItem('acc_custom_merchants', JSON.stringify(state.merchants)),

            saveCategories: ()=>localStorage.setItem('acc_custom_categories',JSON.stringify(state.categories)),
            listenLedgers: ()=>{if(state.unsubscribeLedgers)state.unsubscribeLedgers();state.unsubscribeLedgers=onSnapshot(query(collection(state.db,"ledgers")),s=>{state.ledgers=[];s.forEach(d=>state.ledgers.push({id:d.id,...d.data()}));state.ledgers=state.ledgers.filter(l=>l.type==='personal'?l.createdBy===state.userName:l.members&&l.members.includes(state.userName)).sort((a,b)=>(a.status==='archived'?1:0)-(b.status==='archived'?1:0));if(!state.currentLedger&&state.ledgers.length>0)ui.switchLedger(localStorage.getItem('acc_current_ledger')||state.ledgers[0].id);ui.renderLedgerList();});},
            
            // Assets Functions
            listenAssets: () => {
                if(!state.userName) return;
                if(state.unsubscribeAssets) state.unsubscribeAssets();
                const q = query(collection(state.db, "user_assets"), where("userId", "==", state.userName));
                state.unsubscribeAssets = onSnapshot(q, (snapshot) => {
                    state.assets = [];
                    snapshot.forEach(doc => state.assets.push({ id: doc.id, ...doc.data() }));
                    ui.renderAssets();
                    ui.renderAssetOptions(); // Update datalist
                });
            },
            saveAsset: async () => {
                const name = document.getElementById('assetNameInput').value.trim();
                const balance = parseFloat(document.getElementById('assetBalanceInput').value);
                if (!name || isNaN(balance)) return alert("請輸入完整資訊");

                const existing = state.assets.find(a => a.name === name);
                const historyEntry = { date: new Date().toISOString(), balance: balance };

                try {
                    if (existing) {
                        const newHistory = [...(existing.history || []), historyEntry];
                        await updateDoc(doc(state.db, "user_assets", existing.id), {
                            currentBalance: balance,
                            updatedAt: new Date().toISOString(),
                            history: newHistory
                        });
                    } else {
                        await addDoc(collection(state.db, "user_assets"), {
                            userId: state.userName,
                            name: name,
                            currentBalance: balance,
                            updatedAt: new Date().toISOString(),
                            history: [historyEntry]
                        });
                    }
                    document.getElementById('assetNameInput').value = '';
                    document.getElementById('assetBalanceInput').value = '';
                    alert("資產已更新");
                } catch (e) {
                    console.error(e);
                    alert("更新失敗");
                }
            },
            deleteAsset: async (id) => {
                if(confirm("確定刪除此資產紀錄？")) {
                    await deleteDoc(doc(state.db, "user_assets", id));
                }
            },
            editAsset: (name, balance) => {
                // Populate input fields
                document.getElementById('assetNameInput').value = name;
                document.getElementById('assetBalanceInput').value = balance;
                
                // Scroll to top of assets tab
                const contentAssets = document.getElementById('content-assets');
                contentAssets.scrollTop = 0;
                
                // Focus on balance to allow quick update
                document.getElementById('assetBalanceInput').focus();
            },

            createLedger: async()=>{
                const n=document.getElementById('newLedgerName').value.trim();
                const t=document.getElementById('newLedgerType').value;
                const c=document.getElementById('newLedgerCurrency').value;
                const p=document.getElementById('newLedgerPassword').value;
                
                if(!n)return alert("請輸入帳本名稱！");
                if(!state.userName)return alert("請先登入！");
                
                let mem=[];
                if(t==='group'){
                    // Get checked members
                    const checkboxes = document.querySelectorAll('.member-checkbox:checked');
                    mem = Array.from(checkboxes).map(cb => cb.value);
                    if(!mem.includes(state.userName)) mem.push(state.userName);
                }else{
                    mem=[state.userName];
                }
                
                try{
                    const r=await addDoc(collection(state.db,"ledgers"),{name:n,type:t,members:mem,defaultCurrency:c,password:p,createdBy:state.userName,status:'active',createdAt:new Date().toISOString()});
                    if(p)state.unlockedLedgers.push(r.id);
                    ui.closeModal('ledgerModal');
                    ui.switchLedger(r.id);
                    document.getElementById('newLedgerName').value='';
                    // Clear members selection
                    document.querySelectorAll('.member-checkbox').forEach(cb => cb.checked = false);
                    document.getElementById('newLedgerPassword').value='';
                }catch(e){
                    alert("建立失敗");
                    console.error(e);
                }
            },
            verifyPassword: ()=>{
                const i = document.getElementById('unlockPasswordInput').value;
                const l = state.ledgers.find(x => x.id === state.pendingLedgerId);
                
                if(l && i === l.password){
                    state.unlockedLedgers.push(l.id);
                    state.pwAttempts = 0; // reset
                    ui.closeModal('passwordModal');
                    ui.switchLedger(l.id);
                } else {
                    state.pwAttempts = (state.pwAttempts || 0) + 1;
                    if (state.pwAttempts >= 3) {
                        if (l.createdBy === state.userName) {
                            if(confirm("密碼輸入錯誤多次。您是此帳本的建立者，是否要重設密碼？")) {
                                const newPw = prompt("請輸入新密碼 (空白代表取消密碼保護):");
                                if (newPw !== null) {
                                    updateDoc(doc(state.db, "ledgers", l.id), { password: newPw });
                                    alert("密碼已更新，請重新嘗試解鎖");
                                    state.pwAttempts = 0;
                                }
                            }
                        } else {
                            alert("密碼錯誤 (錯誤次數過多，請聯繫帳本建立者)");
                        }
                    } else {
                        alert(`密碼錯誤 (剩餘嘗試次數: ${3 - state.pwAttempts})`);
                    }
                }
            },
            listenTransactions: () => { if (!state.currentLedger) return; if (state.unsubscribeTrans) state.unsubscribeTrans(); document.getElementById('loadingIndicator').classList.remove('hidden'); state.unsubscribeTrans = onSnapshot(query(collection(state.db, "transactions"), where("ledgerId", "==", state.currentLedger.id)), snap => { state.transactions = []; snap.forEach(d => state.transactions.push({ id: d.id, ...d.data() })); state.transactions.sort((a, b) => new Date(b.date) - new Date(a.date)); app.updateLedgerView(); document.getElementById('loadingIndicator').classList.add('hidden'); }); },
            addTransaction: async(e)=>{
                e.preventDefault();
                const b=document.getElementById('submitBtn');
                const originalText=b.innerText;
                b.disabled=true;
                b.innerHTML='<div class="loader w-4 h-4 border-white border-t-transparent inline-block mr-2"></div> 儲存中...';
                let u=document.getElementById('hiddenImageUrl').value;
                const merch=document.getElementById('tMerchant').value.trim();
                const groupId=Date.now().toString();
                
                try{
                    if(state.currentImage&&state.scriptUrl){
                        const r=await fetch(state.scriptUrl,{method:'POST',body:JSON.stringify({image:state.currentImage.base64,mimeType:state.currentImage.mimeType,filename:`rec_${Date.now()}.jpg`})});
                        const d=await r.json();
                        if(d.status==='success') {
                            u = d.url;
                            // --- NEW: Convert URL immediately if it's a Drive URL ---
                            u = app.getDirectDriveUrl(u);
                        }
                    }
                    const eid=document.getElementById('editingTxId').value;
                    const typ=document.getElementById('tType').value;
                    const dat=document.getElementById('tDate').value;
                    const isG=state.currentLedger.type==='group';
                    let cur='TWD',rate=1,pb='';
                    let splitAmong = []; // Array of user IDs

                    if(isG){
                        cur=document.getElementById('tCurrency').value;
                        rate=parseFloat(document.getElementById('tRate').value)||1;
                        pb=document.getElementById('tPaidBy').value;
                        
                        // Capture split selection
                        const checkboxes = document.querySelectorAll('.split-checkbox:checked');
                        splitAmong = Array.from(checkboxes).map(cb => cb.value);
                        if (splitAmong.length === 0) {
                            alert("請至少選擇一位分攤對象");
                            return; // Stop execution
                        }
                    }

                    const rows=document.querySelectorAll('.item-row'),bat=writeBatch(state.db);
                    
                    if(eid){
                        const r=rows[0];
                        if(r){
                            const n=r.querySelector('.item-name').value,c=r.querySelector('.item-cat').value;
                            const note = r.querySelector('.item-note').value; // Get note
                            let a=parseFloat(r.querySelector('.item-amount').value)||0,oa=a;
                            if(isG&&cur!=='TWD')a=Math.round(oa*rate);
                            const ot=state.transactions.find(t=>t.id===eid),h=ot.editHistory||[];
                            h.push({editor:state.userName,date:new Date().toISOString()});
                            bat.update(doc(state.db,"transactions",eid),{
                                ledgerId:state.currentLedger.id,
                                type:typ,
                                date:dat,
                                amount:a,
                                originalAmount:oa,
                                currency:cur,
                                exchangeRate:rate,
                                paidBy:pb,
                                splitAmong: splitAmong, // Save split info
                                name:n,
                                category:c,
                                imageUrl:u,
                                merchant:merch,
                                lastEditedBy:state.userName,
                                lastEditedAt:new Date().toISOString(),
                                editHistory:h,
                                note: note // Save note
                            });
                        }
                    } else {
                        rows.forEach(r=>{
                            const n=r.querySelector('.item-name').value.trim(),c=r.querySelector('.item-cat').value;
                            const note = r.querySelector('.item-note').value.trim(); // Get note
                            let a=parseFloat(r.querySelector('.item-amount').value)||0,oa=a;
                            if(!n&&a===0)return;
                            if(isG&&cur!=='TWD')a=Math.round(oa*rate);
                            bat.set(doc(collection(state.db,"transactions")),{
                                ledgerId:state.currentLedger.id,
                                type:typ,
                                date:dat,
                                amount:a,
                                originalAmount:oa,
                                currency:cur,
                                exchangeRate:rate,
                                paidBy:pb,
                                splitAmong: splitAmong, // Save split info
                                name:n,
                                category:c,
                                imageUrl:u,
                                merchant:merch,
                                groupId: groupId,
                                createdAt:new Date().toISOString(),
                                lastEditedBy:state.userName,
                                lastEditedAt:new Date().toISOString(),
                                note: note // Save note
                            });
                        });
                    }
                    await bat.commit();
                    ui.closeModal('transactionModal');
                    ai.clearImage();
                } catch(e) {
                    alert("儲存失敗: "+e.message);
                } finally {
                    b.disabled=false;
                    b.innerText=originalText;
                }
            },
            
            // --- NEW: Helper to Convert Drive URL ---
            getDirectDriveUrl: (url) => {
                if (!url) return '';
                try {
                    if (url.includes('drive.google.com')) {
                        let id = '';
                        if (url.includes('/file/d/')) {
                            id = url.split('/file/d/')[1].split('/')[0];
                        } else if (url.includes('id=')) {
                            id = url.split('id=')[1].split('&')[0];
                        }
                        // 修改：使用 thumbnail 介面來繞過瀏覽器的第三方 Cookie 阻擋
                        // sz=w1000 代表寬度最大 1000px，足夠清晰且載入快
                        if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
                    }
                } catch (e) { console.error('URL convert error', e); }
                return url;
            },

            editTransaction: (id)=>{
                const t=state.transactions.find(x=>x.id===id);
                if(!t)return;
                ui.openTransactionModal('編輯');
                document.getElementById('editingTxId').value=t.id;
                document.getElementById('tType').value=t.type;
                document.getElementById('tDate').value=t.date;
                document.getElementById('hiddenImageUrl').value=t.imageUrl||'';
                document.getElementById('tMerchant').value=t.merchant||'';
                document.getElementById('btnAddItem').classList.add('hidden');
                document.getElementById('uploadContainer').classList.add('hidden');
                if(state.currentLedger.type==='group'){
                    document.getElementById('tCurrency').value=t.currency||'TWD';
                    document.getElementById('tRate').value=t.exchangeRate||1;
                    document.getElementById('tPaidBy').value=t.paidBy||state.userName;
                    
                    // Set Split Selection
                    if (t.splitAmong) {
                        const allBoxes = document.querySelectorAll('.split-checkbox');
                        allBoxes.forEach(cb => cb.checked = t.splitAmong.includes(cb.value));
                    }
                    
                    app.updateRate(false);
                }
                document.getElementById('transactionItemsList').innerHTML='';
                ui.addItemRow(t.name,t.category,t.currency!=='TWD'?t.originalAmount:t.amount, t.note);
                ui.updateTotal();
            },
            deleteTransaction: async(id)=>{if(confirm("Del?"))await deleteDoc(doc(state.db,"transactions",id));},
            updateRate: (r=true)=>{
                const c=document.getElementById('tCurrency').value;
                if(r) document.getElementById('tRate').value=state.rates[c]?.toFixed(4)||1;
                // Update View Text
                const rateVal = document.getElementById('tRate').value;
                document.getElementById('currencyViewText').innerText = `${c} (匯率: ${rateVal})`;
                app.calcTwd();
            },
            calcTwd: ()=>ui.updateTotal(),
            
            // --- NEW: Improved Debt Calculation Logic ---
            calculateDebt: () => {
                if (!state.currentLedger || state.currentLedger.type !== 'group') return;
                
                const members = state.currentLedger.members;
                const balances = {}; // How much each person paid vs consumed
                const details = {};  // Detailed breakdown for report

                // Initialize
                members.forEach(m => {
                    balances[m] = 0;
                    details[m] = { paid: 0, share: 0 };
                });

                // Iterate ALL expenses
                state.transactions.forEach(t => {
                    if (t.type !== 'expense') return; // Income doesn't count for debt usually, or is shared differently. Assuming expense splitting here.
                    
                    const payer = t.paidBy;
                    const amount = t.amount;
                    // Backward compatibility: if splitAmong is missing, assume everyone
                    const beneficiaries = t.splitAmong && t.splitAmong.length > 0 ? t.splitAmong : members;

                    // 1. Credit the payer (they paid, so they are owed positive)
                    if (balances[payer] !== undefined) {
                        balances[payer] += amount;
                        details[payer].paid += amount;
                    }

                    // 2. Debit the beneficiaries (they consumed, so they owe negative)
                    const splitAmount = amount / beneficiaries.length;
                    beneficiaries.forEach(b => {
                        if (balances[b] !== undefined) {
                            balances[b] -= splitAmount;
                            details[b].share += splitAmount;
                        }
                    });
                });

                // Calculate Net Transfers
                const net = members.map(m => ({ name: m, amount: balances[m] }));
                const creditors = net.filter(n => n.amount > 1).sort((a, b) => b.amount - a.amount);
                const debtors = net.filter(n => n.amount < -1).sort((a, b) => a.amount - b.amount);

                // --- Generate HTML Report ---
                
                // 1. Personal Detail Table
                let detailHtml = `
                    <div class="mb-4 overflow-x-auto">
                        <table class="w-full text-xs text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 border-b">
                                    <th class="p-2">成員</th>
                                    <th class="p-2 text-right">先墊金額</th>
                                    <th class="p-2 text-right">實際消費</th>
                                    <th class="p-2 text-right">結餘</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                members.forEach(m => {
                    const d = details[m];
                    const netVal = balances[m];
                    const colorClass = netVal >= 0 ? 'text-green-600' : 'text-red-600';
                    const statusText = netVal >= 0 ? '應收' : '應付';
                    
                    detailHtml += `
                        <tr class="border-b border-gray-100">
                            <td class="p-2 font-bold">${m}</td>
                            <td class="p-2 text-right text-gray-500">$${Math.round(d.paid).toLocaleString()}</td>
                            <td class="p-2 text-right text-gray-500">$${Math.round(d.share).toLocaleString()}</td>
                            <td class="p-2 text-right font-bold ${colorClass}">
                                ${statusText} $${Math.round(Math.abs(netVal)).toLocaleString()}
                            </td>
                        </tr>
                    `;
                });
                
                detailHtml += `</tbody></table></div>`;

                // 2. Transfer Plan
                let transferHtml = `<h4 class="font-bold text-gray-700 mb-2 border-l-4 border-indigo-500 pl-2">建議轉帳方案</h4><ul class="space-y-2">`;
                
                if (creditors.length === 0) {
                    transferHtml += '<li class="text-center text-green-500 font-bold bg-green-50 p-2 rounded">目前帳目已平衡，無需轉帳！</li>';
                } else {
                    let c = 0; 
                    let d = 0;
                    while (c < creditors.length && d < debtors.length) {
                        let amount = Math.min(creditors[c].amount, Math.abs(debtors[d].amount));
                        
                        if (amount >= 1) { // Filter out tiny dust amounts
                            const debtorName = debtors[d].name;
                            const creditorName = creditors[c].name;
                            
                            // Highlight user's name
                            const isMe = (state.userName === debtorName || state.userName === creditorName);
                            const bgClass = isMe ? 'bg-indigo-50 border border-indigo-200' : 'bg-white border-b border-gray-100';
                            
                            transferHtml += `
                                <li class="flex justify-between items-center p-2 rounded ${bgClass}">
                                    <div class="flex items-center gap-2 text-sm">
                                        <span class="font-bold text-gray-700">${debtorName}</span>
                                        <i class="fa-solid fa-arrow-right text-gray-400 text-xs"></i>
                                        <span class="font-bold text-gray-700">${creditorName}</span>
                                    </div>
                                    <span class="font-mono font-bold text-indigo-600">$${Math.round(amount).toLocaleString()}</span>
                                </li>
                            `;
                        }

                        creditors[c].amount -= amount;
                        debtors[d].amount += amount;

                        if (Math.abs(creditors[c].amount) < 1) c++;
                        if (Math.abs(debtors[d].amount) < 1) d++;
                    }
                }
                transferHtml += '</ul>';

                // Find my share to update the Archive section placeholder
                const myShare = details[state.userName] ? Math.round(details[state.userName].share) : 0;
                document.getElementById('settleShareAmount').innerText = myShare.toLocaleString();

                // Combine and render
                document.getElementById('settleContent').innerHTML = detailHtml + transferHtml;
                ui.openModal('settleModal');
            },

            loadUserStats: async () => { /* Load Stats for Profile Tab */ const y=document.getElementById('statYear').value,m=document.getElementById('statMonth').value,cnt=document.getElementById('ledgerStatsContainer'),ldr=document.getElementById('statsLoader');ldr.classList.remove('hidden');cnt.innerHTML='';
                try{let tx=[];const proms=state.ledgers.map(l=>getDocs(query(collection(state.db,"transactions"),where("ledgerId","==",l.id))).then(s=>s.docs.map(d=>({...d.data(),id:d.id,ledgerName:l.name,ledgerType:l.type,ledgerMembers:l.members}))));const res=await Promise.all(proms);tx=res.flat();state.allTransactionsCache=tx;const ftx=tx.filter(t=>{const d=new Date(t.date);return d.getFullYear().toString()===y&&(m==='all'||(d.getMonth()+1).toString().padStart(2,'0')===m);});state.ledgers.forEach(l=>{const ltx=ftx.filter(t=>t.ledgerId===l.id);if(ltx.length===0)return;let my=0,tot=0;ltx.forEach(t=>{if(t.type==='expense'){tot+=t.amount;if(l.type==='personal'||t.paidBy===state.userName)my+=t.amount;}});if(tot===0&&my===0)return;cnt.innerHTML+=`<div class="bg-white p-4 rounded-xl border mb-3"><div class="flex justify-between"><div><h4 class="font-bold text-sm">${l.name}</h4><p class="text-xl font-bold text-blue-600">$${my.toLocaleString()}</p></div><div class="text-xs text-gray-400 text-right">總支出: $${tot.toLocaleString()}<br>${l.type==='group'?l.members.length+'人':''}</div></div></div>`;});if(cnt.innerHTML==='')cnt.innerHTML='<div class="text-center text-gray-400 py-4">無資料</div>';
                
                // Detailed Stats Logic
                if(document.getElementById('showDetailsCheck').checked) {
                    const yearTx = tx.filter(t => new Date(t.date).getFullYear().toString() === y);
                    if(yearTx.length > 0) {
                        const process = (type, title, color) => {
                            const filtered = yearTx.filter(t => t.type === type && (t.ledgerType === 'personal' || t.paidBy === state.userName));
                            const total = filtered.reduce((acc, t) => acc + t.amount, 0);
                            const catMap = {};
                            filtered.forEach(t => catMap[t.category] = (catMap[t.category] || 0) + t.amount);
                            const sorted = Object.entries(catMap).sort((a,b) => b[1] - a[1]);
                            
                            return `
                                <div class="bg-white p-4 rounded-xl border mt-4">
                                    <h4 class="font-bold text-sm text-${color}-600 mb-3 border-b pb-2">${title} (${y}年總計)</h4>
                                    ${sorted.map(([cat, amt]) => {
                                        const pct = total ? Math.round((amt/total)*100) : 0;
                                        return `<div class="flex justify-between text-xs mb-1"><span>${cat}</span><span class="font-bold">$${amt.toLocaleString()} (${pct}%)</span></div>
                                                <div class="w-full bg-gray-100 h-1.5 rounded-full mb-2"><div class="bg-${color}-400 h-1.5 rounded-full" style="width:${pct}%"></div></div>`;
                                    }).join('') || '<div class="text-center text-gray-400 text-xs">無紀錄</div>'}
                                </div>
                            `;
                        };
                        cnt.innerHTML = process('expense', '年度消費類別統計', 'rose') + process('income', '年度收入來源統計', 'emerald') + cnt.innerHTML;
                    }
                }
                }catch(e){console.error(e);}finally{ldr.classList.add('hidden');}
            }
        };

        const ai = { /* ... */ 
            handleImageUpload: (inp) => { const f=inp.files[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{ state.currentImage={base64:r.result.split(',')[1],mimeType:f.type}; document.getElementById('imagePreview').src=r.result; document.getElementById('imagePreviewContainer').classList.remove('hidden'); document.getElementById('uploadZone').classList.add('hidden'); ai.runAiAnalysis(); }; r.readAsDataURL(f); },
            clearImage: () => { state.currentImage=null; document.getElementById('receiptUpload').value=''; document.getElementById('imagePreviewContainer').classList.add('hidden'); document.getElementById('uploadZone').classList.remove('hidden'); document.getElementById('aiLoading').classList.add('hidden'); document.getElementById('aiStatusText').innerText = "AI 正在辨識收據內容..."; },
            runQrScan: async () => {},
            runAiAnalysis: async () => { 
                if(!state.geminiKey) return alert("請先設定 API Key"); 
                const l=document.getElementById('aiLoading'); 
                l.classList.remove('hidden'); 
                document.getElementById('aiStatusText').innerText = "AI 正在辨識收據內容..."; 
                
                try{ 
                    // Update: Instruct AI to normalize categories, detect new ones, AND perform tax distribution
                    const existingCats = state.categories.expense.join(', ');
                    let p = `Analyze this receipt image. 
                    
                    TASKS:
                    1. Identify all item names and their base prices.
                    2. Identify global modifiers: Service Charge (e.g., 10%), VAT/Tax (e.g., 5% or fixed amount), and Global Discounts.
                    3. DISTRIBUTE these global modifiers proportionally to each item based on its price weight.
                       Formula: FinalItemPrice = BasePrice + (BasePrice / Subtotal) * (TotalServiceFee + TotalTax - TotalDiscount).
                    4. Translate item names to Traditional Chinese. Format: "Traditional Chinese Name (Original Name)".
                    5. Create a 'note' field for each item showing the calculation. Example: "Base $100 + Service $10".
                    6. Map category to existing: [${existingCats}]. If vague (food), map to '早餐'/'午餐'/'晚餐'/'飲料' based on time/type.
                    
                    RETURN JSON OBJECT (No markdown): 
                    { 
                      "merchant": "store name", 
                      "items": [
                        { "name": "...", "amount": number (final distributed price), "category": "...", "note": "..." }
                      ] 
                    }`; 
                    
                    if (state.customAiPrompt) { p += ` Additional Instruction from user: ${state.customAiPrompt}`; } 
                    
                    // Use gemini-2.5-flash-preview-09-2025 as per environment requirements
                    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.geminiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ 
                                role: "user",
                                parts: [
                                    { text: p }, 
                                    { inlineData: { mimeType: state.currentImage.mimeType, data: state.currentImage.base64 } }
                                ] 
                            }] 
                        })
                    });
                    
                    const d = await r.json();
                    if (d.error) throw new Error(d.error.message); // Handle API errors
                    if (!d.candidates || !d.candidates[0].content) throw new Error("No content returned");
                    
                    const txt = d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,''); 
                    const j=JSON.parse(txt); 
                    
                    document.getElementById('transactionItemsList').innerHTML=''; 
                    
                    // Process items and check for new categories
                    (j.items||[]).forEach(i => {
                        // Check if category exists
                        if (!state.categories.expense.includes(i.category) && !state.categories.income.includes(i.category)) {
                            // Auto-add new category to expense list by default
                            state.categories.expense.push(i.category);
                            app.saveCategories();
                            ui.renderSettings(); // Update UI in background
                        }
                        ui.addItemRow(i.name, i.category, i.amount, i.note);
                    }); 
                    
                    if(j.merchant) document.getElementById('tMerchant').value = j.merchant; 
                    ui.updateTotal(); 
                    document.getElementById('aiStatusText').innerText = "辨識完成！已自動分攤稅費。"; 
                    setTimeout(() => l.classList.add('hidden'), 1500); 
                }catch(e){ 
                    console.error(e); 
                    alert("辨識錯誤: " + e.message); // Show actual error
                    document.getElementById('aiStatusText').innerText = "辨識失敗，請手動輸入"; 
                    setTimeout(() => l.classList.add('hidden'), 2000); 
                } 
            }
        };

        const ui = {
            toggleCurrencyEdit: (show) => {
                const view = document.getElementById('currencyViewMode');
                const edit = document.getElementById('currencyEditMode');
                if(show) {
                    view.classList.add('hidden');
                    edit.classList.remove('hidden');
                } else {
                    view.classList.remove('hidden');
                    edit.classList.add('hidden');
                    // Update view text to reflect changes immediately when hiding
                    const c = document.getElementById('tCurrency').value;
                    const r = document.getElementById('tRate').value;
                    document.getElementById('currencyViewText').innerText = `${c} (匯率: ${r})`;
                }
            },
            toggleStatsSection: () => {
                const content = document.getElementById('statsContent');
                const icon = document.getElementById('statsToggleIcon');
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    icon.classList.add('rotate-180');
                } else {
                    content.classList.add('hidden');
                    icon.classList.remove('rotate-180');
                }
            },
            toggleAllSplit: (checked) => {
                document.querySelectorAll('.split-checkbox').forEach(cb => cb.checked = checked);
            },
            renderSplitCheckboxes: () => {
                const container = document.getElementById('splitUserContainer');
                container.innerHTML = '';
                
                // Show current members
                if(!state.currentLedger || !state.currentLedger.members) return;
                
                state.currentLedger.members.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-1.5';
                    div.innerHTML = `
                        <input type="checkbox" id="split-${m}" value="${m}" class="split-checkbox w-3.5 h-3.5 text-indigo-600 rounded border-gray-300" checked>
                        <label for="split-${m}" class="text-xs text-gray-700 cursor-pointer select-none">${m}</label>
                    `;
                    container.appendChild(div);
                });
            },
            renderLedgerList: () => { 
                const l = document.getElementById('ledgerList'), al = document.getElementById('archivedLedgerList'); 
                const ml = document.getElementById('mobileLedgerList'); 
                
                l.innerHTML = ''; al.innerHTML = ''; ml.innerHTML = ''; 
                let hasArc = false; 
                
                // Add "Create New" button at the top of mobile list for visibility
                ml.innerHTML += `
                    <button onclick="ui.openModal('ledgerModal'); ui.toggleMobileMenu()" class="w-full py-3 border-2 border-dashed border-slate-600 text-slate-400 rounded-lg mb-4 hover:border-emerald-500 hover:text-emerald-500 transition">
                        <i class="fa-solid fa-plus"></i> 建立新帳本
                    </button>
                `;

                state.ledgers.forEach(x => { 
                    const isActive = x.id === state.currentLedger?.id;
                    const activeClass = isActive ? 'bg-emerald-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-700';
                    
                    // Logic for actions based on status
                    let actionButtons = '';
                    
                    if (x.status === 'archived') {
                        actionButtons = `
                            <div class="hidden group-hover:flex gap-1 items-center">
                                <button onclick="app.unarchiveLedger('${x.id}', '${x.name}')" class="p-1.5 hover:text-yellow-300 transition" title="取消結算/還原"><i class="fa-solid fa-box-open text-xs"></i></button>
                                <button onclick="app.deleteLedger('${x.id}', '${x.name}')" class="p-1.5 hover:text-red-300 transition" title="刪除帳本"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                        `;
                    } else {
                        actionButtons = `
                            <div class="hidden group-hover:flex gap-1 items-center">
                                <button onclick="app.editLedger('${x.id}', '${x.name}')" class="p-1.5 hover:text-blue-300 transition" title="編輯名稱"><i class="fa-solid fa-pen text-xs"></i></button>
                                <button onclick="app.deleteLedger('${x.id}', '${x.name}')" class="p-1.5 hover:text-red-300 transition" title="刪除帳本"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                        `;
                    }

                    const h = `
                    <li class="group relative">
                        <div class="w-full flex items-center justify-between px-4 py-3 rounded-lg cursor-pointer ${activeClass}" onclick="ui.switchLedger('${x.id}')">
                            <span class="flex items-center gap-2 truncate">
                                <i class="fa-solid ${x.type==='group'?'fa-users':'fa-book'}"></i>
                                ${x.name}
                            </span>
                            <div class="flex items-center gap-2" onclick="event.stopPropagation()">
                                ${x.password ? '<i class="fa-solid fa-lock text-xs opacity-70"></i>' : ''}
                                ${actionButtons}
                            </div>
                        </div>
                    </li>`; 
                    
                    if(x.status === 'archived'){
                        al.innerHTML += h;
                        hasArc = true;
                    } else {
                        l.innerHTML += h;
                    }

                    // --- Mobile HTML (mh) ---
                    const mActiveClass = isActive ? 'bg-emerald-600 border-emerald-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-300';
                    const mActionButtons = x.status === 'archived' ? 
                        `<button onclick="event.stopPropagation(); app.unarchiveLedger('${x.id}', '${x.name}')" class="p-2 bg-yellow-600/30 text-yellow-300 rounded"><i class="fa-solid fa-box-open"></i></button>
                         <button onclick="event.stopPropagation(); app.deleteLedger('${x.id}', '${x.name}')" class="p-2 bg-red-600/30 text-red-300 rounded"><i class="fa-solid fa-trash"></i></button>` :
                        `<button onclick="event.stopPropagation(); app.editLedger('${x.id}', '${x.name}')" class="p-2 bg-blue-600/30 text-blue-300 rounded"><i class="fa-solid fa-pen"></i></button>
                         <button onclick="event.stopPropagation(); app.deleteLedger('${x.id}', '${x.name}')" class="p-2 bg-red-600/30 text-red-300 rounded"><i class="fa-solid fa-trash"></i></button>`;

                    const mh = `
                        <div class="w-full flex items-center justify-between p-3 rounded-lg border ${mActiveClass} mb-2 shadow-sm" onclick="ui.switchLedger('${x.id}'); ui.toggleMobileMenu()">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <i class="fa-solid ${x.type==='group'?'fa-users':'fa-book'}"></i>
                                <span class="truncate font-bold ${x.status==='archived'?'line-through opacity-70':''}">${x.name}</span>
                                ${x.status === 'archived' ? '<span class="text-[10px] bg-slate-900/50 px-2 py-0.5 rounded ml-2">歸檔</span>' : ''}
                            </div>
                            <div class="flex gap-2 ml-2">
                                ${mActionButtons}
                            </div>
                        </div>
                    `;
                    ml.innerHTML += mh;
                }); 
                document.getElementById('archivedSection').className = hasArc ? 'mt-6' : 'hidden'; 
            },
            switchLedger: (id) => { const l=state.ledgers.find(x=>x.id===id); if(!l)return; 
                // Removed password check logic here as we rely on user login
                state.currentLedger=l; localStorage.setItem('acc_current_ledger',id); document.getElementById('currentLedgerTitle').innerText=l.name; const isG=l.type==='group'; document.getElementById('ledgerTypeBadge').className=isG?'block px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded':'hidden'; document.getElementById('ledgerMembers').innerText=isG?l.members.join(','):''; document.getElementById('ledgerMembers').className=isG?'block text-sm text-gray-500':'hidden'; document.getElementById('groupPayerField').className=isG?'col-span-2':'hidden'; document.getElementById('settleBtn').className=isG?'bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-lg shadow transition flex items-center gap-1 font-medium text-xs md:text-sm':'hidden'; 
                // Toggle Split Section Visibility
                document.getElementById('splitSection').classList.toggle('hidden', !isG);
                if(l.status==='archived')document.getElementById('addTxBtn').classList.add('hidden'); else document.getElementById('addTxBtn').classList.remove('hidden'); ui.renderLedgerList(); app.listenTransactions(); app.listenRecurringRules(); },
            
            toggleSelectAll: (source) => { document.querySelectorAll('.tx-checkbox').forEach(cb => { cb.checked = source.checked; }); ui.updateBulkActionState(); },
            updateBulkActionState: () => { const count = document.querySelectorAll('.tx-checkbox:checked').length; const btn = document.getElementById('bulkDeleteBtn'); const span = document.getElementById('selectedCount'); if (count > 0) { btn.classList.remove('hidden'); span.innerText = count; } else { btn.classList.add('hidden'); } },

            renderTransactionListHTML: (list) => { 
                const tb=document.getElementById('transactionTableBody');
                if(list.length===0) { tb.innerHTML='<tr><td colspan="5" class="p-8 text-center text-gray-400">此區間無交易資料</td></tr>'; return; }
                const groups = {};
                list.forEach(t => { const gid = t.groupId || t.id; if(!groups[gid]) { groups[gid] = { ...t, items: [], totalAmount: 0 }; } groups[gid].items.push(t); groups[gid].totalAmount += t.amount; });

                tb.innerHTML = Object.values(groups).sort((a,b) => new Date(b.date) - new Date(a.date)).map(g => {
                    const isGroup = g.items.length > 1; const isE = g.type === 'expense'; const mainColor = isE ? 'text-rose-600' : 'text-emerald-600'; const icon = isGroup ? '<i class="fa-solid fa-layer-group text-gray-400 mr-1"></i>' : '';
                    
                    const catTotals = {};
                    g.items.forEach(i => { catTotals[i.category] = (catTotals[i.category] || 0) + i.amount; });
                    const topCats = Object.entries(catTotals).sort((a, b) => b[1] - a[1]).slice(0, 3).map(e => e[0]).join(', ');
                    const suffix = Object.keys(catTotals).length > 3 ? '...' : '';
                    const displayItems = topCats + suffix;

                    // Add Image Icon logic for Header
                    // 修改：確保傳遞給 viewImage 的是原始 Drive URL (方便轉換) 或已經轉換好的
                    const hasImage = g.items.some(i => i.imageUrl);
                    const imageItem = g.items.find(i=>i.imageUrl);
                    const imageIcon = hasImage ? `<button onclick="event.stopPropagation(); ui.viewImage('${imageItem.imageUrl}')" class="text-indigo-500 hover:text-indigo-700 ml-2" title="查看收據"><i class="fa-solid fa-paperclip"></i></button>` : '';

                    let titleHtml = '';
                    if (g.merchant) { titleHtml = `<div class="font-bold text-gray-800 text-sm md:text-base">${g.merchant}${imageIcon}</div><div class="text-xs text-gray-500 mt-0.5 truncate max-w-[120px] md:max-w-none">${displayItems}</div>`; } else { titleHtml = `<div class="font-medium text-gray-800 text-sm md:text-base truncate max-w-[120px] md:max-w-none">${displayItems}${imageIcon}</div>`; }

                    const detailId = `detail-${g.id}`; const allIds = g.items.map(i => i.id).join(',');

                    return `<tr class="border-b hover:bg-gray-50 tx-group-header">
                        <td class="hidden md:table-cell p-2 md:p-4 w-10 text-center" onclick="event.stopPropagation()"><input type="checkbox" class="tx-checkbox w-4 h-4 cursor-pointer" data-ids="${allIds}" onchange="ui.updateBulkActionState()"></td>
                        <td class="p-2 md:p-4 text-xs md:text-sm whitespace-nowrap" onclick="ui.toggleDetail('${detailId}')">${g.date.slice(5)}</td>
                        <td class="p-2 md:p-4" onclick="ui.toggleDetail('${detailId}')"><div class="flex items-center">${icon}<div class="flex flex-col">${titleHtml}<span class="text-[10px] md:text-xs text-gray-400 mt-0.5">${g.category} ${g.paidBy?`(${g.paidBy})`:''}</span></div></div></td>
                        <td class="p-2 md:p-4 text-right font-bold ${mainColor} text-sm md:text-base" onclick="ui.toggleDetail('${detailId}')">${isE?'-':'+'}${(isGroup ? g.totalAmount : g.amount).toLocaleString()}</td>
                        <td class="p-2 md:p-4 text-center" onclick="ui.toggleDetail('${detailId}')"><i class="fa-solid fa-chevron-down text-gray-300 transition text-xs md:text-sm" id="arrow-${detailId}"></i></td>
                    </tr>
                    <tr id="${detailId}" class="hidden tx-detail-row"><td colspan="5" class="p-0"><div class="p-4 pl-4 md:pl-16 bg-slate-50 border-b border-gray-100 shadow-inner"><p class="text-xs text-gray-400 mb-2 font-bold uppercase">細項明細</p>${g.items.map(item => `
                    <div class="py-2 border-b border-gray-200 last:border-0 text-sm">
                        <div class="flex justify-between items-center mb-1">
                            <span>
                                ${item.name} <span class="text-xs text-gray-400 ml-2">${item.category}</span>
                                ${item.imageUrl ? `<button onclick="ui.viewImage('${item.imageUrl}')" class="text-indigo-400 hover:text-indigo-600 ml-2"><i class="fa-solid fa-image"></i></button>` : ''}
                            </span>
                            <div class="flex items-center gap-4"><span class="font-mono text-gray-600">$${item.amount.toLocaleString()}</span>
                                <div class="flex gap-2">
                                    <button onclick="app.editTransaction('${item.id}')" class="text-blue-400 hover:text-blue-600"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="app.deleteTransaction('${item.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        ${item.note ? `<p class="text-xs text-gray-400 bg-gray-100 p-1 rounded inline-block"><i class="fa-solid fa-circle-info mr-1"></i>${item.note}</p>` : ''}
                    </div>`).join('')}</div></td></tr>`;
                }).join('');
            },
            
            renderTopStats: (list) => {
                const process = (type) => {
                    const filtered = list.filter(t => t.type === type);
                    const total = filtered.reduce((sum, t) => sum + t.amount, 0);
                    const catMap = {};
                    filtered.forEach(t => catMap[t.category] = (catMap[t.category] || 0) + t.amount);
                    const sorted = Object.entries(catMap).sort((a,b) => b[1] - a[1]);
                    return sorted.map(([cat, amt]) => {
                        const pct = total ? Math.round((amt/total)*100) : 0;
                        return `<div class="flex justify-between items-center text-xs mb-1">
                                    <span class="text-gray-600">${cat}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono font-bold">${pct}%</span>
                                        <span class="text-gray-800">$${amt.toLocaleString()}</span>
                                    </div>
                                </div>
                                <div class="w-full bg-gray-100 h-1.5 rounded-full mb-2">
                                    <div class="bg-${type==='expense'?'rose':'emerald'}-400 h-1.5 rounded-full" style="width:${pct}%"></div>
                                </div>`;
                    }).join('') || '<div class="text-gray-400 text-xs text-center">無資料</div>';
                };

                const processMerchant = () => {
                    const filtered = list.filter(t => t.type === 'expense'); // Only analyze expense
                    const total = filtered.reduce((sum, t) => sum + t.amount, 0);
                    const merchMap = {};
                    filtered.forEach(t => {
                        const mName = t.merchant || '未分類';
                        merchMap[mName] = (merchMap[mName] || 0) + t.amount;
                    });
                    const sorted = Object.entries(merchMap).sort((a,b) => b[1] - a[1]).slice(0, 5); // Top 5
                    
                    return sorted.map(([name, amt]) => {
                        const pct = total ? Math.round((amt/total)*100) : 0;
                        return `<div class="flex justify-between items-center text-xs mb-1">
                                    <span class="text-gray-600 truncate max-w-[100px]">${name}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono font-bold">${pct}%</span>
                                        <span class="text-gray-800">$${amt.toLocaleString()}</span>
                                    </div>
                                </div>
                                <div class="w-full bg-gray-100 h-1.5 rounded-full mb-2">
                                    <div class="bg-blue-400 h-1.5 rounded-full" style="width:${pct}%"></div>
                                </div>`;
                    }).join('') || '<div class="text-gray-400 text-xs text-center">無資料</div>';
                };

                document.getElementById('topExpenseList').innerHTML = process('expense');
                document.getElementById('topIncomeList').innerHTML = process('income');
                document.getElementById('topMerchantList').innerHTML = processMerchant();
            },

            renderAssets: () => {
                const list = document.getElementById('assetsList');
                list.innerHTML = '';
                let total = 0;
                
                if (state.assets.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm">暫無資產紀錄</div>';
                } else {
                    state.assets.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt)).forEach(asset => {
                        total += asset.currentBalance;
                        const date = new Date(asset.updatedAt).toLocaleDateString();
                        // Generate history list HTML
                        const historyHtml = (asset.history || []).sort((a, b) => new Date(b.date) - new Date(a.date)).map(h => `
                            <li class="flex justify-between text-[10px] text-gray-500 py-1 border-b border-gray-100 last:border-0">
                                <span>${new Date(h.date).toLocaleString()}</span>
                                <span class="font-mono">$${h.balance.toLocaleString()}</span>
                            </li>
                        `).join('');

                        list.innerHTML += `
                            <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                                <div class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-50" onclick="ui.toggleAssetHistory('${asset.id}')">
                                    <div>
                                        <p class="font-bold text-gray-800">${asset.name}</p>
                                        <p class="text-xs text-gray-400">更新於: ${date}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-mono font-bold text-indigo-600 text-lg">$${asset.currentBalance.toLocaleString()}</p>
                                        <div class="flex gap-3 justify-end mt-1" onclick="event.stopPropagation()">
                                            <button onclick="app.editAsset('${asset.name}', ${asset.currentBalance})" class="text-xs font-bold text-blue-500 hover:text-blue-700"><i class="fa-solid fa-pen-to-square"></i> 修改</button>
                                            <button onclick="app.deleteAsset('${asset.id}')" class="text-xs font-bold text-red-400 hover:text-red-600"><i class="fa-solid fa-trash-can"></i> 刪除</button>
                                            <i class="fa-solid fa-chevron-down text-gray-300 text-xs transition transform" id="asset-arrow-${asset.id}"></i>
                                        </div>
                                    </div>
                                </div>
                                <div id="asset-history-${asset.id}" class="hidden bg-gray-50 p-3 text-xs border-t border-gray-100 animate-fade-in">
                                    <p class="font-bold text-gray-500 mb-2 uppercase">變更歷史</p>
                                    <ul class="space-y-1 max-h-32 overflow-y-auto">
                                        ${historyHtml || '<li class="text-center italic">無歷史紀錄</li>'}
                                    </ul>
                                </div>
                            </div>
                        `;
                    });
                }
                document.getElementById('totalAssetDisplay').innerText = '$' + total.toLocaleString();
            },
            
            renderAssetOptions: () => {
                const dl = document.getElementById('assetNamesList');
                if(!dl) return;
                dl.innerHTML = '';
                // Combine Default Banks with user's existing asset names, unique
                const userNames = state.assets.map(a => a.name);
                const allNames = [...new Set([...DEFAULT_BANKS, ...userNames])];
                
                allNames.forEach(n => {
                    const opt = document.createElement('option');
                    opt.value = n;
                    dl.appendChild(opt);
                });
            },
            
            toggleAssetHistory: (id) => {
                const el = document.getElementById(`asset-history-${id}`);
                const arrow = document.getElementById(`asset-arrow-${id}`);
                if(el.classList.contains('hidden')){
                    el.classList.remove('hidden');
                    arrow.classList.add('rotate-180');
                } else {
                    el.classList.add('hidden');
                    arrow.classList.remove('rotate-180');
                }
            },

            // --- RECURRING UI LOGIC ---
            openRecurringModal: () => {
                ui.openModal('recurringModal');
                ui.toggleRecurringForm(false);
                ui.renderRecurringList();
            },

            toggleRecurringForm: (show, editData = null) => {
                const formSection = document.getElementById('recurringFormSection');
                const listSection = document.getElementById('recurringListSection');
                const btnAdd = document.getElementById('btnAddRecurring');
                const formTitle = document.getElementById('recurringFormTitle');

                if (show) {
                    formSection.classList.remove('hidden');
                    listSection.classList.add('hidden');
                    btnAdd.classList.add('hidden');
                    
                    if (editData) {
                        formTitle.innerText = "編輯規則";
                        document.getElementById('recRuleId').value = editData.id;
                        document.getElementById('recType').value = editData.type;
                        document.getElementById('recFreq').value = editData.frequency;
                        document.getElementById('recName').value = editData.name;
                        document.getElementById('recAmount').value = editData.amount;
                        document.getElementById('recCategory').value = editData.category;
                        document.getElementById('recNextDate').value = editData.nextDueDate;
                    } else {
                        formTitle.innerText = "新增規則";
                        document.getElementById('recRuleId').value = '';
                        document.getElementById('recName').value = '';
                        document.getElementById('recAmount').value = '';
                        document.getElementById('recNextDate').value = new Date().toISOString().split('T')[0];
                    }
                    ui.updateCategoriesForRecurring();
                } else {
                    formSection.classList.add('hidden');
                    listSection.classList.remove('hidden');
                    btnAdd.classList.remove('hidden');
                }
            },

            updateCategoriesForRecurring: () => {
                const type = document.getElementById('recType').value;
                const catSelect = document.getElementById('recCategory');
                const cats = state.categories[type] || [];
                const currentVal = catSelect.value;
                
                catSelect.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
                if (currentVal && cats.includes(currentVal)) {
                    catSelect.value = currentVal;
                }
            },

            editRecurringRule: (id) => {
                const rule = state.recurringRules.find(r => r.id === id);
                if (rule) ui.toggleRecurringForm(true, rule);
            },

            renderRecurringList: () => {
                const container = document.getElementById('recurringRulesList');
                if (!state.recurringRules.length) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-8">尚無固定收支設定</div>';
                    return;
                }

                container.innerHTML = state.recurringRules.map(r => {
                    const today = new Date().toISOString().split('T')[0];
                    const isDue = r.nextDueDate <= today;
                    const typeColor = r.type === 'expense' ? 'text-rose-600' : 'text-emerald-600';
                    const freqText = r.frequency === 'monthly' ? '每月' : '每年';

                    return `
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex justify-between items-center ${isDue ? 'ring-2 ring-purple-400 bg-purple-50' : ''}">
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold px-2 py-0.5 rounded ${r.type === 'expense' ? 'bg-rose-100 text-rose-700' : 'bg-emerald-100 text-emerald-700'}">${freqText}</span>
                                <h4 class="font-bold text-gray-800">${r.name}</h4>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                金額: <span class="font-mono ${typeColor} font-bold">$${r.amount.toLocaleString()}</span> | 
                                分類: ${r.category} | 
                                下次: <span class="${isDue ? 'text-red-600 font-bold' : ''}">${r.nextDueDate}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 items-center">
                            ${isDue ? `<button onclick="app.executeRecurring('${r.id}')" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow animate-pulse">立即入帳</button>` : ''}
                            <button onclick="ui.editRecurringRule('${r.id}')" class="text-gray-400 hover:text-blue-500 p-2"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="app.deleteRecurringRule('${r.id}')" class="text-gray-400 hover:text-red-500 p-2"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                    `;
                }).join('');
            },

            // --- HOVER STATS LOGIC ---
            showHoverStats: (key) => {
                const data = state.currentChartStats[key];
                if (!data) return;
                
                const html = `
                    <div class="bg-white rounded-xl p-3 border border-indigo-200 shadow-sm animate-fade-in">
                        <div class="flex justify-between items-end mb-2 border-b border-gray-100 pb-1">
                            <span class="text-indigo-900 font-bold text-sm">${data.label}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div>
                                <span class="block text-gray-400 uppercase text-[10px]">收入</span>
                                <span class="font-bold text-emerald-600 text-sm">$${data.income.toLocaleString()}</span>
                            </div>
                            <div class="text-right">
                                <span class="block text-gray-400 uppercase text-[10px]">支出</span>
                                <span class="font-bold text-rose-600 text-sm">$${data.expense.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="mt-2 pt-1 border-t border-dashed border-gray-200 text-center">
                            <span class="text-[10px] text-gray-400">淨利</span>
                            <span class="font-bold ${data.income - data.expense >= 0 ? 'text-blue-600' : 'text-red-500'} ml-1">
                                $${(data.income - data.expense).toLocaleString()}
                            </span>
                        </div>
                    </div>
                `;
                document.getElementById('dailyStatsSummary').innerHTML = html;
                document.getElementById('dailyStatsSummary').classList.remove('hidden');
            },
            resetStatsSummary: () => {
                document.getElementById('dailyStatsSummary').innerHTML = `
                    <div class="text-center text-gray-400 text-sm py-6 bg-slate-50 rounded-xl border border-dashed border-gray-200">
                        滑過或點擊下方圖表以查看收支詳情
                    </div>
                `;
            },

            toggleDetail: (id) => { const row=document.getElementById(id), arrow=document.getElementById(`arrow-${id}`); if(row.classList.contains('hidden')){row.classList.remove('hidden');arrow.classList.add('rotate-180');}else{row.classList.add('hidden');arrow.classList.remove('rotate-180');} },
            openTransactionModal: (t) => { 
                document.getElementById('txModalTitle').innerText = t || '新增'; 
                document.getElementById('transactionForm').reset(); 
                document.getElementById('transactionItemsList').innerHTML = ''; 
                ui.addItemRow(); 
                
                // --- Updated Logic: Reset Date & Currency Defaults ---
                
                // 1. Reset Date to Today (for new entries)
                document.getElementById('tDate').value = new Date().toISOString().split('T')[0];

                // 2. Set Default Currency
                const ledger = state.currentLedger;
                const defCurr = ledger.type === 'group' ? (ledger.defaultCurrency || 'TWD') : 'TWD';
                
                document.getElementById('tCurrency').value = defCurr;
                // Set initial rate based on default currency
                if(state.rates[defCurr]) {
                    document.getElementById('tRate').value = state.rates[defCurr];
                } else {
                    document.getElementById('tRate').value = 1;
                }
                
                // 3. Reset UI to View Mode (Hidden edit controls)
                ui.toggleCurrencyEdit(false);

                // 4. Update Split Checkboxes
                ui.renderSplitCheckboxes();

                // 5. Populate Payer Select if group ledger
                if (ledger.type === 'group') {
                    const payerSelect = document.getElementById('tPaidBy');
                    payerSelect.innerHTML = '';
                    ledger.members.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m;
                        opt.innerText = m;
                        if (m === state.userName) opt.selected = true;
                        payerSelect.appendChild(opt);
                    });
                }
                
                // 6. Populate Merchant Datalist
                const merchantDatalist = document.getElementById('merchantDatalist');
                merchantDatalist.innerHTML = '';
                state.merchants.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    merchantDatalist.appendChild(option);
                });

                ui.openModal('transactionModal'); 
            },
            addItemRow: (n='',c='',a='', note='') => { 
                const div=document.createElement('div'); 
                div.className='grid grid-cols-12 gap-2 p-2 border-b item-row items-start'; 
                // Added onblur="app.autoCategorize(this)" to item-name input
                div.innerHTML=`
                    <div class="col-span-5">
                        <textarea class="item-name w-full border p-1 rounded text-sm mb-1" rows="2" placeholder="品項" onblur="app.autoCategorize(this)">${n}</textarea>
                        <input type="text" class="item-note w-full border p-1 rounded text-xs text-gray-500 bg-gray-50" value="${note}" placeholder="備註/公式 (選填)">
                    </div>
                    <div class="col-span-3">
                        <select class="item-cat w-full border p-1 rounded text-sm">${state.categories[document.getElementById('tType').value].map(x=>`<option ${x===c?'selected':''}>${x}</option>`).join('')}</select>
                    </div>
                    <div class="col-span-3">
                        <input type="number" class="item-amount w-full border p-1 rounded text-sm" value="${a}" placeholder="0" oninput="ui.updateTotal()">
                    </div>
                    <div class="col-span-1 text-center">
                        <button type="button" class="text-gray-400 hover:text-red-500" onclick="this.parentElement.parentElement.remove(); ui.updateTotal()"><i class="fa-solid fa-times"></i></button>
                    </div>`; 
                document.getElementById('transactionItemsList').appendChild(div); 
            },
            updateCategoriesForRows: () => { document.querySelectorAll('.item-cat').forEach(s=>s.innerHTML=state.categories[document.getElementById('tType').value].map(c=>`<option>${c}</option>`).join('')); },
            updateTotal: () => { let t=0; document.querySelectorAll('.item-amount').forEach(i=>t+=parseFloat(i.value)||0); document.getElementById('displayTotal').innerText='$'+t.toLocaleString(); },
            toggleMemberInput: () => { 
                const isGroup = document.getElementById('newLedgerType').value === 'group';
                document.getElementById('memberInputDiv').classList.toggle('hidden', !isGroup); 
                if(isGroup) {
                    ui.renderMemberCheckboxes();
                }
            },
            renderMemberCheckboxes: () => {
                const list = document.getElementById('memberSelectionList');
                list.innerHTML = '';
                
                // Filter out current user from selection list
                const availableUsers = state.usersList.filter(u => u !== state.userName);
                
                if(availableUsers.length === 0) {
                    list.innerHTML = '<div class="col-span-2 text-center text-gray-400 py-2">沒有其他使用者</div>';
                    return;
                }

                availableUsers.forEach(u => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2';
                    div.innerHTML = `
                        <input type="checkbox" id="member-${u}" value="${u}" class="member-checkbox w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="member-${u}" class="text-gray-700 truncate cursor-pointer">${u}</label>
                    `;
                    list.appendChild(div);
                });
            },
            openModal: (id) => document.getElementById(id).classList.remove('hidden'),
            closeModal: (id) => document.getElementById(id).classList.add('hidden'),
            toggleMobileMenu: () => document.getElementById('mobileMenu').classList.toggle('hidden'),
            viewImage: (u) => { 
                // Convert to thumbnail URL for display inside the modal (fixes broken image)
                const directUrl = app.getDirectDriveUrl(u);
                document.getElementById('imageViewerSrc').src = directUrl; 
                
                // Keep the original link for "Open Original" in case user wants full res/download
                // If the original URL was already a direct link, use it, otherwise use the converted one
                document.getElementById('imageViewerLink').href = u.includes('drive.google.com') ? u : directUrl; 
                ui.openModal('imageViewerModal'); 
            },
            closeImageModal: () => ui.closeModal('imageViewerModal'),
            renderSettings: () => {
                if(state.currentLedger) document.getElementById('settingLedgerName').innerText = state.currentLedger.name;
                ['expense', 'income'].forEach(t => {
                    const div = document.getElementById(t+'CatList');
                    if(div) div.innerHTML = state.categories[t].map(c => `<span class="inline-flex items-center px-2 py-1 rounded bg-white border border-gray-200 text-xs text-gray-700 shadow-sm gap-1">${c}<button onclick="app.removeCategory('${t}','${c}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button></span>`).join('');
                });
                
                // Render Merchant List in Settings
                const mDiv = document.getElementById('merchantListSetting');
                if (mDiv) {
                    mDiv.innerHTML = state.merchants.map(m => `<span class="inline-flex items-center px-2 py-1 rounded bg-white border border-gray-200 text-xs text-gray-700 shadow-sm gap-1">${m}<button onclick="app.removeMerchant('${m}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button></span>`).join('');
                }
            },
            openSettings: () => {
                ui.renderSettings();
                ui.openModal('settingsModal');
            },
            openUserProfile: () => { ui.openModal('userProfileModal'); document.getElementById('renameInput').value = state.userName; ui.switchProfileTab('overview'); },
            switchProfileTab: (tabName) => { ['overview', 'ai-assistant', 'settings', 'assets'].forEach(t => { const el = document.getElementById(`content-${t}`); const btn = document.getElementById(`tab-${t}`); if(el) el.classList.add('hidden'); if(btn) btn.classList.remove('active'); }); document.getElementById(`content-${tabName}`).classList.remove('hidden'); document.getElementById(`tab-${tabName}`).classList.add('active'); if(tabName === 'overview') app.loadUserStats(); },
            logout: () => { localStorage.removeItem('acc_username'); location.reload(); }
        };

        window.app = app; window.ui = ui; window.ai = ai;
        app.init();
    </script>
</body>
</html>