<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智慧雲端記帳本 (Pro版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- QR Code Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- Excel Export Library (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Markdown Parser for AI Chat -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6;
            width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal Animation */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #imageViewerModal { transition: opacity 0.3s ease; }
        #imageViewerModal.hidden { opacity: 0; pointer-events: none; }
        #imageViewerModal:not(.hidden) { opacity: 1; pointer-events: auto; }
        
        .archived-ledger { filter: grayscale(1); opacity: 0.7; }
        .archived-ledger:hover { filter: grayscale(0); opacity: 1; }

        /* Item Row Animation */
        .item-row { transition: all 0.2s; }
        .item-row:hover { background-color: #f8fafc; }
        
        /* Category Chips */
        .cat-chip { transition: all 0.2s; }
        .cat-chip:hover { transform: scale(1.05); }

        /* Tab Styles */
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: bold; }
        
        /* Custom Details Marker */
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }

        /* Grouped Transaction Styles */
        .tx-group-header { cursor: pointer; transition: background-color 0.2s; }
        .tx-group-header:hover { background-color: #f0f9ff; }
        .tx-detail-row { background-color: #f8fafc; animation: fadeIn 0.2s ease-out; }

        /* Chart Mode Buttons */
        .chart-mode-btn { transition: all 0.2s; }
        .chart-mode-btn.active { background-color: #4f46e5; color: white; }

        /* Icon Selector Radio */
        .icon-radio:checked + label { background-color: #dbeafe; border-color: #3b82f6; }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-800 text-white flex flex-col shadow-xl z-20 hidden md:flex">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-wallet text-emerald-400"></i> AI 雲端記帳
            </h1>
            <!-- User Profile Trigger -->
            <div id="currentUserDisplay" class="mt-6 p-3 bg-slate-700/50 rounded-xl cursor-pointer hover:bg-slate-700 transition group" onclick="ui.openUserProfile()">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-lg">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-bold text-white group-hover:text-emerald-300 transition truncate"><span id="sidebarUserName">未登入</span></p>
                        <p class="text-xs text-slate-400">設定 / 切換</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 flex-1 overflow-y-auto">
            <div class="flex justify-between items-center mb-4 text-slate-400 text-sm font-bold uppercase">
                <span>我的帳本</span>
                <button onclick="ui.openLedgerModal('create')" class="hover:text-white transition"><i class="fa-solid fa-plus"></i></button>
            </div>
            <ul id="ledgerList" class="space-y-2"></ul>
            
            <div id="archivedSection" class="mt-6 hidden">
                <div class="text-xs text-slate-500 font-bold uppercase mb-2 border-t border-slate-700 pt-4">已歸檔 / 結算</div>
                <ul id="archivedLedgerList" class="space-y-2"></ul>
            </div>
        </div>

        <div class="p-4 border-t border-slate-700 space-y-2">
            <!-- Import Excel Button (New) -->
            <button onclick="ui.openModal('importModal')" class="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-700 transition text-slate-300 hover:text-white">
                <i class="fa-solid fa-file-import text-emerald-400"></i> 匯入 Excel
            </button>
            <button onclick="ui.openSettings()" class="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-700 transition text-slate-300 hover:text-white">
                <i class="fa-solid fa-gear"></i> 系統設定
            </button>
            <button onclick="ui.logout()" class="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-700 transition text-slate-300 hover:text-white">
                <i class="fa-solid fa-right-from-bracket"></i> 登出
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-y-auto">
        <header class="bg-white p-4 shadow-sm flex justify-between items-center md:hidden sticky top-0 z-30">
            <h1 class="font-bold text-lg"><i class="fa-solid fa-wallet text-emerald-500"></i> 記帳本</h1>
            <button onclick="ui.toggleMobileMenu()" class="text-gray-600"><i class="fa-solid fa-bars text-xl"></i></button>
        </header>

        <!-- Top Control Bar: Optimized for Mobile -->
        <div class="bg-white border-b border-gray-200 p-4 md:p-6 flex flex-col md:flex-row md:justify-between md:items-center gap-4 sticky top-0 z-20 shadow-sm md:static">
            
            <!-- Left Side: Title & Info -->
            <div class="flex flex-col gap-1">
                <div class="flex items-center justify-between md:justify-start gap-3">
                    <h2 id="currentLedgerTitle" class="text-xl md:text-2xl font-bold text-gray-800 truncate max-w-[200px] md:max-w-md">載入中...</h2>
                </div>
                <div class="flex items-center gap-2">
                    <span id="ledgerTypeBadge" class="hidden px-2 py-0.5 rounded text-xs font-bold bg-blue-100 text-blue-700">個人</span>
                    <span id="ledgerStatusBadge" class="hidden px-2 py-0.5 rounded text-xs font-bold bg-gray-200 text-gray-600">已歸檔</span>
                    <p id="ledgerMembers" class="text-gray-500 text-xs md:text-sm hidden truncate max-w-[250px]"></p>
                </div>
            </div>

            <!-- Right Side: Actions (Wrapped for mobile) -->
            <div class="flex flex-wrap items-center gap-2 justify-end">
                <!-- Date Filters -->
                <div class="flex bg-gray-100 rounded-lg p-1" id="globalDateFilter">
                    <select id="ledgerYear" class="bg-transparent text-sm font-bold text-gray-700 p-1 outline-none max-w-[70px]" onchange="app.updateLedgerView()"></select>
                    <div class="w-[1px] bg-gray-300 my-1"></div>
                    <select id="ledgerMonth" class="bg-transparent text-sm font-bold text-gray-700 p-1 outline-none" onchange="app.updateLedgerView()">
                        <option value="all">全年</option>
                        <option value="01">1月</option><option value="02">2月</option><option value="03">3月</option>
                        <option value="04">4月</option><option value="05">5月</option><option value="06">6月</option>
                        <option value="07">7月</option><option value="08">8月</option><option value="09">9月</option>
                        <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <button id="settleBtn" onclick="app.calculateDebt()" class="hidden bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-lg shadow transition flex items-center gap-1 font-medium text-xs md:text-sm">
                        <i class="fa-solid fa-calculator"></i> <span class="hidden sm:inline">分帳</span>
                    </button>
                    
                    <button onclick="ui.openRecurringModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg shadow transition flex items-center gap-1 font-medium text-xs md:text-sm">
                        <i class="fa-solid fa-calendar-check"></i> <span class="hidden sm:inline">固定</span>
                    </button>

                    <button id="addTxBtn" onclick="ui.openTransactionModal()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow transition flex items-center gap-1 font-medium text-xs md:text-sm">
                        <i class="fa-solid fa-plus"></i> 記一筆
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Cards -->
        <div class="p-4 grid grid-cols-3 gap-2 md:gap-6">
            <div class="bg-white p-2 md:p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                <p class="text-gray-500 text-[10px] md:text-xs font-bold uppercase mb-1">總支出</p>
                <p id="totalExpense" class="text-base md:text-3xl font-bold text-rose-600">$0</p>
            </div>
            <div class="bg-white p-2 md:p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                <p class="text-gray-500 text-[10px] md:text-xs font-bold uppercase mb-1">總收入</p>
                <p id="totalIncome" class="text-base md:text-3xl font-bold text-emerald-600">$0</p>
            </div>
            <div class="bg-white p-2 md:p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                <p class="text-gray-500 text-[10px] md:text-xs font-bold uppercase mb-1">結餘</p>
                <p id="totalBalance" class="text-base md:text-3xl font-bold text-blue-600">$0</p>
            </div>
        </div>

        <!-- UPDATED: Collapsible In-Ledger Analysis Section with Merchant Stats -->
        <div class="px-4 md:px-6 py-2 md:py-4">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <!-- Header / Toggle -->
                <div class="p-4 bg-gray-50 cursor-pointer flex justify-between items-center hover:bg-gray-100 transition" onclick="ui.toggleStatsSection()">
                    <h3 class="font-bold text-gray-700 text-sm flex items-center gap-2">
                        <i class="fa-solid fa-chart-pie text-blue-500"></i> 收支與商店分析
                    </h3>
                    <i id="statsToggleIcon" class="fa-solid fa-chevron-down text-gray-400 transition-transform"></i>
                </div>
                
                <!-- Content (Default Hidden) -->
                <div id="statsContent" class="hidden p-4 border-t border-gray-100">
                    <div class="flex gap-4 overflow-x-auto pb-2">
                        <!-- Expense Categories -->
                        <div class="flex-1 min-w-[250px] md:min-w-[300px]">
                            <h4 class="text-xs font-bold text-rose-500 uppercase mb-2 border-b border-rose-100 pb-1">消費統計 (依類別)</h4>
                            <div id="topExpenseList" class="space-y-2"></div>
                        </div>
                        <!-- Merchant Stats (New) -->
                        <div class="flex-1 min-w-[250px] md:min-w-[300px]">
                            <h4 class="text-xs font-bold text-blue-500 uppercase mb-2 border-b border-blue-100 pb-1">商店/對象消費統計</h4>
                            <div id="topMerchantList" class="space-y-2"></div>
                        </div>
                        <!-- Income Categories -->
                        <div class="flex-1 min-w-[250px] md:min-w-[300px]">
                            <h4 class="text-xs font-bold text-emerald-500 uppercase mb-2 border-b border-emerald-100 pb-1">收入來源 (依類別)</h4>
                            <div id="topIncomeList" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- List -->
        <div class="flex-1 p-4 md:p-6 pt-0">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-[500px] md:h-[600px]">
                <div class="p-3 md:p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-gray-700 text-sm md:text-base" id="listHeaderTitle">交易紀錄</h3>
                    <div class="flex items-center gap-2">
                          <button id="bulkDeleteBtn" onclick="app.deleteSelected()" class="hidden text-xs bg-red-100 hover:bg-red-200 text-red-600 px-2 py-1 rounded font-bold transition flex items-center gap-1">
                             <i class="fa-solid fa-trash-can"></i> <span class="hidden md:inline">刪除</span>(<span id="selectedCount">0</span>)
                          </button>
                          
                          <!-- List Export Button -->
                          <button onclick="app.exportCurrentList()" class="text-xs bg-emerald-100 hover:bg-emerald-200 text-emerald-700 px-2 py-1 rounded font-bold transition flex items-center gap-1">
                             <i class="fa-solid fa-file-export"></i> <span class="hidden md:inline">匯出</span>
                          </button>

                          <button id="clearFilterBtn" onclick="app.clearDateFilter()" class="hidden text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-600"><i class="fa-solid fa-filter-circle-xmark"></i></button>
                        <div id="loadingIndicator" class="hidden flex items-center gap-1 text-xs text-gray-500">
                            <div class="loader w-4 h-4"></div> <span class="hidden md:inline">同步中...</span>
                        </div>
                    </div>
                </div>
                <div class="overflow-y-auto flex-1 relative">
                    <table class="w-full text-left border-collapse">
                        <thead class="sticky top-0 bg-gray-50 z-10 shadow-sm">
                            <tr class="text-gray-500 text-xs md:text-sm border-b border-gray-100">
                                <!-- Hide Checkbox on Mobile -->
                                <th class="hidden md:table-cell p-2 md:p-4 w-10 text-center"><input type="checkbox" id="selectAllTx" onchange="ui.toggleSelectAll(this)" class="w-4 h-4 cursor-pointer"></th>
                                <th class="p-2 md:p-4 font-medium w-24 md:w-32">日期</th>
                                <th class="p-2 md:p-4 font-medium">項目</th>
                                <th class="p-2 md:p-4 font-medium text-right w-24 md:w-32">金額</th>
                                <th class="p-2 md:p-4 font-medium text-center w-8 md:w-16"></th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <tr><td colspan="5" class="p-8 text-center text-gray-400">尚未選擇帳本或無資料</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Generic Confirmation Modal (NEW) -->
    <div id="confirmModal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm m-4 animate-fade-in text-center">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-2xl">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2" id="confirmTitle">確認刪除？</h3>
            <p class="text-gray-500 text-sm mb-6" id="confirmMessage">此動作無法復原。</p>
            <div class="flex gap-3 justify-center">
                <button onclick="ui.closeModal('confirmModal')" class="px-5 py-2.5 rounded-lg border border-gray-300 text-gray-600 font-bold text-sm hover:bg-gray-50">取消</button>
                <button id="confirmBtnAction" class="px-5 py-2.5 rounded-lg bg-red-600 text-white font-bold text-sm hover:bg-red-700 shadow-md">確認刪除</button>
            </div>
        </div>
    </div>

    <!-- Modal: Create/Edit Ledger -->
    <div id="ledgerModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 m-4 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="ledgerModalTitle">📘 建立新帳本</h3>
                <button onclick="ui.closeModal('ledgerModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="editingLedgerId">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">選擇圖示</label>
                    <div class="flex gap-2 overflow-x-auto pb-2" id="iconSelector">
                        <!-- Icons will be injected here -->
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">帳本名稱</label>
                    <input type="text" id="newLedgerName" placeholder="例如：2024日本遊、公司報帳..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">類型</label>
                        <select id="newLedgerType" class="w-full p-3 border border-gray-300 rounded-lg bg-white text-sm" onchange="ui.toggleMemberInput()">
                            <option value="personal">個人帳本</option>
                            <option value="group">多人共用</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">預設幣別</label>
                        <select id="newLedgerCurrency" class="w-full p-3 border border-gray-300 rounded-lg bg-white text-sm currency-select">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>
                <div id="memberInputDiv" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">選擇成員</label>
                    <div id="memberSelectionList" class="max-h-32 overflow-y-auto border border-gray-300 rounded p-2 bg-gray-50 grid grid-cols-2 gap-2 text-sm">
                        <!-- Checkboxes will be injected here -->
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1"><i class="fa-solid fa-circle-info"></i> 僅顯示已建立的使用者。</p>
                </div>
                <button onclick="app.saveLedger()" id="btnSaveLedger" class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-lg mt-2">建立/儲存</button>
            </div>
        </div>
    </div>

    <!-- Modal: Image Viewer -->
    <div id="imageViewerModal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center" onclick="ui.closeImageModal()">
        <div class="relative max-w-4xl max-h-[90vh] p-2" onclick="event.stopPropagation()">
            <button onclick="ui.closeImageModal()" class="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300 transition"><i class="fa-solid fa-times"></i></button>
            <img id="imageViewerSrc" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl border-2 border-gray-800" src="" referrerpolicy="no-referrer" onerror="this.src='https://placehold.co/600x400?text=Image+Load+Error'">
            <div class="text-center mt-4"><a id="imageViewerLink" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm underline"><i class="fa-solid fa-external-link-alt"></i> 開啟原圖</a></div>
        </div>
    </div>

    <!-- Modal: Login / User Select -->
    <div id="loginModal" class="fixed inset-0 bg-slate-900/95 z-[90] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-8 m-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl"><i class="fa-solid fa-user-group"></i></div>
                <h3 class="text-xl font-bold text-gray-800">請選擇您的身分</h3>
                <p class="text-gray-500 text-sm">多人帳本將依據此身分進行分帳</p>
            </div>

            <!-- Existing User Select -->
            <div id="existingUserSection" class="mb-6 space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">選擇現有角色</label>
                    <select id="loginUserSelect" class="w-full p-3 border border-gray-300 rounded-lg mb-2 bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">載入中...</option>
                    </select>
                </div>
                <div>
                    <input type="password" id="loginPasswordInput" placeholder="請輸入密碼 (舊用戶若無則留空)" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="app.loginExistingUser()" class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold transition">登入</button>
            </div>

            <div class="relative flex py-2 items-center mb-6">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">或</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <!-- Create New User -->
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">建立新角色</label>
                <div class="space-y-2">
                    <input type="text" id="newUserNameInput" placeholder="輸入新暱稱" class="w-full p-3 border border-gray-300 rounded-lg text-sm">
                    <input type="password" id="newUserNamePassword" placeholder="設定登入密碼" class="w-full p-3 border border-gray-300 rounded-lg text-sm">
                    <button onclick="app.registerNewUser()" class="w-full bg-gray-800 text-white py-3 rounded-lg hover:bg-gray-900 transition font-bold">建立並登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: User Profile & Rename -->
    <div id="userProfileModal" class="fixed inset-0 bg-slate-900/90 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl p-6 m-4 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-id-card text-indigo-500"></i> 個人中心</h3>
                <button onclick="ui.closeModal('userProfileModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>

            <!-- Tabs -->
            <div class="flex gap-4 border-b border-gray-200 mb-4 overflow-x-auto">
                <button onclick="ui.switchProfileTab('overview')" id="tab-overview" class="tab-btn active px-2 py-2 text-sm text-gray-600 hover:text-blue-600 transition whitespace-nowrap">帳本概況</button>
                <button onclick="ui.switchProfileTab('assets')" id="tab-assets" class="tab-btn px-2 py-2 text-sm text-gray-600 hover:text-blue-600 transition whitespace-nowrap">我的資產</button>
                <button onclick="ui.switchProfileTab('ai-assistant')" id="tab-ai-assistant" class="tab-btn px-2 py-2 text-sm text-gray-600 hover:text-blue-600 transition whitespace-nowrap">AI 帳務助理</button>
                <button onclick="ui.switchProfileTab('settings')" id="tab-settings" class="tab-btn px-2 py-2 text-sm text-gray-600 hover:text-blue-600 transition whitespace-nowrap">個人設定</button>
            </div>

            <div class="overflow-y-auto flex-1 pr-2">
                <!-- TAB 1: Overview -->
                <div id="content-overview">
                    <div class="flex flex-wrap items-center gap-3 mb-4 bg-gray-50 p-3 rounded-xl sticky top-0 z-10 shadow-sm">
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-bold text-gray-500">年份</label>
                            <select id="statYear" class="p-1.5 border border-gray-300 rounded text-sm" onchange="app.loadUserStats()"></select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-bold text-gray-500">月份</label>
                            <select id="statMonth" class="p-1.5 border border-gray-300 rounded text-sm" onchange="app.loadUserStats()">
                                <option value="all">全年</option>
                                <option value="01">1月</option><option value="02">2月</option><option value="03">3月</option>
                                <option value="04">4月</option><option value="05">5月</option><option value="06">6月</option>
                                <option value="07">7月</option><option value="08">8月</option><option value="09">9月</option>
                                <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-auto">
                            <input type="checkbox" id="showDetailsCheck" class="w-4 h-4 text-blue-600 rounded" onchange="app.loadUserStats()">
                            <label for="showDetailsCheck" class="text-sm text-gray-600 select-none cursor-pointer">顯示詳細統計</label>
                        </div>
                        <button onclick="app.exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1 shadow-sm">
                            <i class="fa-solid fa-file-excel"></i> 匯出Excel
                        </button>
                    </div>
                    <div id="statsLoader" class="hidden text-center py-10 text-gray-500"><div class="loader mx-auto mb-2"></div>數據分析中...</div>
                    <div id="ledgerStatsContainer" class="space-y-4"></div>
                </div>

                <!-- TAB 2: Assets (New) -->
                <div id="content-assets" class="hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-5 text-white mb-6 shadow-lg">
                        <p class="text-blue-100 text-sm mb-1">個人資產總計</p>
                        <h2 class="text-3xl font-bold" id="totalAssetDisplay">$0</h2>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                        <h4 class="font-bold text-gray-700 mb-3 text-sm" id="assetActionTitle">新增 / 更新資產</h4>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="assetNameInput" list="assetNamesList" placeholder="帳戶名稱 (如: 玉山銀行)" class="flex-1 p-2 border border-gray-300 rounded text-sm">
                            <datalist id="assetNamesList"></datalist>
                            <input type="number" id="assetBalanceInput" placeholder="目前金額" class="w-1/3 p-2 border border-gray-300 rounded text-sm">
                        </div>
                        <button onclick="app.saveAsset()" class="w-full bg-slate-800 text-white py-2 rounded text-sm font-bold hover:bg-slate-900 transition">更新餘額</button>
                        <p class="text-xs text-gray-400 mt-2">* 若名稱相同則會更新餘額並記錄歷史。</p>
                    </div>

                    <h4 class="font-bold text-gray-700 mb-3 text-sm border-b border-gray-200 pb-2">資產列表</h4>
                    <div id="assetsList" class="space-y-3">
                        <div class="text-center text-gray-400 py-4 text-sm">暫無資產紀錄</div>
                    </div>
                </div>

                <!-- TAB 3: AI Assistant -->
                <div id="content-ai-assistant" class="hidden h-full flex flex-col">
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4 flex-1 flex flex-col min-h-[300px]">
                        <div class="text-center mb-4">
                            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-2 text-indigo-600 text-xl"><i class="fa-solid fa-robot"></i></div>
                            <h4 class="font-bold text-indigo-900">AI 帳務助理</h4>
                            <p class="text-xs text-indigo-500">我可以根據您的帳本資料回答問題，例如：「上個月餐費多少？」、「哪個帳本花最兇？」</p>
                        </div>
                        <div id="aiChatHistory" class="flex-1 overflow-y-auto space-y-3 mb-3 p-2 bg-white/50 rounded-lg max-h-[300px]">
                            <div class="text-xs text-gray-400 text-center italic">-- 對話紀錄 --</div>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="aiChatInput" placeholder="輸入您的問題..." class="flex-1 p-3 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm" onkeypress="if(event.key==='Enter') app.askAI()">
                            <button onclick="app.askAI()" id="btnAiSend" class="bg-indigo-600 text-white px-4 rounded-lg hover:bg-indigo-700 transition"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: Settings -->
                <div id="content-settings" class="hidden">
                    <div class="bg-gray-50 p-5 rounded-xl border border-gray-100 mb-4">
                        <label class="block text-xs font-bold text-gray-800 uppercase mb-2">修改顯示名稱</label>
                        <div class="flex gap-2">
                            <input type="text" id="renameInput" placeholder="輸入新名稱" class="flex-1 p-3 border border-gray-300 rounded-lg font-bold text-gray-700">
                            <button onclick="app.renameUser()" id="renameBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-6 rounded-lg font-bold transition whitespace-nowrap">確認</button>
                        </div>
                        <p class="text-xs text-gray-400 mt-2"><i class="fa-solid fa-circle-exclamation"></i> 這會更新所有帳本中的顯示名稱。</p>
                    </div>

                    <div class="bg-yellow-50 p-5 rounded-xl border border-yellow-100">
                        <label class="block text-xs font-bold text-yellow-800 uppercase mb-2">重設登入密碼</label>
                        <div class="flex gap-2 items-center">
                            <button onclick="app.changeUserPassword()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg font-bold transition whitespace-nowrap">立即重設密碼</button>
                            <span class="text-xs text-yellow-600">忘記密碼請重設，無需舊密碼</span>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h4 class="font-bold text-gray-700 mb-2">幣別管理</h4>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="newCurrencyCode" placeholder="ISO代碼 (如 HKD)" class="flex-1 p-2 border border-gray-300 rounded text-sm uppercase" maxlength="3">
                                <button onclick="app.addCurrency()" class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <div id="currencyListSetting" class="flex flex-wrap gap-2"></div>
                            <p class="text-[10px] text-gray-500 mt-2">* 系統會自動抓取新增幣別的線上匯率。</p>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h4 class="font-bold text-gray-700 mb-2">常用商店管理</h4>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="newMerchantName" placeholder="商店名稱" class="flex-1 p-2 border border-gray-300 rounded text-sm">
                                <button onclick="app.addMerchant()" class="bg-blue-600 text-white px-3 rounded hover:bg-blue-700"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <div id="merchantListSetting" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <div class="mt-8 text-center">
                         <button onclick="ui.logout()" class="text-sm text-red-500 hover:underline"><i class="fa-solid fa-right-from-bracket"></i> 登出/切換帳號</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Settlement & Archive -->
    <div id="settleModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 m-4 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">💰 結算分帳</h3>
                <button onclick="ui.closeModal('settleModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="settleContent" class="space-y-4 mb-6"></div>
            <div class="border-t border-gray-100 pt-4 bg-yellow-50 p-4 rounded-lg">
                <h4 class="font-bold text-gray-700 mb-2 flex items-center gap-2"><i class="fa-solid fa-box-archive text-yellow-600"></i> 結算並歸檔</h4>
                <p class="text-xs text-gray-500 mb-3">將此帳本封存，並將您的應付金額 ($<span id="settleShareAmount">0</span>) 記錄到個人帳本。</p>
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-500 mb-1">選擇要記入的個人帳本</label>
                    <select id="targetPersonalLedger" class="w-full p-2 border border-gray-300 rounded text-sm bg-white"></select>
                </div>
                <button onclick="app.archiveLedger()" class="w-full py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm font-bold shadow">確認歸檔並記帳</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Import Excel -->
    <div id="importModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 m-4 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-file-import text-emerald-500"></i> 匯入 Excel 紀錄
                </h3>
                <button onclick="ui.closeModal('importModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-6">
                <!-- Step 1: Download Template -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h4 class="font-bold text-blue-800 mb-2 text-sm">步驟 1：下載標準範本</h4>
                    <p class="text-xs text-blue-600 mb-3">請先下載 Excel 範本，並依照格式填入您的舊帳本資料。</p>
                    <button onclick="app.downloadTemplate()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-2">
                        <i class="fa-solid fa-download"></i> 下載 Excel 範本 (.xlsx)
                    </button>
                </div>

                <!-- Step 2: Upload File -->
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-emerald-400 transition relative bg-gray-50 group">
                    <input type="file" id="importFile" accept=".xlsx, .xls, .csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="app.handleFileSelect(this)">
                    <div id="importPlaceholder">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-500 text-2xl group-hover:bg-emerald-100 group-hover:text-emerald-500 transition">
                            <i class="fa-solid fa-upload"></i>
                        </div>
                        <p class="font-bold text-gray-600">點擊或拖曳檔案至此</p>
                        <p class="text-xs text-gray-400 mt-1">支援格式: .xlsx, .csv</p>
                    </div>
                    <div id="importFileDisplay" class="hidden">
                        <p class="font-bold text-emerald-600 mb-1" id="importFileName"></p>
                        <p class="text-xs text-gray-500">已準備好匯入</p>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-3 justify-end">
                    <button onclick="ui.closeModal('importModal')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-bold">取消</button>
                    <button onclick="app.processImport()" id="btnStartImport" class="px-6 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-bold shadow disabled:opacity-50 disabled:cursor-not-allowed">
                        開始匯入
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Settings -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 m-4 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">⚙️ 系統設定</h3>
                <button onclick="ui.closeModal('settingsModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <label class="block text-sm font-bold text-blue-800 mb-1">Google Drive 上傳網址</label>
                    <input type="text" id="scriptUrlInput" placeholder="https://script.google.com/macros/s/..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-xs font-mono">
                </div>
                <div>
                    <label id="apiKeyLabel" class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key</label>
                    <input type="password" id="geminiKeyInput" placeholder="貼上您的 API Key" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">自訂 AI 辨識提示詞 (選填)</label>
                    <textarea id="aiPromptInput" rows="2" placeholder="例如：請將『拿鐵』分類為『娛樂』。遇到全家便利商店請自動帶入商店名稱。" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                    <p class="text-xs text-gray-400 mt-1">您可以輸入特定規則來引導 AI 辨識收據內容。</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Firebase Config (已鎖定)</label>
                    <textarea id="firebaseConfigInput" rows="4" readonly class="w-full p-3 border border-gray-300 bg-gray-100 rounded-lg font-mono text-xs text-gray-600 cursor-not-allowed"></textarea>
                </div>
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <h4 class="font-bold text-gray-700 mb-2">當前帳本設定 (<span id="settingLedgerName"></span>)</h4>
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg flex-wrap gap-2">
                        <span class="text-sm text-gray-600 w-full sm:w-auto">密碼保護</span>
                        <div class="flex gap-2">
                            <button onclick="app.setLedgerPassword()" class="text-sm text-blue-500 hover:text-blue-700 font-bold border border-blue-200 px-3 py-1 rounded hover:bg-blue-50 transition"><i class="fa-solid fa-key"></i> 修改/設定密碼</button>
                            <button onclick="app.removeLedgerPassword()" class="text-sm text-red-500 hover:text-red-700 font-bold border border-red-200 px-3 py-1 rounded hover:bg-red-50 transition"><i class="fa-solid fa-unlock"></i> 解除密碼</button>
                        </div>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <h4 class="font-bold text-gray-700 mb-2">自訂分類管理</h4>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex gap-2 mb-2">
                            <select id="newCatType" class="p-2 border border-gray-300 rounded text-sm"><option value="expense">支出</option><option value="income">收入</option></select>
                            <input type="text" id="newCatName" placeholder="新分類名稱" class="flex-1 p-2 border border-gray-300 rounded text-sm">
                            <button onclick="app.addCategory()" class="bg-emerald-600 text-white px-3 rounded hover:bg-emerald-700"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div><p class="text-xs font-bold text-rose-500 mb-1">支出類別</p><div id="expenseCatList" class="flex flex-wrap gap-2"></div></div>
                            <div><p class="text-xs font-bold text-emerald-500 mb-1">收入類別</p><div id="incomeCatList" class="flex flex-wrap gap-2"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button onclick="ui.closeModal('settingsModal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">取消</button>
                <button onclick="app.saveSettings()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">儲存設定</button>
            </div>
        </div>
    </div>

    <!-- Modal: Recurring Rules -->
    <div id="recurringModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 m-4 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="recurringModalTitle">📅 固定收支設定</h3>
                <button onclick="ui.closeModal('recurringModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>

            <!-- List Section -->
            <div id="recurringListSection">
                <div id="recurringRulesList" class="space-y-3 mb-4">
                    <!-- Rules will be injected here -->
                </div>
                <button id="btnAddRecurring" onclick="ui.toggleRecurringForm(true)" class="w-full py-3 border-2 border-dashed border-purple-300 text-purple-500 rounded-lg font-bold hover:bg-purple-50 transition">
                    <i class="fa-solid fa-plus"></i> 新增固定規則
                </button>
            </div>

            <!-- Form Section (Hidden by default) -->
            <form id="recurringFormSection" class="hidden space-y-4" onsubmit="app.saveRecurringRule(event)">
                <div class="flex justify-between items-center border-b pb-2 mb-2">
                    <h4 class="font-bold text-gray-700" id="recurringFormTitle">新增規則</h4>
                    <button type="button" onclick="ui.toggleRecurringForm(false)" class="text-sm text-gray-500 hover:text-gray-700">取消</button>
                </div>
                <input type="hidden" id="recRuleId">
                <div class="flex items-center gap-2 mb-2 bg-purple-50 p-2 rounded-lg">
                    <input type="checkbox" id="recAuto" class="w-4 h-4 text-purple-600 rounded cursor-pointer" checked>
                    <label for="recAuto" class="text-sm text-purple-900 font-bold cursor-pointer select-none">自動入帳 (開啟 App 時自動補記)</label>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">類型</label>
                        <select id="recType" class="w-full p-2 border border-gray-300 rounded-lg text-sm" onchange="ui.updateCategoriesForRecurring()">
                            <option value="expense">支出</option>
                            <option value="income">收入</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">頻率</label>
                        <select id="recFreq" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                            <option value="monthly">每月</option>
                            <option value="yearly">每年</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">項目名稱</label>
                    <input type="text" id="recName" required placeholder="例如：房租、Netflix..." class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">金額 (TWD)</label>
                        <input type="number" id="recAmount" required placeholder="0" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">分類</label>
                        <select id="recCategory" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                            <!-- Categories injected by JS -->
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">下次到期日</label>
                        <input type="date" id="recNextDate" required class="w-full p-2 border border-gray-300 rounded-lg text-sm cursor-pointer">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">結束日期 (選填)</label>
                        <input type="date" id="recEndDate" class="w-full p-2 border border-gray-300 rounded-lg text-sm cursor-pointer text-gray-600">
                    </div>
                </div>
                <button type="submit" class="w-full py-3 bg-purple-600 text-white rounded-lg font-bold shadow hover:bg-purple-700 transition">儲存設定</button>
            </form>
        </div>
    </div>

    <!-- TRANSACTION MODAL -->
    <div id="transactionModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-start md:items-center justify-center backdrop-blur-sm pt-10 md:pt-0">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-4 md:p-6 m-4 overflow-y-auto max-h-[85vh] md:max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="txModalTitle">📝 新增紀錄</h3>
                <button onclick="ui.closeModal('transactionModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="uploadContainer" class="mb-4 bg-indigo-50 border border-indigo-100 rounded-xl p-3 text-center relative group">
                <div id="uploadZone">
                    <input type="file" id="receiptUpload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="ai.handleImageUpload(this)">
                    <div id="aiUploadLabel">
                        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-2 text-indigo-500 text-2xl group-hover:scale-110 transition"><i class="fa-solid fa-camera"></i></div>
                        <p class="text-sm font-bold text-indigo-800">拍照或上傳收據</p>
                        <p class="text-xs text-indigo-500 mt-1">AI 自動掃描品項 (支援電子發票)</p>
                    </div>
                </div>
                <div id="aiLoading" class="hidden relative z-20 mt-2 py-4"><div class="loader mx-auto mb-2 border-indigo-500 border-t-transparent"></div><p class="text-sm font-bold text-indigo-600 animate-pulse" id="aiStatusText">AI 正在辨識收據內容...</p></div>
                <div id="imagePreviewContainer" class="hidden mt-2 relative z-10"><img id="imagePreview" class="h-32 mx-auto rounded object-contain mb-2 border border-gray-200 shadow"><button type="button" onclick="ai.clearImage()" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-600 text-xs rounded-full font-bold transition">清除重選</button></div>
            </div>
            <div id="editHistoryBox" class="hidden mb-4 p-3 bg-gray-50 border border-gray-200 rounded-lg text-xs text-gray-500"><p class="font-bold mb-1">修訂紀錄：</p><ul id="editHistoryList" class="list-disc pl-4 space-y-1"></ul></div>
            <form id="transactionForm" onsubmit="app.addTransaction(event)" class="space-y-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">類型</label><select id="tType" class="w-full p-2 bg-white border border-gray-200 rounded-lg text-sm" onchange="ui.updateCategoriesForRows()"><option value="expense">支出</option><option value="income">收入</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">日期</label><input type="date" id="tDate" required class="w-full p-2 bg-white border border-gray-200 rounded-lg text-sm cursor-pointer hover:bg-gray-50"></div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">商店/對象 (選填)</label>
                        <div class="relative">
                            <input type="text" id="tMerchant" autocomplete="off" placeholder="輸入或選擇..." 
                                   class="w-full p-2 bg-white border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                   onfocus="ui.showMerchantList()" 
                                   oninput="ui.filterMerchantList(this.value)"
                                   onblur="setTimeout(()=>document.getElementById('customMerchantList').classList.add('hidden'), 200)">
                            
                            <div class="absolute right-3 top-2.5 text-gray-400 pointer-events-none">
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>

                            <div id="customMerchantList" class="hidden absolute top-full left-0 w-full max-h-60 overflow-y-auto bg-white border border-gray-200 rounded-lg shadow-xl z-50 mt-1">
                            </div>
                        </div>
                    </div>
                    <div id="groupPayerField" class="hidden col-span-2 md:col-span-2"><label class="block text-xs font-bold text-yellow-700 uppercase mb-1">先墊錢的人</label><select id="tPaidBy" class="w-full p-2 bg-white border border-yellow-200 rounded-lg text-sm"></select></div>
                    
                    <div class="col-span-2 md:col-span-4 bg-yellow-50 p-2 rounded-lg border border-yellow-100 transition-all" id="currencyWrapper">
                        <div id="currencyViewMode" class="flex items-center justify-between cursor-pointer" onclick="ui.toggleCurrencyEdit(true)">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-yellow-700">幣別</span>
                                <span id="currencyViewText" class="text-sm font-bold text-gray-700">TWD (匯率: 1)</span>
                            </div>
                            <i class="fa-solid fa-pen text-yellow-600 text-xs"></i>
                        </div>
                        <div id="currencyEditMode" class="hidden flex gap-2 items-center mt-2">
                            <label class="whitespace-nowrap text-xs font-bold text-yellow-700">修改</label>
                            <select id="tCurrency" class="w-24 p-1.5 bg-white border border-yellow-200 rounded text-sm currency-select" onchange="app.updateRate()">
                                <!-- Populated by JS -->
                            </select>
                            <input type="number" id="tRate" step="0.0001" placeholder="匯率" class="w-20 p-1.5 bg-white border border-yellow-200 rounded text-sm" oninput="app.calcTwd()">
                            <span id="rateHint" class="text-xs text-yellow-600"></span>
                            <button type="button" class="ml-auto text-xs text-gray-400 hover:text-gray-600" onclick="ui.toggleCurrencyEdit(false)"><i class="fa-solid fa-check"></i> 完成</button>
                        </div>
                    </div>

                    <div id="splitSection" class="col-span-2 md:col-span-4 hidden transition-all duration-300 ease-in-out">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 flex justify-between items-center">
                            <span>分攤給誰 (預設全員)</span>
                            <span class="text-[10px] text-blue-500 cursor-pointer hover:underline" onclick="ui.toggleAllSplit(true)">全選</span>
                        </label>
                        <div class="flex flex-wrap gap-2 bg-gray-50 p-2 border border-gray-200 rounded-lg max-h-24 overflow-y-auto" id="splitUserContainer">
                        </div>
                    </div>
                </div>
                <div class="border rounded-xl overflow-hidden border-gray-200">
                    <div class="bg-gray-100 p-2 grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 text-center"><div class="col-span-5 text-left pl-2">項目名稱</div><div class="col-span-3">分類</div><div class="col-span-3">金額</div><div class="col-span-1"></div></div>
                    <div id="transactionItemsList" class="max-h-60 overflow-y-auto"></div>
                    <div class="p-2 bg-gray-50 border-t border-gray-200"><button type="button" id="btnAddItem" onclick="ui.addItemRow()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-emerald-400 hover:text-emerald-500 transition text-sm font-bold"><i class="fa-solid fa-plus"></i> 新增品項</button></div>
                </div>
                <div class="flex justify-between items-center px-2"><div class="text-sm text-gray-500">共 <span id="itemCount">1</span> 筆項目</div><div class="text-right"><p class="text-xs text-gray-400 mb-1" id="totalLabel">總金額 (TWD)</p><p class="text-3xl font-bold text-emerald-600" id="displayTotal">$0</p><p id="twdPreview" class="text-xs text-gray-400 font-bold hidden">= NT$ <span>0</span></p></div></div>
                <input type="hidden" id="hiddenImageUrl"><input type="hidden" id="editingTxId">
                <div class="pt-2"><button type="submit" id="submitBtn" class="w-full py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-bold shadow-md hover:shadow-lg transition">確認儲存</button></div>
            </form>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="fixed inset-0 bg-slate-900/95 z-40 hidden flex flex-col p-6 md:hidden">
        <div class="flex justify-end mb-6"><button onclick="ui.toggleMobileMenu()" class="text-white text-2xl"><i class="fa-solid fa-times"></i></button></div>
        <div id="mobileLedgerList" class="space-y-4 text-white text-lg font-medium text-center overflow-y-auto max-h-[70vh]"></div>
        <button onclick="ui.openSettings(); ui.toggleMobileMenu()" class="mt-8 w-full py-3 bg-slate-700 text-slate-200 rounded-lg">設定</button>
        <button onclick="ui.logout()" class="mt-4 w-full py-3 bg-red-900/30 text-red-200 rounded-lg hover:bg-red-900/50 transition">登出</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, deleteDoc, doc, updateDoc, setDoc, getDoc, getDocs, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const FIREBASE_CONFIG = { apiKey: "AIzaSyDqFr0ZkTb9ZdYFaf8S95pjJLEezTF4QwQ", authDomain: "mony-a292c.firebaseapp.com", projectId: "mony-a292c", storageBucket: "mony-a292c.firebasestorage.app", messagingSenderId: "1012872104399", appId: "1:1012872104399:web:8289e7b26d846246fdaaba", measurementId: "G-N5RQB4GCZD" };
        
        const DEFAULT_CATEGORIES = { 
            expense: [
                '早餐', '午餐', '晚餐', '飲料', '點心', '食材', 
                '交通', '加油', '停車', '維修',
                '日用', '服飾', '美妝', '3C', 
                '娛樂', '旅遊', '訂閱', '社交',
                '房租', '水電', '網路', '話費',
                '醫療', '保險', '教育', '書籍',
                '親子', '寵物', '孝親', '稅務', '其他'
            ], 
            income: [
                '薪資', '獎金', '兼職', 
                '投資', '股利', '租金', 
                '禮金', '退款', '其他'
            ] 
        };
        const DEFAULT_BANKS = [
            "中華郵政", "台北富邦商業銀行", "中國信託商業銀行", "玉山商業銀行", 
            "永豐商業銀行", "台新國際商業銀行", "凱基商業銀行", "國泰世華商業銀行", 
            "第一商業銀行", "合作金庫", "華南商業銀行", "彰化商業銀行", 
            "遠東國際商業銀行", "星展(台灣)商業銀行"
        ];
        
        const DEFAULT_MERCHANTS = [
            "7-ELEVEN", "全家便利商店", "萊爾富", "OK超商", 
            "全聯福利中心", "家樂福", "大潤發", "好市多", 
            "屈臣氏", "康是美", "寶雅", "蝦皮購物", 
            "麥當勞", "肯德基", "摩斯漢堡", "星巴克", 
            "路易莎", "50嵐", "清心福全", "台灣中油"
        ];

        const ICONS = ["🏠", "🏢", "🍽️", "✈️", "🎮", "💰", "🎁", "🛒", "🏥", "👶", "🚗", "📚", "🐶", "💑", "🌏"];

        const CATEGORY_KEYWORDS = {
            '早餐': ['蛋餅', '吐司', '漢堡', '豆漿', '奶茶', '飯糰', '早餐', '美而美', '三明治'],
            '午餐': ['便當', '自助餐', '午餐', '飯', '麵', '水餃', '丼', '粥'],
            '晚餐': ['晚餐', '火鍋', '壽司', '牛排', '鐵板燒', '熱炒', '麥當勞', '肯德基', '必勝客', '餐廳'],
            '飲料': ['咖啡', '茶', '星巴克', '拿鐵', '飲料', '手搖', '50嵐', '可不可', '烏弄', '麻古'],
            '點心': ['蛋糕', '甜點', '冰', '餅乾', '糖果', '雞排', '滷味', '零食'],
            '食材': ['全聯', '家樂福', '大潤發', '菜市場', '肉', '菜', '蛋', '水果', '好市多'],
            '交通': ['捷運', '公車', '台鐵', '高鐵', 'Uber', '計程車', '車票', '悠遊卡', 'eTag', '過路費'],
            '加油': ['加油', '中油', '全國', '台塑', '95', '92'],
            '停車': ['停車', '停車場'],
            '日用': ['衛生紙', '洗髮', '沐浴', '牙膏', '洗衣', '全聯', '屈臣氏', '康是美', '寶雅', '小北'],
            '娛樂': ['電影', 'Netflix', 'Spotify', 'Youtube', 'Steam', '遊戲', '門票', '好樂迪', '錢櫃', 'KTV'],
            '醫療': ['診所', '掛號', '藥', '醫生', '醫院', '牙醫'],
            '房租': ['房租', '租金'],
            '水電': ['電費', '水費', '瓦斯'],
            '網路': ['網路', '寬頻', '光纖'],
            '話費': ['電話費', '手機費', '中華電信', '遠傳', '台哥大']
        };

        const state = {
            db: null, geminiKey: localStorage.getItem('acc_gemini_key') || 'AIzaSyA2WZwhP-dG_37EEW9MDrlUQ_TG-d1TAdY', scriptUrl: localStorage.getItem('acc_script_url') || 'https://script.google.com/macros/s/AKfycbwNIaGFsgcePv5Sp3jLNZHYMGPDxroDjAez_K2r0L5WihkcC2waA6J5-LwBLjg1gz7Img/exec',
            userName: localStorage.getItem('acc_username') || '', 
            ledgers: [], rawLedgers: [], userPrefs: { favorites: [], orders: {} }, 
            currentLedger: null, transactions: [], allTransactionsCache: [], usersList: [], unsubscribeTrans: null, unsubscribeLedgers: null, isOnline: false, currentImage: null, lastQrData: null, rates: { TWD: 1, JPY: 0.22, USD: 31.5, KRW: 0.024, EUR: 34.5, CNY: 4.4 }, unlockedLedgers: [], pendingLedgerId: null, categories: JSON.parse(localStorage.getItem('acc_custom_categories')) || DEFAULT_CATEGORIES,
            merchants: JSON.parse(localStorage.getItem('acc_custom_merchants')) || DEFAULT_MERCHANTS,
            currencies: JSON.parse(localStorage.getItem('acc_custom_currencies')) || ['TWD', 'JPY', 'USD', 'EUR', 'KRW', 'CNY'],
            filterDay: null,
            customAiPrompt: localStorage.getItem('acc_ai_prompt') || '',
            assets: [], unsubscribeAssets: null,
            chartMode: 'weekly', chartFilters: { selectedYear: new Date().getFullYear(), compareYear: new Date().getFullYear() - 1, selectedYears: [new Date().getFullYear()] },
            currentChartStats: {}, currentListData: [], importFile: null, recurringRules: [], unsubscribeRecurring: null, pwAttempts: 0 
        };

        const app = {
            init: async () => {
                const k = localStorage.getItem('acc_gemini_key');
                if (k && k.endsWith('SW8o')) { localStorage.setItem('acc_gemini_key', 'AIzaSyA2WZwhP-dG_37EEW9MDrlUQ_TG-d1TAdY'); state.geminiKey = 'AIzaSyA2WZwhP-dG_37EEW9MDrlUQ_TG-d1TAdY'; }
                document.getElementById('geminiKeyInput').value = state.geminiKey; document.getElementById('scriptUrlInput').value = state.scriptUrl; document.getElementById('firebaseConfigInput').value = JSON.stringify(FIREBASE_CONFIG, null, 2);
                document.getElementById('aiPromptInput').value = state.customAiPrompt; 
                app.fetchRates(); await app.connectFirebase(FIREBASE_CONFIG); await app.loadGlobalSettings();
                document.getElementById('tDate').valueAsDate = new Date();
                
                const yr = new Date().getFullYear(); 
                const ySel = document.getElementById('ledgerYear');
                let opts = '<option value="all">全部年度</option><option value="last3">近三年</option>';
                for (let i = yr; i >= yr - 5; i--) opts += `<option value="${i}">${i}年</option>`;
                ySel.innerHTML = opts;
                ySel.value = yr;
                
                document.getElementById('ledgerMonth').value = (new Date().getMonth() + 1).toString().padStart(2, '0');
                let statOpts = '';
                for (let i = yr; i >= yr - 5; i--) statOpts += `<option value="${i}">${i}年</option>`;
                document.getElementById('statYear').innerHTML = statOpts;
                document.getElementById('statMonth').value = document.getElementById('ledgerMonth').value;

                if (!state.userName) { 
                    await app.loadUsersList(); 
                    document.getElementById('loginModal').classList.remove('hidden'); 
                } else { 
                    document.getElementById('sidebarUserName').innerText = state.userName; 
                    document.getElementById('renameInput').value = state.userName; 
                    await app.loadUserSettings(); app.listenLedgers(); app.listenAssets(); app.loadUsersList();
                }
            },
            loadUsersList: async () => { try { const q = query(collection(state.db, "users")); const s = await getDocs(q); state.usersList = []; const sl = document.getElementById('loginUserSelect'); sl.innerHTML = '<option value="">請選擇角色...</option>'; s.forEach(d => { state.usersList.push(d.id); sl.innerHTML += `<option value="${d.id}">${d.id}</option>`; }); if (state.usersList.length === 0) document.getElementById('existingUserSection').classList.add('hidden'); } catch (e) { console.error("Login List Error", e); } },
            
            loginExistingUser: async () => { 
                const n = document.getElementById('loginUserSelect').value;
                const p = document.getElementById('loginPasswordInput').value.trim();
                if (!n) return alert("請選擇一個角色");
                try {
                    const userDoc = await getDoc(doc(state.db, "users", n));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.password && userData.password !== p) { return alert("密碼錯誤！"); }
                        app.performLogin(n);
                    } else { alert("用户不存在"); }
                } catch (e) { console.error(e); alert("登入失敗: " + e.message); }
            },
            registerNewUser: async () => { 
                const n = document.getElementById('newUserNameInput').value.trim();
                const p = document.getElementById('newUserNamePassword').value.trim();
                if (!n) return alert("請輸入名稱");
                if (!p) return alert("請設定登入密碼");
                try { 
                    const d = doc(state.db, "users", n); 
                    if ((await getDoc(d)).exists()) return alert("此名稱已存在"); 
                    await setDoc(d, { createdAt: new Date().toISOString(), password: p }); 
                    app.performLogin(n); 
                } catch(e) { alert("註冊失敗: " + e.message); } 
            },
            performLogin: (n) => { state.userName = n; localStorage.setItem('acc_username', n); document.getElementById('sidebarUserName').innerText = n; document.getElementById('renameInput').value = n; document.getElementById('loginModal').classList.add('hidden'); app.loadUserSettings(); app.listenLedgers(); app.listenAssets(); },
            
            changeUserPassword: async () => {
                const newPw = prompt("請輸入新密碼:");
                if (newPw) {
                    try {
                        await updateDoc(doc(state.db, "users", state.userName), { password: newPw });
                        alert("密碼修改成功！下次登入請使用新密碼。");
                    } catch (e) { alert("修改失敗: " + e.message); }
                }
            },

            renameUser: async () => { const n = document.getElementById('renameInput').value.trim(), o = state.userName, b = document.getElementById('renameBtn'); if (!n || n === o) return; if (!confirm(`確定要改名為 "${n}"？`)) return; b.disabled = true; b.innerText = '更新中...'; try { const bat = writeBatch(state.db); 
                const oldUserDoc = await getDoc(doc(state.db, "users", o));
                const oldUserData = oldUserDoc.exists() ? oldUserDoc.data() : { createdAt: new Date().toISOString() };
                bat.set(doc(state.db, "users", n), oldUserData); 
                (await getDocs(query(collection(state.db, "ledgers"), where("members", "array-contains", o)))).forEach(d => { const m = d.data().members.map(x => x === o ? n : x); bat.update(d.ref, { members: m, ...(d.data().createdBy === o && { createdBy: n }) }); }); (await getDocs(query(collection(state.db, "transactions"), where("paidBy", "==", o)))).forEach(d => bat.update(d.ref, { paidBy: n })); (await getDocs(query(collection(state.db, "transactions"), where("lastEditedBy", "==", o)))).forEach(d => bat.update(d.ref, { lastEditedBy: n })); bat.delete(doc(state.db, "users", o)); await bat.commit(); alert("更名成功"); app.performLogin(n); location.reload(); } catch (e) { alert("更名失敗:" + e.message); b.disabled = false; b.innerText = '確認'; } },
            
            editLedger: (id, name, type, currency, icon) => { const l = state.ledgers.find(x => x.id === id); if(l) ui.openLedgerModal('edit', l); },
            unarchiveLedger: async (id, name) => { ui.showConfirm('還原帳本', `確定要取消「${name}」的結算狀態並還原為一般帳本嗎？`, async () => { try { await updateDoc(doc(state.db, "ledgers", id), { status: 'active' }); alert("帳本已還原"); } catch (e) { alert("還原失敗: " + e.message); } }); },

            deleteLedger: async (id, name) => {
                ui.showConfirm('刪除帳本', `⚠️ 警告：此動作無法復原！\n\n確定要永久刪除帳本「${name}」及其所有交易紀錄嗎？`, async () => {
                    try {
                        const q = query(collection(state.db, "transactions"), where("ledgerId", "==", id));
                        const snapshot = await getDocs(q);
                        const chunks = []; let batch = writeBatch(state.db); let count = 0;
                        snapshot.forEach(doc => { batch.delete(doc.ref); count++; if (count >= 400) { chunks.push(batch.commit()); batch = writeBatch(state.db); count = 0; } });
                        if (count > 0) chunks.push(batch.commit()); await Promise.all(chunks);

                        const qRules = query(collection(state.db, "recurring_rules"), where("ledgerId", "==", id));
                        const snapRules = await getDocs(qRules); const batchRules = writeBatch(state.db); snapRules.forEach(d => batchRules.delete(d.ref)); await batchRules.commit();
                        await deleteDoc(doc(state.db, "ledgers", id));
                        if (state.currentLedger && state.currentLedger.id === id) { const next = state.ledgers.find(l => l.id !== id); if (next) ui.switchLedger(next.id); else location.reload(); }
                    } catch (e) { console.error(e); alert("刪除失敗: " + e.message); }
                });
            },

            detectCategory: (name) => {
                if (!name) return null;
                for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) { if (keywords.some(k => name.includes(k))) { return category; } }
                return null;
            },

            autoCategorize: (input) => {
                const row = input.parentElement.parentElement;
                const name = input.value.trim();
                const catSelect = row.querySelector('.item-cat');
                if (document.getElementById('tType').value !== 'expense') return;
                const detected = app.detectCategory(name);
                if (detected) {
                    const options = Array.from(catSelect.options).map(o => o.value);
                    if (options.includes(detected)) {
                        catSelect.value = detected; catSelect.classList.add('bg-blue-50');
                        setTimeout(() => catSelect.classList.remove('bg-blue-50'), 500);
                    }
                }
            },

            listenRecurringRules: () => {
                if(!state.currentLedger) return;
                if(state.unsubscribeRecurring) state.unsubscribeRecurring();
                const q = query(collection(state.db, "recurring_rules"), where("ledgerId", "==", state.currentLedger.id));
                state.unsubscribeRecurring = onSnapshot(q, (snapshot) => { 
                    state.recurringRules = []; 
                    snapshot.forEach(doc => state.recurringRules.push({ id: doc.id, ...doc.data() })); 
                    ui.renderRecurringList();
                    // Check for auto-recurring tasks after loading
                    app.processAutoRecurringRules(state.recurringRules);
                });
            },

            saveRecurringRule: async (e) => {
                e.preventDefault();
                const id = document.getElementById('recRuleId').value;
                const type = document.getElementById('recType').value;
                const freq = document.getElementById('recFreq').value;
                const name = document.getElementById('recName').value.trim();
                const amount = parseFloat(document.getElementById('recAmount').value);
                const category = document.getElementById('recCategory').value;
                const nextDate = document.getElementById('recNextDate').value;
                const endDate = document.getElementById('recEndDate').value || null;
                const isAuto = document.getElementById('recAuto').checked;

                if (!name || !amount || !nextDate) return alert("請填寫完整資訊");
                
                const ruleData = { 
                    ledgerId: state.currentLedger.id, 
                    type, 
                    frequency: freq, 
                    name, 
                    amount, 
                    category, 
                    nextDueDate: nextDate, 
                    endDate: endDate,
                    isAuto: isAuto,
                    currency: 'TWD', 
                    updatedAt: new Date().toISOString() 
                };
                
                try {
                    if (id) { await updateDoc(doc(state.db, "recurring_rules", id), ruleData); }
                    else { await addDoc(collection(state.db, "recurring_rules"), { ...ruleData, createdAt: new Date().toISOString() }); }
                    ui.toggleRecurringForm(false);
                } catch(err) { alert("儲存失敗: " + err.message); }
            },

            deleteRecurringRule: async (id) => { ui.showConfirm('刪除固定收支', '確定要刪除此固定收支規則嗎？', async () => { await deleteDoc(doc(state.db, "recurring_rules", id)); }); },

            executeRecurring: async (ruleId) => {
                const rule = state.recurringRules.find(r => r.id === ruleId); if(!rule) return;
                
                // End date check
                if (rule.endDate && new Date(rule.nextDueDate) > new Date(rule.endDate)) {
                    return alert("此規則已超過結束日期。");
                }

                ui.showConfirm('執行入帳', `確認將「${rule.name}」($${rule.amount}) 加入今日帳本？`, async () => {
                    const batch = writeBatch(state.db);
                    const txRef = doc(collection(state.db, "transactions"));
                    batch.set(txRef, { ledgerId: state.currentLedger.id, type: rule.type, date: rule.nextDueDate, amount: rule.amount, originalAmount: rule.amount, currency: 'TWD', exchangeRate: 1, paidBy: state.userName, name: rule.name, category: rule.category, merchant: '', groupId: Date.now().toString(), createdAt: new Date().toISOString(), lastEditedBy: state.userName, lastEditedAt: new Date().toISOString() });
                    const currentDue = new Date(rule.nextDueDate); let nextDue = new Date(currentDue);
                    if(rule.frequency === 'monthly') { nextDue.setMonth(nextDue.getMonth() + 1); }
                    else if (rule.frequency === 'yearly') { nextDue.setFullYear(nextDue.getFullYear() + 1); }
                    batch.update(doc(state.db, "recurring_rules", ruleId), { nextDueDate: nextDue.toISOString().split('T')[0] });
                    await batch.commit(); alert("已成功記帳，並更新下次到期日！");
                });
            },
            
            // New Function: Process Auto-Recurring Rules
            processAutoRecurringRules: async (rules) => {
                const today = new Date();
                today.setHours(0,0,0,0);
                const batch = writeBatch(state.db);
                let hasUpdates = false;
                let addedCount = 0;

                rules.forEach(rule => {
                    if (!rule.isAuto) return; // Only process auto rules
                    
                    let due = new Date(rule.nextDueDate);
                    let nextDue = new Date(due);
                    let ruleModified = false;
                    
                    // Safety limit: max 36 iterations (3 years of monthly) to prevent infinite loops
                    let loopSafety = 0;
                    
                    // Loop to catch up all missed payments
                    while (nextDue <= today && loopSafety < 36) {
                         // Check end date strictly
                         if (rule.endDate && new Date(rule.endDate) < nextDue) {
                             break; // Stop if we passed the end date
                         }

                         // Create Transaction
                         const txRef = doc(collection(state.db, "transactions"));
                         batch.set(txRef, { 
                             ledgerId: state.currentLedger.id, 
                             type: rule.type, 
                             date: nextDue.toISOString().split('T')[0], 
                             amount: rule.amount, 
                             originalAmount: rule.amount, 
                             currency: 'TWD', 
                             exchangeRate: 1, 
                             paidBy: state.userName, 
                             name: rule.name + " (自動)", 
                             category: rule.category, 
                             merchant: '', 
                             groupId: Date.now().toString() + loopSafety, 
                             createdAt: new Date().toISOString(), 
                             lastEditedBy: 'System', 
                             lastEditedAt: new Date().toISOString() 
                         });
                         addedCount++;

                         // Calculate next date
                         if(rule.frequency === 'monthly') nextDue.setMonth(nextDue.getMonth() + 1);
                         else if(rule.frequency === 'yearly') nextDue.setFullYear(nextDue.getFullYear() + 1);
                         
                         ruleModified = true;
                         loopSafety++;
                    }

                    // Update the rule if we advanced the date
                    if (ruleModified) {
                        const ruleRef = doc(state.db, "recurring_rules", rule.id);
                        batch.update(ruleRef, { nextDueDate: nextDue.toISOString().split('T')[0] });
                        hasUpdates = true;
                    }
                });

                if (hasUpdates) {
                    try {
                        await batch.commit();
                        if(addedCount > 0) {
                            // Show a small notification toast instead of alert to be less intrusive
                            const toast = document.createElement('div');
                            toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-fade-in text-sm font-bold flex items-center gap-2';
                            toast.innerHTML = `<i class="fa-solid fa-robot text-indigo-400"></i> 已自動補記 ${addedCount} 筆固定帳務`;
                            document.body.appendChild(toast);
                            setTimeout(() => toast.remove(), 4000);
                        }
                    } catch (e) {
                        console.error("Auto recurring failed", e);
                    }
                }
            },

            downloadTemplate: () => {
                const headers = [['日期 (YYYY-MM-DD)', '收支類型 (支出/收入)', '類別', '項目名稱', '金額', '商店/對象 (選填)', '幣別 (選填)', '備註 (選填)']];
                const example = [['2024-02-01', '支出', '飲食', '午餐便當', 120, '7-11', 'TWD', '公司聚餐']];
                const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet([...headers, ...example]);
                ws['!cols'] = [{wch:15}, {wch:15}, {wch:10}, {wch:20}, {wch:10}, {wch:15}, {wch:10}, {wch:20}];
                XLSX.utils.book_append_sheet(wb, ws, "匯入範本"); XLSX.writeFile(wb, "記帳本匯入範本.xlsx");
            },

            handleFileSelect: (input) => {
                const file = input.files[0]; if (!file) return;
                document.getElementById('importFileName').innerText = file.name;
                document.getElementById('importFileDisplay').classList.remove('hidden');
                document.getElementById('importPlaceholder').classList.add('hidden');
                state.importFile = file;
            },

            processImport: async () => {
                if (!state.importFile) return alert("請先選擇檔案");
                if (!state.currentLedger) return alert("請先選擇要匯入的帳本");
                const btn = document.getElementById('btnStartImport'); btn.disabled = true; btn.innerText = "處理中...";
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        if (jsonData.length < 2) throw new Error("檔案內容為空或格式錯誤");
                        const rows = jsonData.slice(1); const batch = writeBatch(state.db); let count = 0; const groupIdBase = Date.now().toString();
                        rows.forEach((row, index) => {
                            if (!row[0] || !row[4]) return;
                            const getVal = (idx) => row[idx] ? String(row[idx]).trim() : '';
                            let dateStr = (row[0] instanceof Date) ? row[0].toISOString().split('T')[0] : (new Date(row[0]).toISOString().split('T')[0] || new Date().toISOString().split('T')[0]);
                            const type = getVal(1).includes('收') ? 'income' : 'expense';
                            const amount = parseFloat(row[4]);
                            const docRef = doc(collection(state.db, "transactions"));
                            batch.set(docRef, { ledgerId: state.currentLedger.id, type, date: dateStr, amount, originalAmount: amount, currency: getVal(6) || state.currentLedger.defaultCurrency || 'TWD', exchangeRate: 1, paidBy: state.userName, name: getVal(7) ? `${getVal(3)} (${getVal(7)})` : getVal(3), category: getVal(2) || '其他', merchant: getVal(5), groupId: groupIdBase + index, createdAt: new Date().toISOString(), lastEditedBy: state.userName, lastEditedAt: new Date().toISOString() });
                            count++;
                        });
                        if (count > 0) { await batch.commit(); alert(`成功匯入 ${count} 筆資料！`); ui.closeModal('importModal'); }
                    } catch (err) { alert("匯入失敗: " + err.message); } finally { btn.disabled = false; btn.innerText = "開始匯入"; }
                };
                reader.readAsArrayBuffer(state.importFile);
            },
            
            updateLedgerView: () => {
                if (!state.currentLedger) return;
                let listData = [];
                const y = document.getElementById('ledgerYear').value; const m = document.getElementById('ledgerMonth').value;
                const mSel = document.getElementById('ledgerMonth');
                if (y === 'all' || y === 'last3') { mSel.disabled = true; mSel.classList.add('text-gray-400', 'cursor-not-allowed'); }
                else { mSel.disabled = false; mSel.classList.remove('text-gray-400', 'cursor-not-allowed'); }
                listData = state.transactions.filter(t => { 
                    if (y === 'all') return true;
                    const d = new Date(t.date);
                    if (y === 'last3') { return d.getFullYear() >= new Date().getFullYear() - 2; }
                    return d.getFullYear().toString() === y && (m === 'all' || (d.getMonth() + 1).toString().padStart(2, '0') === m); 
                });
                ui.renderTopStats(listData); state.currentListData = listData;
                let inc = 0, exp = 0; let fInc = 0, fExp = 0;
                const defCurr = state.currentLedger.defaultCurrency || 'TWD';
                listData.forEach(t => { 
                    if (t.type === 'expense') { exp += t.amount; if(t.currency === defCurr && defCurr !== 'TWD') fExp += (t.originalAmount || 0); }
                    else { inc += t.amount; if(t.currency === defCurr && defCurr !== 'TWD') fInc += (t.originalAmount || 0); }
                });
                const renderCard = (elId, twdVal, foreignVal, colorClass) => {
                    let html = `<span class="${colorClass}">$${Math.round(twdVal).toLocaleString()}</span>`;
                    if (defCurr !== 'TWD') html += `<div class="text-xs text-gray-400 font-medium mt-1 tracking-wider">${defCurr} ${Math.round(foreignVal).toLocaleString()}</div>`;
                    document.getElementById(elId).innerHTML = html;
                };
                renderCard('totalIncome', inc, fInc, 'text-base md:text-3xl font-bold text-emerald-600');
                renderCard('totalExpense', exp, fExp, 'text-base md:text-3xl font-bold text-rose-600');
                renderCard('totalBalance', inc - exp, fInc - fExp, 'text-base md:text-3xl font-bold text-blue-600');
                ui.renderTransactionListHTML(listData);
            },
            
            clearDateFilter: () => { state.filterDay = null; app.updateLedgerView(); },
            exportToExcel: () => { if (!state.allTransactionsCache.length) return alert("無資料"); const d = state.allTransactionsCache.map(t => ({ 日期: t.date, 帳本: t.ledgerName, 類型: t.type, 金額: t.amount, 項目: t.name, 分類: t.category, 商店: t.merchant || '' })); const w = XLSX.utils.json_to_sheet(d), b = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(b, w, "Data"); XLSX.writeFile(b, `帳本匯出.xlsx`); },
            exportCurrentList: () => { if (state.currentListData.length === 0) return alert("無資料"); const exportData = state.currentListData.map(t => ({ '日期': t.date, '商店/對象': t.merchant || '', '項目名稱': t.name, '類別': t.category, '類型': t.type === 'expense' ? '支出' : '收入', '金額': t.amount, '幣別': t.currency, '付款人': t.paidBy || '' })); const ws = XLSX.utils.json_to_sheet(exportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Transactions"); XLSX.writeFile(wb, `交易明細_${new Date().toISOString().slice(0,10)}.xlsx`); },

            askAI: async () => { const i = document.getElementById('aiChatInput'), h = document.getElementById('aiChatHistory'), b = document.getElementById('btnAiSend'), q = i.value.trim(); if (!q || !state.geminiKey) return; h.innerHTML += `<div class="bg-indigo-100 p-2 rounded-lg ml-auto w-fit mb-2 text-sm text-indigo-900">${q}</div>`; b.disabled = true; i.value = ''; try { const p = `Role: Financial Assistant. Context JSON: ${JSON.stringify(state.allTransactionsCache.slice(0, 50).map(t => ({ d: t.date, a: t.amount, c: t.category, i: t.name })))}. Question: "${q}". Answer in Traditional Chinese, concise.`; const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.geminiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: p }] }] }) }); const d = await r.json(); h.innerHTML += `<div class="bg-white border p-2 rounded-lg w-fit mb-2 text-sm text-gray-700">${marked.parse(d.candidates[0].content.parts[0].text)}</div>`; } catch (e) { h.innerHTML += `<div class="text-red-500 text-xs">Error</div>`; } b.disabled = false; h.scrollTop = h.scrollHeight; },
            
            deleteSelected: async () => {
                const checked = document.querySelectorAll('.tx-checkbox:checked'); if(checked.length === 0) return;
                ui.showConfirm('刪除選取項目', `確定要刪除選取的 ${checked.length} 筆/組交易紀錄嗎？`, async () => {
                    const btn = document.getElementById('bulkDeleteBtn'); btn.disabled = true;
                    try { const batch = writeBatch(state.db); checked.forEach(cb => { cb.getAttribute('data-ids').split(',').forEach(id => batch.delete(doc(state.db, "transactions", id))); }); await batch.commit(); document.getElementById('selectAllTx').checked = false; ui.updateBulkActionState(); } 
                    catch (e) { alert("刪除失敗"); } finally { btn.disabled = false; }
                });
            },

            archiveLedger: async () => { if(!state.currentLedger) return; const p=document.getElementById('targetPersonalLedger').value; const a=parseInt(document.getElementById('settleShareAmount').innerText.replace(/,/g,''))||0; const b=writeBatch(state.db); b.update(doc(state.db,"ledgers",state.currentLedger.id),{status:'archived'}); if(a>0 && p) b.set(doc(collection(state.db,"transactions")),{ledgerId:p,type:'expense',date:new Date().toISOString().split('T')[0],amount:a,originalAmount:a,currency:'TWD',exchangeRate:1,name:`${state.currentLedger.name}(分帳)`,category:'娛樂',createdAt:new Date().toISOString(),lastEditedBy:state.userName}); await b.commit(); alert("歸檔成功"); ui.closeModal('settleModal'); },
            fetchRates: async()=>{
                try{
                    const r=await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                    const d=await r.json();
                    if(d.rates){
                        state.rates = {TWD: 1};
                        state.currencies.forEach(c => {
                            if(c !== 'TWD' && d.rates[c]) state.rates[c] = 1/d.rates[c];
                        });
                    }
                }catch{}
            },
            connectFirebase: async(c)=>{try{const a=initializeApp(c);state.db=getFirestore(a);try{await enableIndexedDbPersistence(state.db)}catch{}state.isOnline=true;}catch(e){console.error(e);alert("連線失敗: "+e.message)}},
            loadGlobalSettings: async()=>{if(!state.db)return;try{const d=await getDoc(doc(state.db,"settings","global"));if(d.exists()&&d.data().gemini_api_key){state.geminiKey=d.data().gemini_api_key;document.getElementById('geminiKeyInput').value=state.geminiKey;}}catch{}},
            saveSettings: async()=>{const k=document.getElementById('geminiKeyInput').value.trim(),s=document.getElementById('scriptUrlInput').value.trim(),p=document.getElementById('aiPromptInput').value.trim();if(!k)return alert("API Key Empty");try{localStorage.setItem('acc_script_url',s);localStorage.setItem('acc_ai_prompt', p);state.customAiPrompt = p;await setDoc(doc(state.db,"settings","global"),{gemini_api_key:k,updatedAt:new Date().toISOString(),updatedBy:state.userName},{merge:true});localStorage.setItem('acc_gemini_key',k);alert("設定已儲存！");location.reload();}catch{alert("Err");}},
            setLedgerPassword: async() => { const p = prompt("請輸入新密碼 (空白則為無密碼):"); if(p !== null) { await updateDoc(doc(state.db, "ledgers", state.currentLedger.id), { password: p }); alert("密碼已更新"); } },
            removeLedgerPassword: async()=>{ ui.showConfirm('移除密碼', '確定要移除密碼保護嗎?', async () => { await updateDoc(doc(state.db,"ledgers",state.currentLedger.id),{password:""}); alert("已移除"); ui.closeModal('settingsModal'); }); },
            addCategory: ()=>{const t=document.getElementById('newCatType').value,n=document.getElementById('newCatName').value.trim();if(!n)return;state.categories[t].push(n);app.saveCategories();ui.renderSettings();},
            removeCategory: (t,n)=>{ ui.showConfirm('刪除類別', `確定刪除分類「${n}」？`, () => { state.categories[t]=state.categories[t].filter(c=>c!==n);app.saveCategories();ui.renderSettings(); }); },
            addMerchant: () => { const n = document.getElementById('newMerchantName').value.trim(); if (!n) return; if (!state.merchants.includes(n)) { state.merchants.push(n); app.saveMerchants(); ui.renderSettings(); } document.getElementById('newMerchantName').value = ''; },
            removeMerchant: (n) => { ui.showConfirm('刪除商店', `確定要刪除「${n}」嗎？`, () => { state.merchants = state.merchants.filter(m => m !== n); app.saveMerchants(); ui.renderSettings(); }); },
            
            // New Currency Functions
            addCurrency: () => { 
                const c = document.getElementById('newCurrencyCode').value.trim().toUpperCase(); 
                if (!c || c.length !== 3) return alert("請輸入3碼貨幣代碼 (如 HKD)"); 
                if (!state.currencies.includes(c)) { 
                    state.currencies.push(c); 
                    app.saveCurrencies(); 
                    app.fetchRates(); // Refresh rates
                    ui.renderSettings(); 
                } 
                document.getElementById('newCurrencyCode').value = ''; 
            },
            removeCurrency: (c) => { 
                if(c === 'TWD') return alert("TWD 為預設幣別無法刪除");
                ui.showConfirm('刪除幣別', `確定要刪除「${c}」嗎？`, () => { 
                    state.currencies = state.currencies.filter(cur => cur !== c); 
                    app.saveCurrencies(); 
                    ui.renderSettings(); 
                }); 
            },
            saveCurrencies: async () => { 
                localStorage.setItem('acc_custom_currencies', JSON.stringify(state.currencies)); 
                if (state.userName && state.isOnline) { 
                    try { await setDoc(doc(state.db, "users", state.userName), { customCurrencies: state.currencies, updatedAt: new Date().toISOString() }, { merge: true }); } 
                    catch (e) { console.error(e); } 
                } 
            },

            loadUserSettings: async () => { 
                if (!state.userName || !state.db) return; 
                try { 
                    onSnapshot(doc(state.db, "users", state.userName), (docSnap) => { 
                        if (docSnap.exists()) { 
                            const data = docSnap.data(); 
                            if (data.customMerchants) { state.merchants = data.customMerchants; localStorage.setItem('acc_custom_merchants', JSON.stringify(state.merchants)); } 
                            if (data.customCurrencies) { state.currencies = data.customCurrencies; localStorage.setItem('acc_custom_currencies', JSON.stringify(state.currencies)); app.fetchRates(); }
                            if (data.preferences) { state.userPrefs = data.preferences; app.processLedgers(); } 
                        } 
                    }); 
                } catch (e) { console.error(e); } 
            },
            saveMerchants: async () => { localStorage.setItem('acc_custom_merchants', JSON.stringify(state.merchants)); if (state.userName && state.isOnline) { try { await setDoc(doc(state.db, "users", state.userName), { customMerchants: state.merchants, updatedAt: new Date().toISOString() }, { merge: true }); } catch (e) { console.error(e); } } },
            saveCategories: ()=>localStorage.setItem('acc_custom_categories',JSON.stringify(state.categories)),
            listenLedgers: () => { if(state.unsubscribeLedgers) state.unsubscribeLedgers(); state.unsubscribeLedgers = onSnapshot(query(collection(state.db,"ledgers")), s => { state.rawLedgers = []; s.forEach(d => state.rawLedgers.push({id: d.id, ...d.data()})); app.processLedgers(); }); },

            processLedgers: () => {
                let myList = state.rawLedgers.filter(l => l.type === 'personal' ? l.createdBy === state.userName : l.members && l.members.includes(state.userName));
                myList = myList.map(l => {
                    const isFav = state.userPrefs.favorites ? state.userPrefs.favorites.includes(l.id) : (l.isFavorite || false);
                    const userOrder = state.userPrefs.orders && state.userPrefs.orders[l.id] !== undefined ? state.userPrefs.orders[l.id] : (l.order || 0);
                    return { ...l, isUserFavorite: isFav, userOrder: userOrder };
                });
                state.ledgers = myList.sort((a,b) => {
                    if (a.status === 'archived' && b.status !== 'archived') return 1;
                    if (a.status !== 'archived' && b.status === 'archived') return -1;
                    if (a.isUserFavorite && !b.isUserFavorite) return -1;
                    if (!a.isUserFavorite && b.isUserFavorite) return 1;
                    return (b.userOrder - a.userOrder) || new Date(b.createdAt) - new Date(a.createdAt);
                });
                if(!state.currentLedger && state.ledgers.length > 0) { ui.switchLedger(localStorage.getItem('acc_current_ledger') || state.ledgers[0].id); }
                ui.renderLedgerList();
            },
            
            toggleFavorite: async (id, currentVal) => {
                if(!state.userName) return;
                const prefs = state.userPrefs || { favorites: [], orders: {} };
                let favs = prefs.favorites || [];
                if (favs.includes(id)) { favs = favs.filter(f => f !== id); } else { favs.push(id); }
                try { await setDoc(doc(state.db, "users", state.userName), { preferences: { ...prefs, favorites: favs } }, { merge: true }); } catch(e) { console.error(e); }
            },
            
            moveLedger: async (id, direction) => {
                const list = state.ledgers; const index = list.findIndex(l => l.id === id); if (index === -1) return;
                const targetIndex = index + direction; if (targetIndex < 0 || targetIndex >= list.length) return;
                const current = list[index]; const neighbor = list[targetIndex];
                if ((current.isUserFavorite !== neighbor.isUserFavorite) || (current.status !== neighbor.status)) return;
                const prefs = state.userPrefs || { favorites: [], orders: {} };
                const orders = { ...(prefs.orders || {}) };
                const getScore = (item, idx) => orders[item.id] !== undefined ? orders[item.id] : (list.length - idx) * 10000;
                const currentScore = getScore(current, index); const neighborScore = getScore(neighbor, targetIndex);
                orders[current.id] = neighborScore; orders[neighbor.id] = currentScore;
                try { await setDoc(doc(state.db, "users", state.userName), { preferences: { ...prefs, orders: orders } }, { merge: true }); } catch(e) { console.error(e); }
            },
            
            saveLedger: async () => {
                const id = document.getElementById('editingLedgerId').value;
                const n = document.getElementById('newLedgerName').value.trim();
                const t = document.getElementById('newLedgerType').value;
                const c = document.getElementById('newLedgerCurrency').value;
                const iconRadio = document.querySelector('input[name="ledgerIcon"]:checked');
                const icon = iconRadio ? iconRadio.value : "";
                if(!n || !state.userName) return alert("資料不全");
                try {
                    if (id) { await updateDoc(doc(state.db, "ledgers", id), { name: n, type: t, defaultCurrency: c, icon: icon }); }
                    else {
                        let mem = t === 'group' ? Array.from(document.querySelectorAll('.member-checkbox:checked')).map(cb => cb.value) : [state.userName];
                        if(t === 'group' && !mem.includes(state.userName)) mem.push(state.userName);
                        await addDoc(collection(state.db, "ledgers"), { name: n, type: t, members: mem, defaultCurrency: c, createdBy: state.userName, status: 'active', createdAt: new Date().toISOString(), icon: icon, isFavorite: false, order: Date.now() });
                    }
                    ui.closeModal('ledgerModal');
                } catch(e) { alert("儲存失敗: " + e.message); }
            },

            listenAssets: () => {
                if(!state.userName) return;
                if(state.unsubscribeAssets) state.unsubscribeAssets();
                state.unsubscribeAssets = onSnapshot(query(collection(state.db, "user_assets"), where("userId", "==", state.userName)), (snapshot) => {
                    state.assets = []; snapshot.forEach(doc => state.assets.push({ id: doc.id, ...doc.data() })); ui.renderAssets(); ui.renderAssetOptions();
                });
            },
            saveAsset: async () => {
                const name = document.getElementById('assetNameInput').value.trim();
                const balance = parseFloat(document.getElementById('assetBalanceInput').value);
                if (!name || isNaN(balance)) return alert("請輸入完整資訊");
                const existing = state.assets.find(a => a.name === name);
                const historyEntry = { date: new Date().toISOString(), balance: balance };
                try {
                    if (existing) { await updateDoc(doc(state.db, "user_assets", existing.id), { currentBalance: balance, updatedAt: new Date().toISOString(), history: [...(existing.history || []), historyEntry] }); }
                    else { await addDoc(collection(state.db, "user_assets"), { userId: state.userName, name, currentBalance: balance, updatedAt: new Date().toISOString(), history: [historyEntry] }); }
                    document.getElementById('assetNameInput').value = ''; document.getElementById('assetBalanceInput').value = ''; alert("資產已更新");
                } catch (e) { alert("更新失敗"); }
            },
            deleteAsset: async (id) => { ui.showConfirm('刪除資產', '確定要刪除此資產紀錄？', async () => { await deleteDoc(doc(state.db, "user_assets", id)); }); },
            editAsset: (name, balance) => { document.getElementById('assetNameInput').value = name; document.getElementById('assetBalanceInput').value = balance; document.getElementById('assetBalanceInput').focus(); },

            listenTransactions: () => { if (!state.currentLedger) return; if (state.unsubscribeTrans) state.unsubscribeTrans(); document.getElementById('loadingIndicator').classList.remove('hidden'); state.unsubscribeTrans = onSnapshot(query(collection(state.db, "transactions"), where("ledgerId", "==", state.currentLedger.id)), snap => { state.transactions = []; snap.forEach(d => state.transactions.push({ id: d.id, ...d.data() })); state.transactions.sort((a, b) => new Date(b.date) - new Date(a.date)); app.updateLedgerView(); document.getElementById('loadingIndicator').classList.add('hidden'); }); },
            addTransaction: async(e)=>{
                e.preventDefault(); const b=document.getElementById('submitBtn'); b.disabled=true;
                let u=document.getElementById('hiddenImageUrl').value;
                const merch=document.getElementById('tMerchant').value.trim();
                const groupId=Date.now().toString();
                try{
                    if(state.currentImage&&state.scriptUrl){
                        const r=await fetch(state.scriptUrl,{method:'POST',body:JSON.stringify({image:state.currentImage.base64,mimeType:state.currentImage.mimeType,filename:`rec_${Date.now()}.jpg`})});
                        const d=await r.json(); if(d.status==='success') u = app.getDirectDriveUrl(d.url);
                    }
                    const eid=document.getElementById('editingTxId').value; const typ=document.getElementById('tType').value; const dat=document.getElementById('tDate').value;
                    const isG=state.currentLedger.type==='group'; let cur='TWD',rate=1,pb='',splitAmong=[];
                    
                    // Enable Currency Logic for All Ledgers
                    cur=document.getElementById('tCurrency').value; 
                    rate=parseFloat(document.getElementById('tRate').value)||1;
                    
                    if(isG){ 
                        pb=document.getElementById('tPaidBy').value; 
                        splitAmong = Array.from(document.querySelectorAll('.split-checkbox:checked')).map(cb => cb.value); 
                        if (splitAmong.length === 0) return alert("請選分攤對象"); 
                    }
                    const rows=document.querySelectorAll('.item-row'),bat=writeBatch(state.db);
                    if(eid){
                        const r=rows[0]; if(r){
                            const n=r.querySelector('.item-name').value,c=r.querySelector('.item-cat').value,nt=r.querySelector('.item-note').value;
                            let a=parseFloat(r.querySelector('.item-amount').value)||0,oa=a; 
                            if(cur!=='TWD') a=Math.round(oa*rate); // Calculate TWD amount for storage
                            bat.update(doc(state.db,"transactions",eid),{ ledgerId:state.currentLedger.id, type:typ, date:dat, amount:a, originalAmount:oa, currency:cur, exchangeRate:rate, paidBy:pb, splitAmong, name:n, category:c, imageUrl:u, merchant:merch, lastEditedBy:state.userName, lastEditedAt:new Date().toISOString(), note: nt });
                        }
                    } else {
                        rows.forEach((r,idx)=>{
                            const n=r.querySelector('.item-name').value.trim(),c=r.querySelector('.item-cat').value,nt=r.querySelector('.item-note').value.trim();
                            let a=parseFloat(r.querySelector('.item-amount').value)||0,oa=a; if(!n&&a===0)return; 
                            if(cur!=='TWD') a=Math.round(oa*rate); // Calculate TWD amount for storage
                            bat.set(doc(collection(state.db,"transactions")),{ ledgerId:state.currentLedger.id, type:typ, date:dat, amount:a, originalAmount:oa, currency:cur, exchangeRate:rate, paidBy:pb, splitAmong, name:n, category:c, imageUrl:u, merchant:merch, groupId, createdAt:new Date().toISOString(), lastEditedBy:state.userName, lastEditedAt:new Date().toISOString(), note: nt });
                        });
                    }
                    await bat.commit(); ui.closeModal('transactionModal'); ai.clearImage();
                } catch(e) { alert("儲存失敗: "+e.message); } finally { b.disabled=false; }
            },
            
            getDirectDriveUrl: (url) => {
                if (!url) return '';
                if (url.includes('drive.google.com')) {
                    let id = url.includes('/file/d/') ? url.split('/file/d/')[1].split('/')[0] : (url.includes('id=') ? url.split('id=')[1].split('&')[0] : '');
                    if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
                }
                return url;
            },

            editTransaction: (id)=>{
                const t=state.transactions.find(x=>x.id===id); if(!t)return;
                ui.openTransactionModal('編輯'); document.getElementById('editingTxId').value=t.id; document.getElementById('tType').value=t.type; document.getElementById('tDate').value=t.date;
                document.getElementById('hiddenImageUrl').value=t.imageUrl||''; document.getElementById('tMerchant').value=t.merchant||'';
                document.getElementById('btnAddItem').classList.add('hidden'); document.getElementById('uploadContainer').classList.add('hidden');
                
                // Set currency for all types
                document.getElementById('tCurrency').value=t.currency||'TWD'; document.getElementById('tRate').value = t.exchangeRate ? parseFloat(t.exchangeRate).toFixed(4) : 1;
                app.updateRate(false);

                if(state.currentLedger.type==='group'){
                    document.getElementById('tPaidBy').value=t.paidBy||state.userName;
                    if (t.splitAmong) { document.querySelectorAll('.split-checkbox').forEach(cb => cb.checked = t.splitAmong.includes(cb.value)); }
                }
                document.getElementById('transactionItemsList').innerHTML=''; ui.addItemRow(t.name,t.category,t.currency!=='TWD'?t.originalAmount:t.amount, t.note); ui.updateTotal();
            },
            deleteTransaction: async(id)=>{ ui.showConfirm('刪除交易', '確定要刪除這筆紀錄嗎？', async () => { await deleteDoc(doc(state.db, "transactions", id)); }); },
            updateRate: (r=true)=>{
                const c=document.getElementById('tCurrency').value;
                if(r) { document.getElementById('tRate').value = (state.rates[c] || 1).toFixed(4); }
                document.getElementById('currencyViewText').innerText = `${c} (匯率: ${document.getElementById('tRate').value})`; app.calcTwd();
            },
            calcTwd: ()=>ui.updateTotal(),
            
            calculateDebt: () => {
                if (!state.currentLedger || state.currentLedger.type !== 'group') return;
                const members = state.currentLedger.members; const balances = {}; const details = {};
                members.forEach(m => { balances[m] = 0; details[m] = { paid: 0, share: 0 }; });
                state.transactions.forEach(t => {
                    if (t.type !== 'expense') return;
                    const payer = t.paidBy; const amount = t.amount; const beneficiaries = t.splitAmong && t.splitAmong.length > 0 ? t.splitAmong : members;
                    if (balances[payer] !== undefined) { balances[payer] += amount; details[payer].paid += amount; }
                    const splitAmount = amount / beneficiaries.length;
                    beneficiaries.forEach(b => { if (balances[b] !== undefined) { balances[b] -= splitAmount; details[b].share += splitAmount; } });
                });
                const net = members.map(m => ({ name: m, amount: balances[m] }));
                const creditors = net.filter(n => n.amount > 1).sort((a, b) => b.amount - a.amount);
                const debtors = net.filter(n => n.amount < -1).sort((a, b) => a.amount - b.amount);
                let detailHtml = `<div class="mb-4 overflow-x-auto"><table class="w-full text-xs text-left border-collapse"><thead><tr class="bg-gray-100 text-gray-600 border-b"><th class="p-2">成員</th><th class="p-2 text-right">先墊金額</th><th class="p-2 text-right">實際消費</th><th class="p-2 text-right">結餘</th></tr></thead><tbody>`;
                members.forEach(m => {
                    const d = details[m]; const netVal = balances[m]; const colorClass = netVal >= 0 ? 'text-green-600' : 'text-red-600';
                    detailHtml += `<tr class="border-b border-gray-100"><td class="p-2 font-bold">${m}</td><td class="p-2 text-right text-gray-500">$${Math.round(d.paid).toLocaleString()}</td><td class="p-2 text-right text-gray-500">$${Math.round(d.share).toLocaleString()}</td><td class="p-2 text-right font-bold ${colorClass}">${netVal >= 0 ? '應收' : '應付'} $${Math.round(Math.abs(netVal)).toLocaleString()}</td></tr>`;
                });
                detailHtml += `</tbody></table></div>`;
                let transferHtml = `<h4 class="font-bold text-gray-700 mb-2 border-l-4 border-indigo-500 pl-2">建議轉帳方案</h4><ul class="space-y-2">`;
                if (creditors.length === 0) { transferHtml += '<li class="text-center text-green-500 font-bold bg-green-50 p-2 rounded">目前帳目平衡</li>'; } 
                else {
                    let c = 0, d = 0; while (c < creditors.length && d < debtors.length) {
                        let amount = Math.min(creditors[c].amount, Math.abs(debtors[d].amount));
                        if (amount >= 1) {
                            transferHtml += `<li class="flex justify-between items-center p-2 rounded ${state.userName === debtors[d].name || state.userName === creditors[c].name ? 'bg-indigo-50 border border-indigo-200' : 'bg-white border-b border-gray-100'}"><div class="flex items-center gap-2 text-sm"><span class="font-bold text-gray-700">${debtors[d].name}</span><i class="fa-solid fa-arrow-right text-gray-400 text-xs"></i><span class="font-bold text-gray-700">${creditors[c].name}</span></div><span class="font-mono font-bold text-indigo-600">$${Math.round(amount).toLocaleString()}</span></li>`;
                        }
                        creditors[c].amount -= amount; debtors[d].amount += amount;
                        if (Math.abs(creditors[c].amount) < 1) c++; if (Math.abs(debtors[d].amount) < 1) d++;
                    }
                }
                transferHtml += '</ul>';
                document.getElementById('settleShareAmount').innerText = (details[state.userName] ? Math.round(details[state.userName].share) : 0).toLocaleString();
                const targetSelect = document.getElementById('targetPersonalLedger'); targetSelect.innerHTML = '<option value="">(僅歸檔，不記錄支出)</option>';
                state.ledgers.filter(l => l.type === 'personal' && l.status !== 'archived').forEach(l => { targetSelect.innerHTML += `<option value="${l.id}">${l.name}</option>`; });
                document.getElementById('settleContent').innerHTML = detailHtml + transferHtml; ui.openModal('settleModal');
            },

            loadUserStats: async () => { const y=document.getElementById('statYear').value,m=document.getElementById('statMonth').value,cnt=document.getElementById('ledgerStatsContainer'),ldr=document.getElementById('statsLoader');ldr.classList.remove('hidden');cnt.innerHTML='';
                try{let tx=[];const proms=state.ledgers.map(l=>getDocs(query(collection(state.db,"transactions"),where("ledgerId","==",l.id))).then(s=>s.docs.map(d=>({...d.data(),id:d.id,ledgerName:l.name,ledgerType:l.type}))));const res=await Promise.all(proms);tx=res.flat();state.allTransactionsCache=tx;const ftx=tx.filter(t=>{const d=new Date(t.date);return d.getFullYear().toString()===y&&(m==='all'||(d.getMonth()+1).toString().padStart(2,'0')===m);});state.ledgers.forEach(l=>{const ltx=ftx.filter(t=>t.ledgerId===l.id);if(ltx.length===0)return;let my=0,tot=0;ltx.forEach(t=>{if(t.type==='expense'){tot+=t.amount;if(l.type==='personal'||t.paidBy===state.userName)my+=t.amount;}});if(tot===0&&my===0)return;cnt.innerHTML+=`<div class="bg-white p-4 rounded-xl border mb-3"><div class="flex justify-between"><div><h4 class="font-bold text-sm">${l.name}</h4><p class="text-xl font-bold text-blue-600">$${my.toLocaleString()}</p></div><div class="text-xs text-gray-400 text-right">總支出: $${tot.toLocaleString()}<br>${l.type==='group'?l.members.length+'人':''}</div></div></div>`;});
                if(document.getElementById('showDetailsCheck').checked) {
                    const yearTx = tx.filter(t => new Date(t.date).getFullYear().toString() === y);
                    const process = (type, title, color) => {
                        const filtered = yearTx.filter(t => t.type === type && (t.ledgerType === 'personal' || t.paidBy === state.userName));
                        const total = filtered.reduce((acc, t) => acc + t.amount, 0); const catMap = {}; filtered.forEach(t => catMap[t.category] = (catMap[t.category] || 0) + t.amount);
                        const sorted = Object.entries(catMap).sort((a,b) => b[1] - a[1]);
                        return `<div class="bg-white p-4 rounded-xl border mt-4"><h4 class="font-bold text-sm text-${color}-600 mb-3 border-b pb-2">${title}</h4>${sorted.map(([cat, amt]) => { const pct = total ? Math.round((amt/total)*100) : 0; return `<div class="flex justify-between text-xs mb-1"><span>${cat}</span><span class="font-bold">$${amt.toLocaleString()} (${pct}%)</span></div><div class="w-full bg-gray-100 h-1.5 rounded-full mb-2"><div class="bg-${color}-400 h-1.5 rounded-full" style="width:${pct}%"></div></div>`; }).join('') || '無紀錄'}</div>`;
                    };
                    cnt.innerHTML = process('expense', '年度消費類別統計', 'rose') + process('income', '年度收入來源統計', 'emerald') + cnt.innerHTML;
                }
                }catch(e){console.error(e);}finally{ldr.classList.add('hidden');}
            }
        };

        const ai = {
            handleImageUpload: (inp) => { const f=inp.files[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{ state.currentImage={base64:r.result.split(',')[1],mimeType:f.type}; document.getElementById('imagePreview').src=r.result; document.getElementById('imagePreviewContainer').classList.remove('hidden'); document.getElementById('uploadZone').classList.add('hidden'); ai.runAiAnalysis(); }; r.readAsDataURL(f); },
            clearImage: () => { state.currentImage=null; document.getElementById('receiptUpload').value=''; document.getElementById('imagePreviewContainer').classList.add('hidden'); document.getElementById('uploadZone').classList.remove('hidden'); document.getElementById('aiLoading').classList.add('hidden'); },
            runAiAnalysis: async () => { 
                if(!state.geminiKey) return alert("請先設定 API Key"); 
                const l=document.getElementById('aiLoading'); l.classList.remove('hidden'); document.getElementById('aiStatusText').innerText = "AI 正在辨識收據內容..."; 
                try{ 
                    const existingCats = state.categories.expense.join(', ');
                    let p = `Analyze this receipt. 1. Identify items & prices. 2. Distribute service charges/taxes/discounts proportionally. 3. Return JSON: {"merchant":"...", "items":[{"name":"...", "amount":number, "category":"...", "note":"..."}]}. Category map to: [${existingCats}].`;
                    if (state.customAiPrompt) { p += ` User Instruction: ${state.customAiPrompt}`; }
                    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.geminiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: p }, { inlineData: { mimeType: state.currentImage.mimeType, data: state.currentImage.base64 } }] }] }) });
                    const d = await r.json(); if (d.error) throw new Error(d.error.message);
                    const j=JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'')); 
                    document.getElementById('transactionItemsList').innerHTML=''; 
                    (j.items||[]).forEach(i => { if (!state.categories.expense.includes(i.category)) { state.categories.expense.push(i.category); app.saveCategories(); ui.renderSettings(); } ui.addItemRow(i.name, i.category, i.amount, i.note); }); 
                    if(j.merchant) document.getElementById('tMerchant').value = j.merchant; ui.updateTotal(); document.getElementById('aiStatusText').innerText = "辨識完成！"; setTimeout(() => l.classList.add('hidden'), 1500); 
                } catch(e){ alert("辨識錯誤: " + e.message); l.classList.add('hidden'); } 
            }
        };

        const ui = {
            showConfirm: (title, msg, callback) => { document.getElementById('confirmTitle').innerText = title; document.getElementById('confirmMessage').innerText = msg; document.getElementById('confirmBtnAction').onclick = () => { if(callback) callback(); ui.closeModal('confirmModal'); }; ui.openModal('confirmModal'); },
            showMerchantList: () => { ui.filterMerchantList(document.getElementById('tMerchant').value); document.getElementById('customMerchantList').classList.remove('hidden'); },
            filterMerchantList: (val) => {
                const list = document.getElementById('customMerchantList'); list.innerHTML = '';
                const displayList = val.trim() === '' ? state.merchants : state.merchants.filter(m => m.toLowerCase().includes(val.toLowerCase()));
                displayList.forEach(m => { const div = document.createElement('div'); div.className = 'p-3 text-sm text-gray-700 hover:bg-indigo-50 cursor-pointer border-b last:border-0'; div.innerHTML = `<span>${m}</span>`; div.onmousedown = (e) => { e.preventDefault(); document.getElementById('tMerchant').value = m; list.classList.add('hidden'); }; list.appendChild(div); });
                if (!displayList.length && val.trim()) list.innerHTML = `<div class="p-3 text-xs text-gray-400">將新增 "${val}"</div>`;
            },
            toggleCurrencyEdit: (show) => { document.getElementById('currencyViewMode').classList.toggle('hidden', show); document.getElementById('currencyEditMode').classList.toggle('hidden', !show); if(!show) ui.updateTotal(); },
            toggleStatsSection: () => { document.getElementById('statsContent').classList.toggle('hidden'); document.getElementById('statsToggleIcon').classList.toggle('rotate-180'); },
            toggleAllSplit: (checked) => { document.querySelectorAll('.split-checkbox').forEach(cb => cb.checked = checked); },
            renderSplitCheckboxes: () => { const container = document.getElementById('splitUserContainer'); container.innerHTML = ''; if(!state.currentLedger?.members) return; state.currentLedger.members.forEach(m => { container.innerHTML += `<div class="flex items-center gap-1.5"><input type="checkbox" id="split-${m}" value="${m}" class="split-checkbox w-3.5 h-3.5" checked><label for="split-${m}" class="text-xs">${m}</label></div>`; }); },
            renderLedgerList: () => { 
                const l = document.getElementById('ledgerList'), al = document.getElementById('archivedLedgerList'), ml = document.getElementById('mobileLedgerList');
                l.innerHTML = ''; al.innerHTML = ''; ml.innerHTML = '<button onclick="ui.openLedgerModal(\'create\'); ui.toggleMobileMenu()" class="w-full py-3 border-2 border-dashed border-slate-600 text-slate-400 rounded-lg mb-4">建立新帳本</button>';
                state.ledgers.forEach(x => { 
                    const isActive = x.id === state.currentLedger?.id;
                    const h = `<li class="group"><div class="flex items-center justify-between px-3 py-3 rounded-lg cursor-pointer ${isActive ? 'bg-emerald-600 text-white' : 'text-slate-300 hover:bg-slate-700'}" onclick="ui.switchLedger('${x.id}')"><div class="flex items-center gap-2 truncate flex-1"><button onclick="event.stopPropagation(); app.toggleFavorite('${x.id}')" class="${x.isUserFavorite ? 'text-yellow-400' : 'text-slate-500 opacity-0 group-hover:opacity-100'}"><i class="fa-${x.isUserFavorite ? 'solid' : 'regular'} fa-star"></i></button><span>${x.icon || ''} ${x.name}</span></div><div class="flex items-center" onclick="event.stopPropagation()">${x.password ? '<i class="fa-solid fa-lock text-xs mr-1"></i>' : ''}<div class="hidden group-hover:flex gap-1"><button onclick="app.moveLedger('${x.id}', -1)"><i class="fa-solid fa-arrow-up text-[10px]"></i></button><button onclick="app.moveLedger('${x.id}', 1)"><i class="fa-solid fa-arrow-down text-[10px]"></i></button><button onclick="app.editLedger('${x.id}')"><i class="fa-solid fa-gear text-xs"></i></button><button onclick="app.deleteLedger('${x.id}', '${x.name}')"><i class="fa-solid fa-trash text-xs"></i></button></div></div></div></li>`; 
                    if(x.status === 'archived') al.innerHTML += h; else l.innerHTML += h;
                    ml.innerHTML += `<div class="w-full flex items-center justify-between p-3 rounded-lg border ${isActive ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-300'} mb-2" onclick="ui.switchLedger('${x.id}'); ui.toggleMobileMenu()"><span>${x.icon || ''} ${x.name}</span><button onclick="event.stopPropagation(); app.editLedger('${x.id}')"><i class="fa-solid fa-gear"></i></button></div>`;
                }); 
                document.getElementById('archivedSection').classList.toggle('hidden', !al.innerHTML);
            },
            
            // Updated helper to render select options
            renderCurrencyOptions: () => {
                const selects = document.querySelectorAll('.currency-select');
                selects.forEach(s => {
                    const currentVal = s.value;
                    s.innerHTML = state.currencies.map(c => `<option value="${c}">${c}</option>`).join('');
                    if(state.currencies.includes(currentVal)) s.value = currentVal;
                });
            },

            openLedgerModal: (mode, data = null) => {
                document.getElementById('ledgerModalTitle').innerText = mode === 'create' ? '📘 建立新帳本' : '⚙️ 編輯帳本設定';
                document.getElementById('editingLedgerId').value = data?.id || ''; document.getElementById('newLedgerName').value = data?.name || '';
                document.getElementById('newLedgerType').value = data?.type || 'personal'; 
                
                ui.renderCurrencyOptions(); // Populate currency
                document.getElementById('newLedgerCurrency').value = data?.defaultCurrency || 'TWD';
                
                const iconContainer = document.getElementById('iconSelector'); iconContainer.innerHTML = '<div><input type="radio" name="ledgerIcon" id="icon-none" value="" class="hidden" checked><label for="icon-none" class="w-8 h-8 flex items-center justify-center border rounded-full"><i class="fa-solid fa-ban"></i></label></div>';
                ICONS.forEach((icon, idx) => { iconContainer.innerHTML += `<div><input type="radio" name="ledgerIcon" id="icon-${idx}" value="${icon}" class="hidden" ${data?.icon===icon?'checked':''}><label for="icon-${idx}" class="w-8 h-8 flex items-center justify-center border rounded-full text-lg">${icon}</label></div>`; });
                ui.toggleMemberInput(); if(data?.type==='group') data.members.forEach(m => { const cb = document.getElementById(`member-${m}`); if(cb) cb.checked = true; });
                ui.openModal('ledgerModal');
            },
            switchLedger: (id) => { 
                const l=state.ledgers.find(x=>x.id===id); 
                if(!l)return; 
                state.currentLedger=l; 
                localStorage.setItem('acc_current_ledger',id); 
                document.getElementById('currentLedgerTitle').innerText=l.name; 
                document.getElementById('ledgerTypeBadge').classList.toggle('hidden', l.type!=='group'); 
                document.getElementById('ledgerMembers').innerText=l.type==='group'?l.members.join(','):''; 
                document.getElementById('splitSection').classList.toggle('hidden', l.type!=='group'); 
                
                // Fix: Settle button only visible for group ledgers
                document.getElementById('settleBtn').classList.toggle('hidden', l.type!=='group');
                
                document.getElementById('addTxBtn').classList.toggle('hidden', l.status==='archived'); 
                ui.renderLedgerList(); 
                app.listenTransactions(); 
                app.listenRecurringRules(); 
            },
            toggleSelectAll: (source) => { document.querySelectorAll('.tx-checkbox').forEach(cb => cb.checked = source.checked); ui.updateBulkActionState(); },
            updateBulkActionState: () => { const count = document.querySelectorAll('.tx-checkbox:checked').length; document.getElementById('bulkDeleteBtn').classList.toggle('hidden', count===0); document.getElementById('selectedCount').innerText = count; },
            renderTransactionListHTML: (list) => { 
                const tb=document.getElementById('transactionTableBody'); if(!list.length) { tb.innerHTML='<tr><td colspan="5" class="p-8 text-center text-gray-400">無資料</td></tr>'; return; }
                const groups = {}; list.forEach(t => { const gid = t.groupId || t.id; if(!groups[gid]) groups[gid] = { ...t, items: [], totalAmount: 0, totalOriginalAmount: 0 }; groups[gid].items.push(t); groups[gid].totalAmount += t.amount; groups[gid].totalOriginalAmount += (t.originalAmount || 0); });
                tb.innerHTML = Object.values(groups).sort((a,b) => new Date(b.date) - new Date(a.date)).map(g => {
                    const isG = g.items.length > 1; const detailId = `detail-${g.id}`;
                    
                    // Fix: Find the image URL and create a clickable button
                    const imgItem = g.items.find(i => i.imageUrl);
                    const paperclipHtml = imgItem 
                        ? `<button onclick="event.stopPropagation(); ui.viewImage('${imgItem.imageUrl}')" class="ml-1 text-indigo-500 hover:text-indigo-700 transition" title="查看收據"><i class="fa-solid fa-paperclip"></i></button>` 
                        : '';

                    return `<tr class="border-b hover:bg-gray-50 tx-group-header" onclick="ui.toggleDetail('${detailId}')"><td class="hidden md:table-cell p-2 text-center" onclick="event.stopPropagation()"><input type="checkbox" class="tx-checkbox" data-ids="${g.items.map(i=>i.id).join(',')}" onchange="ui.updateBulkActionState()"></td><td class="p-2 text-xs">${g.date.slice(5)}</td><td class="p-2"><div class="flex flex-col"><span class="font-bold">${g.merchant || g.items[0].name}${paperclipHtml}</span><span class="text-[10px] text-gray-400">${g.items.map(i=>i.category).join(', ')}</span></div></td><td class="p-2 text-right"><span class="font-bold ${g.type==='expense'?'text-rose-600':'text-emerald-600'}">${g.type==='expense'?'-':'+'}${g.totalAmount.toLocaleString()}</span>${g.currency!=='TWD'?`<div class="text-[10px] text-gray-400">${g.currency} ${g.totalOriginalAmount.toLocaleString()}</div>`:''}</td><td class="p-2 text-center"><i class="fa-solid fa-chevron-down text-gray-300" id="arrow-${detailId}"></i></td></tr><tr id="${detailId}" class="hidden bg-slate-50"><td colspan="5" class="p-4">${g.items.map(i=>`<div class="flex justify-between py-1 border-b last:border-0"><span>${i.name} (${i.category})</span><div class="flex gap-2"><span>$${i.amount.toLocaleString()}</span><button onclick="app.editTransaction('${i.id}')" class="text-blue-400"><i class="fa-solid fa-pen"></i></button><button onclick="app.deleteTransaction('${i.id}')" class="text-red-400"><i class="fa-solid fa-trash"></i></button></div></div>`).join('')}</td></tr>`;
                }).join('');
            },
            renderTopStats: (list) => {
                const proc = (type) => {
                    const f = list.filter(t => t.type === type); const tot = f.reduce((s, t) => s + t.amount, 0); const m = {}; f.forEach(t => m[t.category] = (m[t.category] || 0) + t.amount);
                    return Object.entries(m).sort((a,b)=>b[1]-a[1]).map(([c, a]) => { const p = tot ? Math.round(a/tot*100) : 0; return `<div class="text-xs flex justify-between"><span>${c}</span><span>$${a.toLocaleString()} (${p}%)</span></div><div class="w-full bg-gray-100 h-1 rounded-full mb-2"><div class="bg-${type==='expense'?'rose':'emerald'}-400 h-1 rounded-full" style="width:${p}%"></div></div>`; }).join('') || '無資料';
                };
                document.getElementById('topExpenseList').innerHTML = proc('expense'); document.getElementById('topIncomeList').innerHTML = proc('income');
            },
            renderAssets: () => {
                const l = document.getElementById('assetsList'); l.innerHTML = ''; let t = 0;
                state.assets.forEach(a => { t += a.currentBalance; l.innerHTML += `<div class="p-3 bg-white border rounded-lg flex justify-between items-center"><div><p class="font-bold">${a.name}</p><p class="text-xs text-gray-400">${new Date(a.updatedAt).toLocaleDateString()}</p></div><div class="text-right"><p class="font-bold text-indigo-600">$${a.currentBalance.toLocaleString()}</p><button onclick="app.editAsset('${a.name}', ${a.currentBalance})" class="text-xs text-blue-500 mr-2">修改</button><button onclick="app.deleteAsset('${a.id}')" class="text-xs text-red-400">刪除</button></div></div>`; });
                document.getElementById('totalAssetDisplay').innerText = '$' + t.toLocaleString();
            },
            renderAssetOptions: () => { const dl = document.getElementById('assetNamesList'); if(dl) dl.innerHTML = [...new Set([...DEFAULT_BANKS, ...state.assets.map(a=>a.name)])].map(n=>`<option value="${n}">`).join(''); },
            toggleAssetHistory: (id) => { document.getElementById(`asset-history-${id}`).classList.toggle('hidden'); document.getElementById(`asset-arrow-${id}`).classList.toggle('rotate-180'); },
            openRecurringModal: () => { ui.openModal('recurringModal'); ui.toggleRecurringForm(false); ui.renderRecurringList(); },
            toggleRecurringForm: (show, data = null) => {
                document.getElementById('recurringFormSection').classList.toggle('hidden', !show); document.getElementById('recurringListSection').classList.toggle('hidden', show);
                if(show) {
                    document.getElementById('recRuleId').value = data?.id || ''; 
                    document.getElementById('recName').value = data?.name || ''; 
                    document.getElementById('recAmount').value = data?.amount || ''; 
                    document.getElementById('recNextDate').value = data?.nextDueDate || new Date().toISOString().split('T')[0];
                    document.getElementById('recAuto').checked = data ? (data.isAuto !== false) : true; // Default true if new, or respect existing
                    document.getElementById('recEndDate').value = data?.endDate || '';
                    ui.updateCategoriesForRecurring(); if(data) document.getElementById('recCategory').value = data.category;
                }
            },
            updateCategoriesForRecurring: () => { const t = document.getElementById('recType').value; document.getElementById('recCategory').innerHTML = state.categories[t].map(c => `<option value="${c}">${c}</option>`).join(''); },
            renderRecurringList: () => {
                const c = document.getElementById('recurringRulesList'); if(!state.recurringRules.length) return c.innerHTML = '<div class="text-center py-4">無設定</div>';
                c.innerHTML = state.recurringRules.map(r => {
                    const isEnded = r.endDate && new Date(r.nextDueDate) > new Date(r.endDate);
                    const autoBadge = r.isAuto !== false ? '<span class="bg-indigo-100 text-indigo-700 text-[10px] px-2 py-0.5 rounded-full font-bold ml-1">自動</span>' : '<span class="bg-gray-100 text-gray-600 text-[10px] px-2 py-0.5 rounded-full font-bold ml-1">手動</span>';
                    const endDateText = r.endDate ? `<br><span class="text-[10px] ${isEnded ? 'text-red-500' : 'text-gray-400'}">結束: ${r.endDate}${isEnded ? ' (已結束)' : ''}</span>` : '';
                    
                    return `<div class="p-3 bg-white border ${isEnded ? 'border-gray-200 bg-gray-50' : 'border-purple-200'} rounded-lg flex justify-between items-center">
                        <div>
                            <div class="flex items-center">
                                <p class="font-bold ${isEnded ? 'text-gray-500' : 'text-gray-800'}">${r.name} ($${r.amount})</p>
                                ${autoBadge}
                            </div>
                            <p class="text-xs text-gray-400">下次: ${r.nextDueDate}${endDateText}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            ${(!isEnded && r.nextDueDate <= new Date().toISOString().split('T')[0]) ? `<button onclick="app.executeRecurring('${r.id}')" class="bg-purple-600 text-white px-2 py-1 rounded text-xs hover:bg-purple-700">入帳</button>` : ''}
                            <button onclick="ui.editRecurringRule('${r.id}')" class="text-blue-400 hover:text-blue-600"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="app.deleteRecurringRule('${r.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
                }).join('');
            },
            editRecurringRule: (id) => { const r = state.recurringRules.find(x => x.id === id); if(r) ui.toggleRecurringForm(true, r); },
            toggleDetail: (id) => { document.getElementById(id).classList.toggle('hidden'); document.getElementById(`arrow-${id}`).classList.toggle('rotate-180'); },
            
            // Updated to populate Currency options and show inputs even for Personal ledgers
            openTransactionModal: (t) => { 
                document.getElementById('txModalTitle').innerText = t || '新增'; document.getElementById('transactionForm').reset(); document.getElementById('transactionItemsList').innerHTML = ''; ui.addItemRow(); 
                document.getElementById('tDate').value = new Date().toISOString().split('T')[0];
                
                ui.renderCurrencyOptions(); // Ensure options are populated
                const def = state.currentLedger.defaultCurrency || 'TWD';
                document.getElementById('tCurrency').value = def; 
                document.getElementById('tRate').value = (state.rates[def] || 1).toFixed(4); 
                ui.toggleCurrencyEdit(false); 
                ui.renderSplitCheckboxes();
                
                if(state.currentLedger.type === 'group') {
                    const ps = document.getElementById('tPaidBy'); ps.innerHTML = state.currentLedger.members.map(m => `<option value="${m}" ${m===state.userName?'selected':''}>${m}</option>`).join('');
                }
                ui.openModal('transactionModal'); 
            },
            addItemRow: (n='',c='',a='', nt='') => { 
                const div=document.createElement('div'); div.className='grid grid-cols-12 gap-2 p-2 border-b item-row items-start'; 
                div.innerHTML=`<div class="col-span-5"><textarea class="item-name w-full border p-1 rounded text-sm mb-1" rows="2" onblur="app.autoCategorize(this)">${n}</textarea><input type="text" class="item-note w-full border p-1 rounded text-[10px]" value="${nt}" placeholder="備註"></div><div class="col-span-3"><select class="item-cat w-full border p-1 rounded text-sm">${state.categories[document.getElementById('tType').value].map(x=>`<option ${x===c?'selected':''}>${x}</option>`).join('')}</select></div><div class="col-span-3"><input type="number" class="item-amount w-full border p-1 rounded text-sm" value="${a}" oninput="ui.updateTotal()"></div><div class="col-span-1 text-center"><button type="button" onclick="this.parentElement.parentElement.remove(); ui.updateTotal()"><i class="fa-solid fa-times"></i></button></div>`; 
                document.getElementById('transactionItemsList').appendChild(div); 
            },
            updateCategoriesForRows: () => { document.querySelectorAll('.item-cat').forEach(s=>s.innerHTML=state.categories[document.getElementById('tType').value].map(c=>`<option>${c}</option>`).join('')); },
            updateTotal: () => { 
                let s = 0; document.querySelectorAll('.item-amount').forEach(i => s += parseFloat(i.value) || 0); 
                const cur = document.getElementById('tCurrency').value; // Check selected currency
                const rate = parseFloat(document.getElementById('tRate').value) || 1;
                document.getElementById('totalLabel').innerText = `總金額 (${cur})`;
                if (cur !== 'TWD') {
                    document.getElementById('displayTotal').innerText = `${cur} ${s.toLocaleString()}`;
                    document.getElementById('twdPreview').classList.remove('hidden'); document.getElementById('twdPreview').innerText = `≈ NT$ ${Math.round(s * rate).toLocaleString()}`;
                } else { document.getElementById('displayTotal').innerText = `$${s.toLocaleString()}`; document.getElementById('twdPreview').classList.add('hidden'); }
                document.getElementById('itemCount').innerText = document.querySelectorAll('.item-row').length;
            },
            toggleMemberInput: () => { const isG = document.getElementById('newLedgerType').value === 'group'; document.getElementById('memberInputDiv').classList.toggle('hidden', !isG); if(isG) ui.renderMemberCheckboxes(); },
            renderMemberCheckboxes: () => { document.getElementById('memberSelectionList').innerHTML = state.usersList.filter(u=>u!==state.userName).map(u=>`<div class="flex items-center gap-2"><input type="checkbox" id="member-${u}" value="${u}" class="member-checkbox"><label for="member-${u}" class="truncate">${u}</label></div>`).join('') || '<div class="col-span-2 text-center text-gray-400">無其他使用者</div>'; },
            openModal: (id) => document.getElementById(id).classList.remove('hidden'),
            closeModal: (id) => document.getElementById(id).classList.add('hidden'),
            toggleMobileMenu: () => document.getElementById('mobileMenu').classList.toggle('hidden'),
            viewImage: (u) => { const du = app.getDirectDriveUrl(u); document.getElementById('imageViewerSrc').src = du; document.getElementById('imageViewerLink').href = du; ui.openModal('imageViewerModal'); },
            closeImageModal: () => ui.closeModal('imageViewerModal'),
            
            // Updated Render Settings to include Currency List
            renderSettings: () => {
                if(state.currentLedger) document.getElementById('settingLedgerName').innerText = state.currentLedger.name;
                ['expense', 'income'].forEach(t => { document.getElementById(t+'CatList').innerHTML = state.categories[t].map(c => `<span class="inline-flex items-center px-2 py-1 rounded bg-white border text-xs gap-1">${c}<button onclick="app.removeCategory('${t}','${c}')"><i class="fa-solid fa-times"></i></button></span>`).join(''); });
                document.getElementById('merchantListSetting').innerHTML = state.merchants.map(m => `<span class="inline-flex items-center px-2 py-1 rounded bg-white border text-xs gap-1">${m}<button onclick="app.removeMerchant('${m}')\"><i class="fa-solid fa-times"></i></button></span>`).join('');
                document.getElementById('currencyListSetting').innerHTML = state.currencies.map(c => `<span class="inline-flex items-center px-2 py-1 rounded bg-white border text-xs gap-1">${c}<button onclick="app.removeCurrency('${c}')\"><i class="fa-solid fa-times"></i></button></span>`).join('');
            },
            openSettings: () => { ui.renderSettings(); ui.openModal('settingsModal'); },
            openUserProfile: () => { ui.openModal('userProfileModal'); document.getElementById('renameInput').value = state.userName; ui.switchProfileTab('overview'); },
            switchProfileTab: (n) => { ['overview', 'ai-assistant', 'settings', 'assets'].forEach(t => { document.getElementById(`content-${t}`).classList.toggle('hidden', t!==n); document.getElementById(`tab-${t}`).classList.toggle('active', t===n); }); if(n === 'overview') app.loadUserStats(); },
            logout: () => { localStorage.removeItem('acc_username'); location.reload(); }
        };

        window.app = app; window.ui = ui; window.ai = ai;
        app.init();
    </script>
</body>
</html>