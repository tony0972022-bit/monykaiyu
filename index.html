<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºæ…§é›²ç«¯è¨˜å¸³æœ¬ (Proç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6;
            width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #imageViewerModal { transition: opacity 0.3s ease; }
        #imageViewerModal.hidden { opacity: 0; pointer-events: none; }
        #imageViewerModal:not(.hidden) { opacity: 1; pointer-events: auto; }
        
        .archived-ledger { filter: grayscale(1); opacity: 0.7; }
        .archived-ledger:hover { filter: grayscale(0); opacity: 1; }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-800 text-white flex flex-col shadow-xl z-20 hidden md:flex">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-wallet text-emerald-400"></i> AI é›²ç«¯è¨˜å¸³
            </h1>
            <!-- User Profile Trigger -->
            <div id="currentUserDisplay" class="mt-6 p-3 bg-slate-700/50 rounded-xl cursor-pointer hover:bg-slate-700 transition group" onclick="ui.openUserProfile()">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-lg">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-bold text-white group-hover:text-emerald-300 transition truncate"><span id="sidebarUserName">æœªç™»å…¥</span></p>
                        <p class="text-xs text-slate-400">è¨­å®š / åˆ‡æ›</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 flex-1 overflow-y-auto">
            <div class="flex justify-between items-center mb-4 text-slate-400 text-sm font-bold uppercase">
                <span>æˆ‘çš„å¸³æœ¬</span>
                <button onclick="ui.openModal('ledgerModal')" class="hover:text-white transition"><i class="fa-solid fa-plus"></i></button>
            </div>
            <ul id="ledgerList" class="space-y-2"></ul>
            
            <div id="archivedSection" class="mt-6 hidden">
                <div class="text-xs text-slate-500 font-bold uppercase mb-2 border-t border-slate-700 pt-4">å·²æ­¸æª” / çµç®—</div>
                <ul id="archivedLedgerList" class="space-y-2"></ul>
            </div>
        </div>

        <div class="p-4 border-t border-slate-700">
            <button onclick="ui.openModal('settingsModal')" class="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-700 transition text-slate-300 hover:text-white">
                <i class="fa-solid fa-gear"></i> ç³»çµ±è¨­å®š
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative">
        <header class="bg-white p-4 shadow-sm flex justify-between items-center md:hidden">
            <h1 class="font-bold text-lg"><i class="fa-solid fa-wallet text-emerald-500"></i> è¨˜å¸³æœ¬</h1>
            <button onclick="ui.toggleMobileMenu()" class="text-gray-600"><i class="fa-solid fa-bars text-xl"></i></button>
        </header>

        <div class="bg-white border-b border-gray-200 p-6 flex justify-between items-center flex-wrap gap-4">
            <div>
                <h2 id="currentLedgerTitle" class="text-2xl font-bold text-gray-800">è¼‰å…¥ä¸­...</h2>
                <div class="flex flex-wrap items-center gap-2 mt-1">
                    <span id="ledgerTypeBadge" class="hidden px-2 py-0.5 rounded text-xs font-bold bg-blue-100 text-blue-700">å€‹äºº</span>
                    <span id="ledgerStatusBadge" class="hidden px-2 py-0.5 rounded text-xs font-bold bg-gray-200 text-gray-600">å·²æ­¸æª”</span>
                    <p id="ledgerMembers" class="text-gray-500 text-sm hidden"></p>
                    <button id="addMemberBtn" onclick="app.addMemberToLedger()" class="hidden text-emerald-600 hover:text-emerald-700 text-xs px-2 py-0.5 bg-emerald-50 rounded border border-emerald-200 transition" title="æ–°å¢æˆå“¡">
                        <i class="fa-solid fa-user-plus"></i> æ–°å¢æˆå“¡
                    </button>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="settleBtn" onclick="app.calculateDebt()" class="hidden bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow transition flex items-center gap-2 font-medium text-sm">
                    <i class="fa-solid fa-calculator"></i> çµç®—åˆ†å¸³
                </button>
                <button id="addTxBtn" onclick="ui.openTransactionModal()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-lg shadow transition flex items-center gap-2 font-medium">
                    <i class="fa-solid fa-plus"></i> æ–°å¢ç´€éŒ„
                </button>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div><p class="text-gray-500 text-sm font-medium">ç¸½æ”¯å‡º (TWD)</p><p id="totalExpense" class="text-2xl font-bold text-rose-600 mt-1">$0</p></div>
                <div class="w-12 h-12 rounded-full bg-rose-100 flex items-center justify-center text-rose-600"><i class="fa-solid fa-arrow-trend-down"></i></div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div><p class="text-gray-500 text-sm font-medium">ç¸½æ”¶å…¥ (TWD)</p><p id="totalIncome" class="text-2xl font-bold text-emerald-600 mt-1">$0</p></div>
                <div class="w-12 h-12 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600"><i class="fa-solid fa-arrow-trend-up"></i></div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div><p class="text-gray-500 text-sm font-medium">çµé¤˜</p><p id="totalBalance" class="text-2xl font-bold text-blue-600 mt-1">$0</p></div>
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i class="fa-solid fa-wallet"></i></div>
            </div>
        </div>

        <!-- List -->
        <div class="flex-1 overflow-auto p-6 pt-0">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-gray-700">äº¤æ˜“ç´€éŒ„</h3>
                    <div id="loadingIndicator" class="hidden flex items-center gap-2 text-sm text-gray-500">
                        <div class="loader"></div> åŒæ­¥ä¸­...
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-gray-500 text-sm border-b border-gray-100">
                                <th class="p-4 font-medium">æ—¥æœŸ</th>
                                <th class="p-4 font-medium">ä»˜æ¬¾äºº/é …ç›®/åˆ†æ”¤</th>
                                <th class="p-4 font-medium">åŸå¹£é‡‘é¡</th>
                                <th class="p-4 font-medium text-right">å°å¹£é‡‘é¡</th>
                                <th class="p-4 font-medium text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <tr><td colspan="5" class="p-8 text-center text-gray-400">å°šæœªé¸æ“‡å¸³æœ¬æˆ–ç„¡è³‡æ–™</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Image Viewer -->
    <div id="imageViewerModal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center" onclick="ui.closeImageModal()">
        <div class="relative max-w-4xl max-h-[90vh] p-2" onclick="event.stopPropagation()">
            <button onclick="ui.closeImageModal()" class="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300 transition"><i class="fa-solid fa-times"></i></button>
            <img id="imageViewerSrc" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl border-2 border-gray-800" src="">
            <div class="text-center mt-4"><a id="imageViewerLink" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm underline"><i class="fa-solid fa-external-link-alt"></i> é–‹å•ŸåŸåœ–</a></div>
        </div>
    </div>

    <!-- Modal: Login / User Select -->
    <div id="loginModal" class="fixed inset-0 bg-slate-900/95 z-[90] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-8 m-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl"><i class="fa-solid fa-user-group"></i></div>
                <h3 class="text-xl font-bold text-gray-800">è«‹é¸æ“‡æ‚¨çš„èº«åˆ†</h3>
                <p class="text-gray-500 text-sm">å¤šäººå¸³æœ¬å°‡ä¾æ“šæ­¤èº«åˆ†é€²è¡Œåˆ†å¸³</p>
            </div>

            <div id="existingUserSection" class="mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">é¸æ“‡ç¾æœ‰è§’è‰²</label>
                <select id="loginUserSelect" class="w-full p-3 border border-gray-300 rounded-lg mb-3 bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">è¼‰å…¥ä¸­...</option>
                </select>
                <button onclick="app.loginExistingUser()" class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold transition">ç™»å…¥</button>
            </div>

            <div class="relative flex py-2 items-center mb-6">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">æˆ–</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">å»ºç«‹æ–°è§’è‰²</label>
                <div class="flex gap-2">
                    <input type="text" id="newUserNameInput" placeholder="è¼¸å…¥æ–°æš±ç¨±" class="flex-1 p-3 border border-gray-300 rounded-lg text-sm">
                    <button onclick="app.registerNewUser()" class="bg-gray-800 text-white px-4 rounded-lg hover:bg-gray-900 transition">å»ºç«‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: User Profile & Rename -->
    <div id="userProfileModal" class="fixed inset-0 bg-slate-900/90 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 m-4 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-id-card text-indigo-500"></i> å€‹äººä¸­å¿ƒ</h3>
                <button onclick="ui.closeModal('userProfileModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>

            <div class="overflow-y-auto flex-1 pr-2">
                <div class="bg-indigo-50 p-5 rounded-xl mb-6 border border-indigo-100">
                    <label class="block text-xs font-bold text-indigo-800 uppercase mb-2">ä¿®æ”¹åç¨± (æ›´å)</label>
                    <div class="flex gap-2">
                        <input type="text" id="renameInput" placeholder="è¼¸å…¥æ–°åç¨±" class="flex-1 p-3 border border-indigo-200 rounded-lg font-bold text-gray-700">
                        <button onclick="app.renameUser()" id="renameBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 rounded-lg font-bold transition whitespace-nowrap">ç¢ºèªæ›´å</button>
                    </div>
                    <p class="text-xs text-indigo-400 mt-2"><i class="fa-solid fa-circle-exclamation"></i> é€™æœƒå°‡æ‰€æœ‰å¸³æœ¬ä¸­çš„èˆŠåå­—å…¨é¢æ›´æ–°ç‚ºæ–°åå­—ï¼Œè«‹è¬¹æ…æ“ä½œã€‚</p>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-bold text-gray-700"><i class="fa-solid fa-chart-pie"></i> å¸³æœ¬æ¦‚æ³</h4>
                    <button onclick="ui.logout()" class="text-xs text-red-500 hover:underline"><i class="fa-solid fa-right-from-bracket"></i> ç™»å‡º/åˆ‡æ›å¸³è™Ÿ</button>
                </div>
                
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 text-center">
                        <p class="text-xs text-emerald-600 font-bold uppercase mb-1">ç¸½æ”¶å…¥</p>
                        <p id="statTotalIncome" class="text-lg font-bold text-emerald-700">$0</p>
                    </div>
                    <div class="bg-rose-50 p-4 rounded-xl border border-rose-100 text-center">
                        <p class="text-xs text-rose-600 font-bold uppercase mb-1">ç¸½æ”¯å‡º</p>
                        <p id="statTotalExpense" class="text-lg font-bold text-rose-700">$0</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-center">
                        <p class="text-xs text-blue-600 font-bold uppercase mb-1">ç¸½é¤˜é¡</p>
                        <p id="statTotalBalance" class="text-lg font-bold text-blue-700">$0</p>
                    </div>
                </div>
                <div id="statsLoader" class="hidden text-center py-4 text-gray-500"><div class="loader mx-auto mb-2"></div>åˆ†æä¸­...</div>
                <div id="ledgerStatsList" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Settlement & Archive -->
    <div id="settleModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 m-4 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">ğŸ’° çµç®—åˆ†å¸³</h3>
                <button onclick="ui.closeModal('settleModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div id="settleContent" class="space-y-4 mb-6"></div>
            
            <div class="border-t border-gray-100 pt-4 bg-yellow-50 p-4 rounded-lg">
                <h4 class="font-bold text-gray-700 mb-2 flex items-center gap-2"><i class="fa-solid fa-box-archive text-yellow-600"></i> çµç®—ä¸¦æ­¸æª”</h4>
                <p class="text-xs text-gray-500 mb-3">å°‡æ­¤å¸³æœ¬å°å­˜ï¼Œä¸¦å°‡æ‚¨çš„æ‡‰ä»˜é‡‘é¡ ($<span id="settleShareAmount">0</span>) è¨˜éŒ„åˆ°å€‹äººå¸³æœ¬ã€‚</p>
                
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-500 mb-1">é¸æ“‡è¦è¨˜å…¥çš„å€‹äººå¸³æœ¬</label>
                    <select id="targetPersonalLedger" class="w-full p-2 border border-gray-300 rounded text-sm bg-white"></select>
                </div>
                
                <button onclick="app.archiveLedger()" class="w-full py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm font-bold shadow">
                    ç¢ºèªæ­¸æª”ä¸¦è¨˜å¸³
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Settings -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 m-4 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">âš™ï¸ ç³»çµ±è¨­å®š</h3>
                <button onclick="ui.closeModal('settingsModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-4">
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <label class="block text-sm font-bold text-blue-800 mb-1">Google Drive ä¸Šå‚³ç¶²å€</label>
                    <input type="text" id="scriptUrlInput" placeholder="https://script.google.com/macros/s/..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-xs font-mono">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key</label>
                    <input type="password" id="geminiKeyInput" placeholder="è²¼ä¸Šæ‚¨çš„ API Key" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Firebase Config (å·²é–å®š)</label>
                    <textarea id="firebaseConfigInput" rows="4" readonly class="w-full p-3 border border-gray-300 bg-gray-100 rounded-lg font-mono text-xs text-gray-600 cursor-not-allowed"></textarea>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button onclick="ui.closeModal('settingsModal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="app.saveSettings()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- Modal: Password Unlock -->
    <div id="passwordModal" class="fixed inset-0 bg-slate-900/90 z-[70] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 m-4 text-center animate-fade-in">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 text-xl"><i class="fa-solid fa-lock"></i></div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">æ­¤å¸³æœ¬å—å¯†ç¢¼ä¿è­·</h3>
            <input type="password" id="unlockPasswordInput" class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center text-lg" placeholder="â€¢â€¢â€¢â€¢">
            <div class="flex gap-2">
                <button onclick="ui.closeModal('passwordModal')" class="flex-1 py-3 text-gray-500 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="app.verifyPassword()" class="flex-1 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold shadow-lg">è§£é–</button>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 m-4 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="txModalTitle">ğŸ“ æ–°å¢ç´€éŒ„</h3>
                <button onclick="ui.closeModal('transactionModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="uploadContainer" class="mb-4 bg-indigo-50 border border-indigo-100 rounded-xl p-3 text-center relative group">
                <div id="uploadZone">
                    <input type="file" id="receiptUpload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="ai.handleImageUpload(this)">
                    <div id="aiUploadLabel"><i class="fa-solid fa-camera text-indigo-500 text-xl mb-1"></i><p class="text-xs font-medium text-indigo-700">AI æ™ºæ…§è¾¨è­˜</p></div>
                </div>
                <div id="aiLoading" class="hidden relative z-20"><div class="loader mx-auto mb-1 border-indigo-500 border-t-transparent"></div><p class="text-xs text-indigo-600">è¾¨è­˜ä¸­...</p></div>
                <div id="imagePreviewContainer" class="hidden mt-1 relative z-20"><img id="imagePreview" class="h-20 mx-auto rounded object-cover mb-2"><button type="button" onclick="ai.clearImage()" class="px-2 py-1 bg-gray-200 text-gray-600 text-xs rounded-full">æ¸…é™¤ç…§ç‰‡</button></div>
            </div>
            <div id="editHistoryBox" class="hidden mb-4 p-3 bg-gray-50 border border-gray-200 rounded-lg text-xs text-gray-500"><p class="font-bold mb-1">ä¿®è¨‚ç´€éŒ„ï¼š</p><ul id="editHistoryList" class="list-disc pl-4 space-y-1"></ul></div>
            <form id="transactionForm" onsubmit="app.addTransaction(event)" class="space-y-3">
                <div class="space-y-3 bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                    <div id="groupPayerField" class="hidden">
                        <label class="block text-xs font-bold text-yellow-700 uppercase mb-1">ä»˜æ¬¾äºº</label>
                        <select id="tPaidBy" class="w-full p-2 bg-white border border-yellow-200 rounded-lg text-sm mb-2"></select>
                        <label class="block text-xs font-bold text-yellow-700 uppercase mb-1">åˆ†æ”¤å°è±¡ (å–æ¶ˆå‹¾é¸å‰‡ä¸åˆ†æ”¤)</label>
                        <div id="tSplitMembers" class="flex flex-wrap gap-2 text-sm"></div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-yellow-700 uppercase mb-1">å¹£åˆ¥èˆ‡åŒ¯ç‡</label>
                        <div class="flex gap-2">
                            <select id="tCurrency" class="w-1/3 p-2 bg-white border border-yellow-200 rounded-lg text-sm" onchange="app.updateRate()">
                                <option value="TWD">TWD</option><option value="JPY">JPY</option><option value="USD">USD</option><option value="KRW">KRW</option><option value="EUR">EUR</option><option value="CNY">CNY</option>
                            </select>
                            <input type="number" id="tRate" step="0.001" placeholder="åŒ¯ç‡" class="w-2/3 p-2 bg-white border border-yellow-200 rounded-lg text-sm" oninput="app.calcTwd()">
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">é¡å‹</label><select id="tType" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm"><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">æ—¥æœŸ</label><input type="date" id="tDate" required class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm"></div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">é‡‘é¡ <span id="amountLabel" class="font-normal text-gray-400"></span></label>
                    <div class="relative"><input type="number" id="tAmount" required min="0" step="0.01" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-lg font-bold" oninput="app.calcTwd()"><p id="twdPreview" class="text-right text-xs text-emerald-600 mt-1 font-bold hidden">= NT$ <span>0</span></p></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">é …ç›®åç¨±</label><input type="text" id="tName" required placeholder="ä¾‹å¦‚ï¼šåˆé¤" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">åˆ†é¡</label><select id="tCategory" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm"></select></div>
                <input type="hidden" id="hiddenImageUrl"><input type="hidden" id="editingTxId">
                <div class="pt-2"><button type="submit" id="submitBtn" class="w-full py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-bold shadow-md hover:shadow-lg transition">ç¢ºèªå„²å­˜</button></div>
            </form>
        </div>
    </div>

    <div id="ledgerModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 m-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“š å»ºç«‹æ–°å¸³æœ¬</h3>
            <div class="mb-4"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">å¸³æœ¬åç¨±</label><input type="text" id="newLedgerName" placeholder="ä¾‹å¦‚ï¼šæ—¥æœ¬æ—…éŠ" class="w-full p-3 border border-gray-300 rounded-lg"></div>
            <div class="mb-4"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">é è¨­å¹£åˆ¥</label><select id="newLedgerCurrency" class="w-full p-3 border border-gray-300 rounded-lg"><option value="TWD">TWD å°å¹£</option><option value="JPY">JPY æ—¥å¹£</option><option value="USD">USD ç¾é‡‘</option><option value="KRW">KRW</option><option value="EUR">EUR</option><option value="CNY">CNY</option></select></div>
            <div class="mb-4"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">å¯†ç¢¼ä¿è­· (é¸å¡«)</label><input type="password" id="newLedgerPassword" placeholder="ç•™ç©ºå‰‡ä¸è¨­å¯†ç¢¼" class="w-full p-3 border border-gray-300 rounded-lg"></div>
            <div class="mb-4"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">å¸³æœ¬é¡å‹</label><select id="newLedgerType" class="w-full p-3 border border-gray-300 rounded-lg" onchange="ui.toggleMemberInput()"><option value="personal">å€‹äººå¸³æœ¬</option><option value="group">å¤šäººå…±ç”¨</option></select><p id="privacyHint" class="text-xs text-green-600 mt-1"><i class="fa-solid fa-lock"></i> åƒ…è‡ªå·±å¯è¦‹</p></div>
            <div id="memberInputDiv" class="mb-4 hidden"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">æˆå“¡åå–® (é€—è™Ÿåˆ†éš”)</label><input type="text" id="newLedgerMembers" placeholder="æˆ‘, å°æ˜, å°ç¾" class="w-full p-3 border border-gray-300 rounded-lg"><p class="text-xs text-orange-500 mt-1">è«‹è¼¸å…¥æˆå“¡æš±ç¨±</p></div>
            <div class="flex justify-end gap-2 mt-6"><button onclick="ui.closeModal('ledgerModal')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">å–æ¶ˆ</button><button onclick="app.createLedger()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">å»ºç«‹</button></div>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="fixed inset-0 bg-slate-900/95 z-40 hidden flex flex-col p-6 md:hidden">
        <div class="flex justify-end mb-6"><button onclick="ui.toggleMobileMenu()" class="text-white text-2xl"><i class="fa-solid fa-times"></i></button></div>
        <div id="mobileLedgerList" class="space-y-4 text-white text-lg font-medium text-center"></div>
        <button onclick="ui.openModal('settingsModal'); ui.toggleMobileMenu()" class="mt-8 w-full py-3 bg-slate-700 text-slate-200 rounded-lg">è¨­å®š</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, deleteDoc, doc, updateDoc, setDoc, getDoc, getDocs, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDqFr0ZkTb9ZdYFaf8S95pjJLEezTF4QwQ",
            authDomain: "mony-a292c.firebaseapp.com",
            projectId: "mony-a292c",
            storageBucket: "mony-a292c.firebasestorage.app",
            messagingSenderId: "1012872104399",
            appId: "1:1012872104399:web:8289e7b26d846246fdaaba",
            measurementId: "G-N5RQB4GCZD"
        };

        const state = {
            db: null,
            geminiKey: localStorage.getItem('acc_gemini_key') || '',
            scriptUrl: localStorage.getItem('acc_script_url') || 'https://script.google.com/macros/s/AKfycbxY6Rsu-YbelHECVROC6xQK3vh-8qTzRDKAj29iDPOwbPmNKawSB42tF7UE1tbSQJy6cw/exec',
            userName: localStorage.getItem('acc_username') || '',
            ledgers: [], 
            currentLedger: null,
            transactions: [],
            usersList: [],
            unsubscribeTrans: null,
            unsubscribeLedgers: null,
            isOnline: false,
            currentImage: null,
            rates: { TWD: 1, JPY: 0.22, USD: 31.5, KRW: 0.024, EUR: 34.5, CNY: 4.4 },
            unlockedLedgers: [],
            pendingLedgerId: null
        };

        const CATEGORIES = {
            expense: ['é£²é£Ÿ', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'æ•™è‚²', 'å…¶ä»–'],
            income: ['è–ªæ°´', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–']
        };

        const app = {
            init: async () => {
                document.getElementById('geminiKeyInput').value = state.geminiKey;
                document.getElementById('scriptUrlInput').value = state.scriptUrl;
                document.getElementById('firebaseConfigInput').value = JSON.stringify(FIREBASE_CONFIG, null, 2);
                
                app.fetchRates();
                await app.connectFirebase(FIREBASE_CONFIG);
                document.getElementById('tDate').valueAsDate = new Date();
                ui.updateCategories();

                if (!state.userName) {
                    await app.loadUsersList();
                    document.getElementById('loginModal').classList.remove('hidden');
                } else {
                    document.getElementById('sidebarUserName').innerText = state.userName;
                    document.getElementById('renameInput').value = state.userName;
                    app.listenLedgers();
                }
            },

            loadUsersList: async () => {
                const q = query(collection(state.db, "users"));
                const snapshot = await getDocs(q);
                state.usersList = [];
                const select = document.getElementById('loginUserSelect');
                select.innerHTML = '<option value="">è«‹é¸æ“‡è§’è‰²...</option>';
                snapshot.forEach(doc => {
                    state.usersList.push(doc.id);
                    select.innerHTML += `<option value="${doc.id}">${doc.id}</option>`;
                });
                if(state.usersList.length === 0) document.getElementById('existingUserSection').classList.add('hidden');
            },

            loginExistingUser: () => {
                const name = document.getElementById('loginUserSelect').value;
                if(!name) return alert("è«‹é¸æ“‡ä¸€å€‹è§’è‰²");
                app.performLogin(name);
            },

            registerNewUser: async () => {
                const name = document.getElementById('newUserNameInput').value.trim();
                if(!name) return alert("è«‹è¼¸å…¥åç¨±");
                const docRef = doc(state.db, "users", name);
                const docSnap = await getDoc(docRef);
                if(docSnap.exists()) return alert("æ­¤åç¨±å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸Šæ–¹é¸å–®ç™»å…¥");
                await setDoc(docRef, { createdAt: new Date().toISOString() });
                app.performLogin(name);
            },

            performLogin: (name) => {
                state.userName = name;
                localStorage.setItem('acc_username', name);
                document.getElementById('sidebarUserName').innerText = name;
                document.getElementById('renameInput').value = name;
                document.getElementById('loginModal').classList.add('hidden');
                app.listenLedgers();
            },

            renameUser: async () => {
                const newName = document.getElementById('renameInput').value.trim();
                const oldName = state.userName;
                const btn = document.getElementById('renameBtn');
                if(!newName || newName === oldName) return;
                if(!confirm(`ç¢ºå®šå°‡ "${oldName}" æ”¹åç‚º "${newName}"ï¼Ÿé€™æœƒæ›´æ–°æ‰€æœ‰è³‡æ–™ã€‚`)) return;

                btn.disabled = true; btn.innerHTML = 'æ›´æ–°ä¸­...';
                try {
                    const newUserRef = doc(state.db, "users", newName);
                    const newSnap = await getDoc(newUserRef);
                    if(newSnap.exists()) throw new Error("è©²åç¨±å·²è¢«ä½¿ç”¨");

                    const batch = writeBatch(state.db);
                    batch.set(newUserRef, { createdAt: new Date().toISOString() });

                    const qLedgers = query(collection(state.db, "ledgers"), where("members", "array-contains", oldName));
                    const ledgersSnap = await getDocs(qLedgers);
                    ledgersSnap.forEach(doc => {
                        const data = doc.data();
                        const newMembers = data.members.map(m => m === oldName ? newName : m);
                        const updates = { members: newMembers };
                        if(data.createdBy === oldName) updates.createdBy = newName;
                        batch.update(doc.ref, updates);
                    });

                    const qTxPaid = query(collection(state.db, "transactions"), where("paidBy", "==", oldName));
                    const txPaidSnap = await getDocs(qTxPaid);
                    txPaidSnap.forEach(doc => batch.update(doc.ref, { paidBy: newName }));

                    // Update splitWith array
                    const qTxSplit = query(collection(state.db, "transactions"), where("splitWith", "array-contains", oldName));
                    const txSplitSnap = await getDocs(qTxSplit);
                    txSplitSnap.forEach(doc => {
                        const data = doc.data();
                        if (data.splitWith) {
                            const newSplit = data.splitWith.map(m => m === oldName ? newName : m);
                            batch.update(doc.ref, { splitWith: newSplit });
                        }
                    });

                    const qTxEdit = query(collection(state.db, "transactions"), where("lastEditedBy", "==", oldName));
                    const txEditSnap = await getDocs(qTxEdit);
                    txEditSnap.forEach(doc => batch.update(doc.ref, { lastEditedBy: newName }));

                    batch.delete(doc(state.db, "users", oldName));
                    await batch.commit();

                    alert("æ›´åæˆåŠŸï¼");
                    app.performLogin(newName);
                    location.reload();
                } catch(e) { alert("æ›´åå¤±æ•—ï¼š" + e.message); btn.disabled = false; btn.innerHTML = 'ç¢ºèªæ›´å'; }
            },

            addMemberToLedger: async () => {
                const name = prompt("è«‹è¼¸å…¥æ–°æˆå“¡çš„æš±ç¨±ï¼š");
                if(!name) return;
                if(state.currentLedger.members.includes(name)) return alert("è©²æˆå“¡å·²åœ¨åå–®ä¸­");
                
                try {
                    const newMembers = [...state.currentLedger.members, name];
                    await updateDoc(doc(state.db, "ledgers", state.currentLedger.id), { members: newMembers });
                } catch(e) { alert("æ–°å¢å¤±æ•—:" + e.message); }
            },

            archiveLedger: async () => {
                if(!state.currentLedger) return;
                const personalLedgerId = document.getElementById('targetPersonalLedger').value;
                if(!personalLedgerId) return alert("è«‹é¸æ“‡ä¸€å€‹å€‹äººå¸³æœ¬");
                const shareAmount = parseInt(document.getElementById('settleShareAmount').innerText.replace(/,/g, '')) || 0;
                
                try {
                    const batch = writeBatch(state.db);
                    batch.update(doc(state.db, "ledgers", state.currentLedger.id), { status: 'archived' });
                    if (shareAmount > 0) {
                        const newTxRef = doc(collection(state.db, "transactions"));
                        batch.set(newTxRef, {
                            ledgerId: personalLedgerId,
                            type: 'expense',
                            date: new Date().toISOString().split('T')[0],
                            amount: shareAmount,
                            originalAmount: shareAmount,
                            currency: 'TWD',
                            exchangeRate: 1,
                            name: `${state.currentLedger.name} (åˆ†å¸³)`,
                            category: 'å¨›æ¨‚',
                            createdAt: new Date().toISOString(),
                            lastEditedBy: state.userName
                        });
                    }
                    await batch.commit();
                    alert("æ­¸æª”æˆåŠŸï¼");
                    ui.closeModal('settleModal');
                } catch(e) { alert("æ­¸æª”å¤±æ•—ï¼š" + e.message); }
            },

            fetchRates: async () => {
                try {
                    const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                    const data = await res.json();
                    if(data && data.rates) {
                        state.rates = {
                            TWD: 1, JPY: 1 / data.rates.JPY, USD: 1 / data.rates.USD, KRW: 1 / data.rates.KRW, EUR: 1 / data.rates.EUR, CNY: 1 / data.rates.CNY
                        };
                    }
                } catch(e) {}
            },

            connectFirebase: async (config) => {
                try {
                    const firebaseApp = initializeApp(config);
                    state.db = getFirestore(firebaseApp);
                    try { await enableIndexedDbPersistence(state.db); } catch (e) {}
                    state.isOnline = true;
                } catch (e) { console.error("Firebase Error:", e); alert("é€£ç·šå¤±æ•—"); }
            },

            saveSettings: () => {
                localStorage.setItem('acc_gemini_key', document.getElementById('geminiKeyInput').value.trim());
                localStorage.setItem('acc_script_url', document.getElementById('scriptUrlInput').value.trim());
                location.reload();
            },

            listenLedgers: () => {
                if (state.unsubscribeLedgers) state.unsubscribeLedgers();
                const q = query(collection(state.db, "ledgers"));
                state.unsubscribeLedgers = onSnapshot(q, (snapshot) => {
                    const allLedgers = [];
                    snapshot.forEach(doc => allLedgers.push({ id: doc.id, ...doc.data() }));
                    state.ledgers = allLedgers.filter(l => {
                        if (l.type === 'personal') return l.createdBy === state.userName;
                        else return l.members && l.members.includes(state.userName);
                    });
                    state.ledgers.sort((a, b) => (a.status === 'archived' ? 1 : 0) - (b.status === 'archived' ? 1 : 0));
                    const lastId = localStorage.getItem('acc_current_ledger');
                    const activeLedgers = state.ledgers.filter(l => l.status !== 'archived');
                    if (lastId && state.ledgers.find(l => l.id === lastId)) ui.switchLedger(lastId);
                    else if (activeLedgers.length > 0) ui.switchLedger(activeLedgers[0].id);
                    else {
                        state.currentLedger = null;
                        document.getElementById('currentLedgerTitle').innerText = "ç„¡å¯ç”¨å¸³æœ¬";
                        document.getElementById('ledgerList').innerHTML = '<li class="text-center text-sm text-gray-400 mt-4">è«‹å»ºç«‹æ–°å¸³æœ¬</li>';
                        state.transactions = []; ui.renderTransactions();
                    }
                    ui.renderLedgerList();
                });
            },

            createLedger: async () => {
                const name = document.getElementById('newLedgerName').value.trim();
                const type = document.getElementById('newLedgerType').value;
                const currency = document.getElementById('newLedgerCurrency').value;
                const password = document.getElementById('newLedgerPassword').value.trim();
                const membersStr = document.getElementById('newLedgerMembers').value.trim();
                if (!name) return alert("è«‹è¼¸å…¥åç¨±");
                if (type === 'group' && !membersStr) return alert("å¤šäººå¸³æœ¬è«‹è¼¸å…¥æˆå“¡");
                let members = [];
                if (type === 'group') {
                    members = membersStr.split(/[,ï¼Œ]/).map(m => m.trim()).filter(m => m);
                    if (!members.includes(state.userName)) members.push(state.userName);
                }
                try {
                    const newLedger = { name, type, members, defaultCurrency: currency, password, createdBy: state.userName, status: 'active', createdAt: new Date().toISOString() };
                    const docRef = await addDoc(collection(state.db, "ledgers"), newLedger);
                    if (password) state.unlockedLedgers.push(docRef.id);
                    ui.closeModal('ledgerModal');
                    ui.switchLedger(docRef.id);
                    document.getElementById('newLedgerName').value = '';
                    document.getElementById('newLedgerMembers').value = '';
                } catch (e) { alert("å»ºç«‹å¤±æ•—ï¼š" + e.message); }
            },
            
            verifyPassword: () => {
                const input = document.getElementById('unlockPasswordInput').value;
                const targetId = state.pendingLedgerId;
                const ledger = state.ledgers.find(l => l.id === targetId);
                if (ledger && input === ledger.password) {
                    state.unlockedLedgers.push(targetId);
                    ui.closeModal('passwordModal');
                    ui.switchLedger(targetId);
                } else { alert('å¯†ç¢¼éŒ¯èª¤'); document.getElementById('unlockPasswordInput').value = ''; }
            },

            listenTransactions: () => {
                if (!state.currentLedger) return;
                if (state.unsubscribeTrans) state.unsubscribeTrans();
                const loader = document.getElementById('loadingIndicator');
                loader.classList.remove('hidden');
                const q = query(collection(state.db, "transactions"), where("ledgerId", "==", state.currentLedger.id));
                state.unsubscribeTrans = onSnapshot(q, (snapshot) => {
                    state.transactions = [];
                    snapshot.forEach((doc) => state.transactions.push({ id: doc.id, ...doc.data() }));
                    state.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    ui.renderTransactions();
                    loader.classList.add('hidden');
                });
            },

            addTransaction: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('submitBtn');
                btn.disabled = true; btn.innerHTML = 'è™•ç†ä¸­...';
                
                let driveUrl = document.getElementById('hiddenImageUrl').value;
                if (state.currentImage && state.scriptUrl) {
                    try {
                        const res = await fetch(state.scriptUrl, { method: 'POST', body: JSON.stringify({ image: state.currentImage.base64, mimeType: state.currentImage.mimeType, filename: `receipt_${Date.now()}.jpg` }) });
                        const resData = await res.json();
                        if (resData.status === 'success') driveUrl = resData.url;
                    } catch (err) { console.error("Upload failed", err); }
                }

                const editingId = document.getElementById('editingTxId').value;
                const type = document.getElementById('tType').value;
                const isGroup = state.currentLedger?.type === 'group';
                
                let amountTWD = parseFloat(document.getElementById('tAmount').value);
                let originalAmount = amountTWD;
                let currency = 'TWD';
                let rate = 1;
                let paidBy = '';
                let splitWith = []; 

                if (isGroup) {
                    currency = document.getElementById('tCurrency').value;
                    rate = parseFloat(document.getElementById('tRate').value) || 1;
                    if (currency !== 'TWD') { originalAmount = amountTWD; amountTWD = Math.round(originalAmount * rate); }
                    paidBy = document.getElementById('tPaidBy').value;
                    
                    const checkboxes = document.querySelectorAll('#tSplitMembers input[type="checkbox"]:checked');
                    checkboxes.forEach(cb => splitWith.push(cb.value));
                    if(splitWith.length === 0) return alert("è‡³å°‘è¦é¸æ“‡ä¸€ä½åˆ†æ”¤å°è±¡");
                }

                const txData = {
                    ledgerId: state.currentLedger.id,
                    type, date: document.getElementById('tDate').value,
                    amount: amountTWD, originalAmount, currency, exchangeRate: rate,
                    paidBy, splitWith, // Save split list
                    name: document.getElementById('tName').value, category: document.getElementById('tCategory').value,
                    imageUrl: driveUrl, lastEditedBy: state.userName, lastEditedAt: new Date().toISOString()
                };

                try {
                    if (editingId) {
                        const oldTx = state.transactions.find(t => t.id === editingId);
                        const editLog = { editor: state.userName, date: new Date().toISOString(), oldAmount: oldTx.amount, newAmount: amountTWD };
                        const history = oldTx.editHistory || []; history.push(editLog);
                        await updateDoc(doc(state.db, "transactions", editingId), { ...txData, editHistory: history });
                    } else {
                        await addDoc(collection(state.db, "transactions"), { ...txData, createdAt: new Date().toISOString() });
                    }
                    ui.closeModal('transactionModal'); ai.clearImage();
                } catch (err) { alert("éŒ¯èª¤ï¼š" + err.message); } 
                finally { btn.disabled = false; btn.innerHTML = 'ç¢ºèªå„²å­˜'; }
            },

            editTransaction: (id) => {
                const tx = state.transactions.find(t => t.id === id);
                if (!tx) return;
                ui.openTransactionModal('ç·¨è¼¯ç´€éŒ„');
                document.getElementById('editingTxId').value = tx.id;
                document.getElementById('tType').value = tx.type;
                ui.updateCategories();
                document.getElementById('tDate').value = tx.date;
                document.getElementById('tName').value = tx.name;
                document.getElementById('tCategory').value = tx.category;
                document.getElementById('hiddenImageUrl').value = tx.imageUrl || '';

                if (state.currentLedger.type === 'group') {
                    document.getElementById('tCurrency').value = tx.currency || 'TWD';
                    document.getElementById('tRate').value = tx.exchangeRate || 1;
                    document.getElementById('tAmount').value = tx.currency !== 'TWD' ? tx.originalAmount : tx.amount;
                    document.getElementById('tPaidBy').value = tx.paidBy || state.userName;
                    
                    const boxes = document.querySelectorAll('#tSplitMembers input[type="checkbox"]');
                    boxes.forEach(box => {
                        box.checked = !tx.splitWith || tx.splitWith.includes(box.value);
                    });
                    
                    app.updateRate(false);
                } else {
                    document.getElementById('tAmount').value = tx.amount;
                }
                const historyBox = document.getElementById('editHistoryBox');
                const historyList = document.getElementById('editHistoryList');
                if (tx.editHistory && tx.editHistory.length > 0) {
                    historyBox.classList.remove('hidden');
                    historyList.innerHTML = tx.editHistory.map(h => `<li>${h.date.split('T')[0]} ${h.editor} ä¿®æ”¹</li>`).join('');
                } else { historyBox.classList.add('hidden'); }
            },

            deleteTransaction: async (id) => { if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await deleteDoc(doc(state.db, "transactions", id)); },

            updateRate: (resetValue = true) => {
                const cur = document.getElementById('tCurrency').value;
                const rateInput = document.getElementById('tRate');
                const label = document.getElementById('amountLabel');
                if (resetValue) rateInput.value = state.rates[cur] ? state.rates[cur].toFixed(3) : 1;
                label.innerText = cur === 'TWD' ? '(å°å¹£)' : `(${cur} åŸå¹£)`;
                app.calcTwd();
            },

            calcTwd: () => {
                const cur = document.getElementById('tCurrency').value;
                const amt = parseFloat(document.getElementById('tAmount').value) || 0;
                const rate = parseFloat(document.getElementById('tRate').value) || 1;
                const preview = document.getElementById('twdPreview');
                if (cur !== 'TWD') {
                    preview.classList.remove('hidden'); preview.querySelector('span').innerText = Math.round(amt * rate).toLocaleString();
                } else { preview.classList.add('hidden'); }
            },

            calculateDebt: () => {
                if (!state.currentLedger || state.currentLedger.type !== 'group') return;
                const members = state.currentLedger.members;
                const currentUser = state.userName;
                const balances = {}; // Track Net Balance
                const paidMap = {}; // Track Total Paid by each
                
                members.forEach(m => { balances[m] = 0; paidMap[m] = 0; });
                
                let totalGroupExpense = 0;
                let userPaidTotal = 0;

                state.transactions.forEach(t => {
                    if (t.type === 'expense') {
                        const splitters = t.splitWith && t.splitWith.length > 0 ? t.splitWith : members;
                        if(!members.includes(t.paidBy)) return;

                        balances[t.paidBy] += t.amount;
                        paidMap[t.paidBy] += t.amount; // Track gross paid
                        
                        totalGroupExpense += t.amount;
                        if(t.paidBy === currentUser) userPaidTotal += t.amount;

                        const share = t.amount / splitters.length;
                        splitters.forEach(member => {
                            if(balances[member] !== undefined) balances[member] -= share;
                        });
                    }
                });

                const userNet = balances[currentUser] || 0;
                const creditors = members.filter(m => balances[m] > 1).map(m => ({name: m, amount: balances[m]})).sort((a,b) => b.amount - a.amount);
                const debtors = members.filter(m => balances[m] < -1).map(m => ({name: m, amount: balances[m]})).sort((a,b) => a.amount - b.amount);

                // My share for archive
                const myTotalCost = userPaidTotal - userNet;
                document.getElementById('settleShareAmount').innerText = Math.round(myTotalCost > 0 ? myTotalCost : 0).toLocaleString();

                const personalLedgers = state.ledgers.filter(l => l.type === 'personal');
                const select = document.getElementById('targetPersonalLedger');
                select.innerHTML = personalLedgers.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                if(personalLedgers.length === 0) select.innerHTML = '<option value="">ç„¡å€‹äººå¸³æœ¬</option>';

                // Generate Detailed Table
                let detailsHtml = `<table class="w-full text-xs mb-4 text-gray-600 border-collapse">
                    <tr class="border-b"><th class="text-left py-1">æˆå“¡</th><th class="text-right">å·²ä»˜(å¢Š)</th><th class="text-right">æ‡‰ä»˜(åˆ†æ”¤)</th><th class="text-right">æ·¨é¡</th></tr>`;
                
                members.forEach(m => {
                    const paid = paidMap[m];
                    const net = balances[m];
                    const share = paid - net; // Derived share
                    const netClass = net >= 0 ? 'text-emerald-600' : 'text-rose-600';
                    const netSign = net >= 0 ? '+' : '';
                    
                    detailsHtml += `
                    <tr class="border-b border-gray-100 last:border-0">
                        <td class="py-1 font-bold ${m === currentUser ? 'text-indigo-600' : ''}">${m}</td>
                        <td class="text-right">$${Math.round(paid).toLocaleString()}</td>
                        <td class="text-right">$${Math.round(share).toLocaleString()}</td>
                        <td class="text-right font-bold ${netClass}">${netSign}$${Math.round(net).toLocaleString()}</td>
                    </tr>`;
                });
                detailsHtml += `</table>`;

                let resultHtml = `
                    <div class="bg-gray-50 p-4 rounded-lg mb-4 text-center">
                        <div class="text-2xl font-bold ${userNet >= 0 ? 'text-emerald-600' : 'text-rose-600'}">
                            ${userNet >= 0 ? 'æ‡‰æ”¶' : 'æ‡‰ä»˜'} NT$ ${Math.round(Math.abs(userNet)).toLocaleString()}
                        </div>
                    </div>
                    ${detailsHtml}
                    <h4 class="font-bold text-gray-700 mb-2 border-b pb-1">å»ºè­°è½‰å¸³æ¸…å–®ï¼š</h4>
                    <ul class="space-y-3 mb-2">`;

                if (creditors.length === 0) resultHtml += `<li class="text-center text-green-600">å¸³ç›®å¹³è¡¡</li>`;
                else {
                    let c=0, d=0;
                    while(c<creditors.length && d<debtors.length) {
                        const amt = Math.min(creditors[c].amount, Math.abs(debtors[d].amount));
                        if(amt < 1) break;
                        
                        const debtorName = debtors[d].name;
                        const creditorName = creditors[c].name;
                        const isMeInvolved = debtorName === currentUser || creditorName === currentUser;
                        const rowClass = isMeInvolved ? (debtorName === currentUser ? 'border-l-4 border-rose-500 bg-white' : 'border-l-4 border-emerald-500 bg-white') : 'bg-gray-50 opacity-75';

                        resultHtml += `<li class="flex justify-between p-3 rounded shadow-sm ${rowClass} items-center">
                            <div class="flex items-center gap-2">
                                <span class="font-bold ${debtorName===currentUser?'text-rose-600':''}">${debtorName}</span>
                                <i class="fa-solid fa-arrow-right text-gray-400 text-xs"></i>
                                <span class="font-bold ${creditorName===currentUser?'text-emerald-600':''}">${creditorName}</span>
                            </div>
                            <span class="font-bold text-gray-700">NT$ ${Math.round(amt).toLocaleString()}</span>
                        </li>`;
                        
                        creditors[c].amount -= amt; debtors[d].amount += amt;
                        if(Math.abs(creditors[c].amount) < 1) c++; if(Math.abs(debtors[d].amount) < 1) d++;
                    }
                }
                resultHtml += `</ul>`;
                document.getElementById('settleContent').innerHTML = resultHtml;
                ui.openModal('settleModal');
            }
        };

        const ai = {
            handleImageUpload: (input) => {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async () => {
                    const base64 = reader.result.split(',')[1];
                    state.currentImage = { base64, mimeType: file.type };
                    document.getElementById('imagePreview').src = reader.result;
                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                    document.getElementById('uploadZone').classList.add('hidden');
                    if(state.geminiKey) await ai.process(base64, file.type);
                };
                reader.readAsDataURL(file);
            },
            process: async (base64, mimeType) => {
                const loader = document.getElementById('aiLoading');
                loader.classList.remove('hidden');
                try {
                    const prompt = `Analyze receipt. Extract JSON: { "amount": number, "currency": "string (TWD, JPY, USD, KRW, EUR, CNY)", "date": "YYYY-MM-DD", "name": "string", "category": "string" }. Rules: If currency symbol is Â¥, determine if JPY or CNY based on text, default JPY. Map item to closest category in [é£²é£Ÿ, äº¤é€š, è³¼ç‰©, å¨›æ¨‚, å±…ä½, é†«ç™‚, æ•™è‚², å…¶ä»–].`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${state.geminiKey}`, { method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: mimeType, data: base64 } }] }] }) });
                    const data = await res.json();
                    
                    if (data.error) { throw new Error(data.error.message); }

                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    const json = JSON.parse(text.match(/\{[\s\S]*\}/)[0]);
                    document.getElementById('tAmount').value = json.amount || '';
                    document.getElementById('tName').value = json.name || '';
                    if(json.date) document.getElementById('tDate').value = json.date;
                    if (json.currency && state.rates[json.currency]) { document.getElementById('tCurrency').value = json.currency; app.updateRate(); }
                    const catSelect = document.getElementById('tCategory');
                    for(let i=0; i<catSelect.options.length; i++) { if (catSelect.options[i].value === json.category) { catSelect.selectedIndex = i; break; } }
                } catch(e) { 
                    console.error(e); 
                    alert("AI è¾¨è­˜å¤±æ•—ï¼š" + (e.message || "æœªçŸ¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ API Key")); 
                } finally { loader.classList.add('hidden'); }
            },
            clearImage: () => {
                state.currentImage = null;
                document.getElementById('receiptUpload').value = '';
                document.getElementById('imagePreviewContainer').classList.add('hidden');
                document.getElementById('uploadZone').classList.remove('hidden');
            }
        };

        const ui = {
            renderLedgerList: () => {
                const list = document.getElementById('ledgerList');
                const archivedList = document.getElementById('archivedLedgerList');
                const archivedSection = document.getElementById('archivedSection');
                list.innerHTML = ''; archivedList.innerHTML = '';
                let hasArchived = false;
                state.ledgers.forEach(l => {
                    const icon = l.type === 'group' ? 'fa-users' : 'fa-book';
                    const isLocked = l.password && !state.unlockedLedgers.includes(l.id);
                    const lockIcon = isLocked ? '<i class="fa-solid fa-lock text-xs ml-1 opacity-70"></i>' : '';
                    const html = `<li><button onclick="ui.switchLedger('${l.id}')" class="w-full text-left px-4 py-3 rounded-lg flex items-center justify-between transition ${l.id === state.currentLedger?.id ? 'bg-emerald-600 text-white shadow-lg' : (l.status === 'archived' ? 'text-slate-500 hover:bg-slate-700 hover:text-white archived-ledger' : 'text-slate-300 hover:bg-slate-700 hover:text-white')}"><span class="truncate"><i class="fa-solid ${icon} mr-2"></i> ${l.name}</span><span>${lockIcon}</span></button></li>`;
                    if (l.status === 'archived') { archivedList.innerHTML += html; hasArchived = true; } else { list.innerHTML += html; }
                });
                if (hasArchived) archivedSection.classList.remove('hidden'); else archivedSection.classList.add('hidden');
            },

            switchLedger: (id) => {
                const ledger = state.ledgers.find(l => l.id === id);
                if(!ledger) return;
                if (ledger.password && !state.unlockedLedgers.includes(id)) { state.pendingLedgerId = id; document.getElementById('unlockPasswordInput').value = ''; ui.openModal('passwordModal'); return; }
                state.currentLedger = ledger;
                localStorage.setItem('acc_current_ledger', id);
                document.getElementById('currentLedgerTitle').innerText = state.currentLedger.name;
                const isGroup = state.currentLedger.type === 'group';
                const isArchived = state.currentLedger.status === 'archived';
                document.getElementById('ledgerTypeBadge').className = isGroup ? "px-2 py-0.5 rounded text-xs font-bold bg-purple-100 text-purple-700 block" : "hidden";
                document.getElementById('ledgerTypeBadge').innerText = isGroup ? 'å¤šäººå…±ç”¨' : '';
                document.getElementById('ledgerStatusBadge').className = isArchived ? "px-2 py-0.5 rounded text-xs font-bold bg-gray-200 text-gray-600 block" : "hidden";
                
                const membersText = document.getElementById('ledgerMembers');
                const addMemberBtn = document.getElementById('addMemberBtn');
                if (isGroup) {
                    membersText.innerText = state.currentLedger.members.join(', ');
                    membersText.classList.remove('hidden');
                    document.getElementById('settleBtn').classList.remove('hidden');
                    document.getElementById('tPaidBy').innerHTML = state.currentLedger.members.map(m => `<option value="${m}">${m}</option>`).join('');
                    document.getElementById('groupPayerField').classList.remove('hidden');
                    
                    const splitDiv = document.getElementById('tSplitMembers');
                    splitDiv.innerHTML = state.currentLedger.members.map(m => `
                        <label class="flex items-center space-x-1 bg-white border border-gray-200 rounded px-2 py-1 cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="${m}" checked class="form-checkbox h-3 w-3 text-emerald-600 rounded">
                            <span>${m}</span>
                        </label>
                    `).join('');
                    
                    addMemberBtn.classList.remove('hidden'); 
                } else {
                    membersText.classList.add('hidden');
                    document.getElementById('settleBtn').classList.add('hidden');
                    document.getElementById('groupPayerField').classList.add('hidden');
                    addMemberBtn.classList.add('hidden');
                }
                if(isArchived) { document.getElementById('addTxBtn').classList.add('hidden'); addMemberBtn.classList.add('hidden'); }
                else document.getElementById('addTxBtn').classList.remove('hidden');
                ui.renderLedgerList();
                app.listenTransactions();
            },

            renderTransactions: () => {
                const tbody = document.getElementById('transactionTableBody');
                let income = 0, expense = 0;
                if (state.transactions.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-gray-400"><i class="fa-solid fa-file-invoice text-4xl mb-2 block"></i>æš«ç„¡è³‡æ–™</td></tr>`; } 
                else {
                    tbody.innerHTML = state.transactions.map(t => {
                        const isExp = t.type === 'expense';
                        if (isExp) expense += t.amount; else income += t.amount;
                        let detailHtml = t.name;
                        let amountHtml = `NT$ ${Math.round(t.amount).toLocaleString()}`;
                        let originalHtml = '-';
                        if (t.currency && t.currency !== 'TWD') originalHtml = `${t.currency} ${t.originalAmount.toLocaleString()}`;
                        if (state.currentLedger.type === 'group' && t.paidBy) {
                            detailHtml += `<br><span class="text-xs text-gray-400"><i class="fa-solid fa-user"></i> ${t.paidBy}`;
                            if(t.splitWith && t.splitWith.length > 0 && t.splitWith.length < state.currentLedger.members.length) {
                                detailHtml += ` <i class="fa-solid fa-arrow-right mx-1"></i> ${t.splitWith.length}äºº`;
                            }
                            detailHtml += `</span>`;
                        }
                        const editedIndicator = t.editHistory ? `<i class="fa-solid fa-pen-to-square text-xs text-orange-300 ml-1" title="æœ‰ç·¨è¼¯ç´€éŒ„"></i>` : '';
                        const imgBtn = t.imageUrl ? `<button onclick="ui.viewImage('${t.imageUrl}')" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fa-solid fa-image"></i></button>` : '';
                        const isArchived = state.currentLedger.status === 'archived';
                        const actionBtns = isArchived ? '<span class="text-xs text-gray-400">å·²é–å®š</span>' : `<button onclick="app.editTransaction('${t.id}')" class="text-gray-300 hover:text-blue-500 transition mr-2"><i class="fa-solid fa-pen"></i></button><button onclick="app.deleteTransaction('${t.id}')" class="text-gray-300 hover:text-rose-500 transition"><i class="fa-solid fa-trash"></i></button>`;
                        return `<tr class="border-b border-gray-50 hover:bg-gray-50 transition group"><td class="p-4 text-gray-600 text-sm whitespace-nowrap">${t.date}</td><td class="p-4"><div class="font-medium text-gray-800 flex items-center">${detailHtml} ${editedIndicator}</div><span class="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">${t.category}</span></td><td class="p-4 text-gray-500 text-sm">${originalHtml}</td><td class="p-4 text-right font-bold ${isExp ? 'text-rose-600' : 'text-emerald-600'}">${isExp ? '-' : '+'}${amountHtml}</td><td class="p-4 text-center">${imgBtn} ${actionBtns}</td></tr>`;
                    }).join('');
                }
                document.getElementById('totalIncome').innerText = `$${Math.round(income).toLocaleString()}`;
                document.getElementById('totalExpense').innerText = `$${Math.round(expense).toLocaleString()}`;
                document.getElementById('totalBalance').innerText = `$${Math.round(income - expense).toLocaleString()}`;
            },

            openTransactionModal: (title = 'æ–°å¢ç´€éŒ„') => {
                document.getElementById('txModalTitle').innerText = title;
                document.getElementById('transactionForm').reset();
                document.getElementById('editingTxId').value = '';
                document.getElementById('editHistoryBox').classList.add('hidden');
                document.getElementById('tDate').valueAsDate = new Date();
                
                if (state.currentLedger.type === 'group') {
                    const boxes = document.querySelectorAll('#tSplitMembers input[type="checkbox"]');
                    boxes.forEach(box => box.checked = true);
                }

                if (state.currentLedger && state.currentLedger.defaultCurrency) { document.getElementById('tCurrency').value = state.currentLedger.defaultCurrency; app.updateRate(); } else { document.getElementById('tCurrency').value = 'TWD'; app.updateRate(); }
                ui.openModal('transactionModal');
            },

            toggleMemberInput: () => {
                const type = document.getElementById('newLedgerType').value;
                const div = document.getElementById('memberInputDiv');
                const hint = document.getElementById('privacyHint');
                if (type === 'group') { div.classList.remove('hidden'); hint.innerHTML = '<i class="fa-solid fa-users"></i> åªæœ‰åå–®å…§çš„æˆå“¡çœ‹å¾—åˆ°'; } 
                else { div.classList.add('hidden'); hint.innerHTML = '<i class="fa-solid fa-lock"></i> åªæœ‰æ‚¨çœ‹å¾—åˆ°æ­¤å¸³æœ¬'; }
            },
            
            editUser: () => ui.openUserProfile(),
            openUserProfile: () => { document.getElementById('userProfileModal').classList.remove('hidden'); document.getElementById('renameInput').value = state.userName; app.loadUserStats(); },
            logout: () => { localStorage.removeItem('acc_username'); location.reload(); },
            viewImage: (url) => { document.getElementById('imageViewerSrc').src = url; document.getElementById('imageViewerLink').href = url; document.getElementById('imageViewerModal').classList.remove('hidden'); },
            closeImageModal: () => { document.getElementById('imageViewerModal').classList.add('hidden'); document.getElementById('imageViewerSrc').src = ''; },
            updateCategories: () => { const type = document.getElementById('tType').value; document.getElementById('tCategory').innerHTML = CATEGORIES[type].map(c => `<option value="${c}">${c}</option>`).join(''); },
            openModal: (id) => document.getElementById(id).classList.remove('hidden'),
            closeModal: (id) => document.getElementById(id).classList.add('hidden'),
            toggleMobileMenu: () => document.getElementById('mobileMenu').classList.toggle('hidden')
        };

        window.app = app; window.ui = ui; window.ai = ai;
        app.init();
    </script>
</body>
</html>