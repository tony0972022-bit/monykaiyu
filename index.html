<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºæ…§é›²ç«¯è¨˜å¸³æœ¬ (Proç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Excel Export Library (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Markdown Parser for AI Chat -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6;
            width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        #imageViewerModal { transition: opacity 0.3s ease; }
        .item-row { transition: all 0.2s; }
        .item-row:hover { background-color: #f8fafc; }
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: bold; }
        .tx-group-header { cursor: pointer; transition: background-color 0.2s; }
        .tx-group-header:hover { background-color: #f0f9ff; }
        .tx-detail-row { background-color: #f8fafc; animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-800 text-white flex flex-col shadow-xl z-20 hidden md:flex">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-wallet text-emerald-400"></i> AI é›²ç«¯è¨˜å¸³
            </h1>
            <div id="currentUserDisplay" class="mt-6 p-3 bg-slate-700/50 rounded-xl cursor-pointer hover:bg-slate-700 transition group" onclick="ui.openUserProfile()">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-lg">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-bold text-white group-hover:text-emerald-300 transition truncate"><span id="sidebarUserName">æœªç™»å…¥</span></p>
                        <p class="text-xs text-slate-400">è¨­å®š / åˆ‡æ›</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 flex-1 overflow-y-auto">
            <div class="flex justify-between items-center mb-4 text-slate-400 text-sm font-bold uppercase">
                <span>æˆ‘çš„å¸³æœ¬</span>
                <button onclick="ui.openModal('ledgerModal')" class="hover:text-white transition"><i class="fa-solid fa-plus"></i></button>
            </div>
            <ul id="ledgerList" class="space-y-2"></ul>
            
            <div id="archivedSection" class="mt-6 hidden">
                <div class="text-xs text-slate-500 font-bold uppercase mb-2 border-t border-slate-700 pt-4">å·²æ­¸æª” / çµç®—</div>
                <ul id="archivedLedgerList" class="space-y-2"></ul>
            </div>
        </div>

        <div class="p-4 border-t border-slate-700 space-y-2">
            <button onclick="ui.openModal('importModal')" class="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-700 transition text-slate-300 hover:text-white">
                <i class="fa-solid fa-file-import text-emerald-400"></i> åŒ¯å…¥ Excel
            </button>
            <button onclick="ui.openSettings()" class="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-700 transition text-slate-300 hover:text-white">
                <i class="fa-solid fa-gear"></i> ç³»çµ±è¨­å®š
            </button>
            <button onclick="ui.logout()" class="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-700 transition text-slate-300 hover:text-white">
                <i class="fa-solid fa-right-from-bracket"></i> ç™»å‡º
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-y-auto">
        <header class="bg-white p-4 shadow-sm flex justify-between items-center md:hidden sticky top-0 z-30">
            <h1 class="font-bold text-lg"><i class="fa-solid fa-wallet text-emerald-500"></i> è¨˜å¸³æœ¬</h1>
            <button onclick="ui.toggleMobileMenu()" class="text-gray-600"><i class="fa-solid fa-bars text-xl"></i></button>
        </header>

        <div class="bg-white border-b border-gray-200 p-6 flex justify-between items-center flex-wrap gap-4 sticky top-0 z-20 shadow-sm md:static">
            <div>
                <h2 id="currentLedgerTitle" class="text-2xl font-bold text-gray-800">è¼‰å…¥ä¸­...</h2>
                <div class="flex items-center gap-2 mt-1">
                    <span id="ledgerTypeBadge" class="hidden px-2 py-0.5 rounded text-xs font-bold bg-blue-100 text-blue-700">å€‹äºº</span>
                    <span id="ledgerStatusBadge" class="hidden px-2 py-0.5 rounded text-xs font-bold bg-gray-200 text-gray-600">å·²æ­¸æª”</span>
                    <p id="ledgerMembers" class="text-gray-500 text-sm hidden"></p>
                </div>
            </div>
            <div class="flex gap-2 items-center">
                <div class="flex bg-gray-100 rounded-lg p-1 mr-2" id="globalDateFilter">
                    <select id="ledgerYear" class="bg-transparent text-sm font-bold text-gray-700 p-1 outline-none" onchange="app.updateLedgerView()"></select>
                    <div class="w-[1px] bg-gray-300 my-1"></div>
                    <select id="ledgerMonth" class="bg-transparent text-sm font-bold text-gray-700 p-1 outline-none" onchange="app.updateLedgerView()"></select>
                </div>
                <button id="settleBtn" onclick="app.calculateDebt()" class="hidden bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow transition flex items-center gap-2 font-medium text-sm">
                    <i class="fa-solid fa-calculator"></i> åˆ†å¸³
                </button>
                <button onclick="ui.openRecurringModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2.5 rounded-lg shadow transition flex items-center gap-2 font-medium text-sm">
                    <i class="fa-solid fa-calendar-check"></i> å›ºå®šæ”¶æ”¯
                </button>
                <button id="addTxBtn" onclick="ui.openTransactionModal()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-lg shadow transition flex items-center gap-2 font-medium">
                    <i class="fa-solid fa-plus"></i> è¨˜ä¸€ç­†
                </button>
            </div>
        </div>

        <!-- Dashboard Cards -->
        <div class="p-4 grid grid-cols-3 gap-3 md:gap-6">
            <div class="bg-white p-3 md:p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                <p class="text-gray-500 text-xs font-bold uppercase mb-1">ç¸½æ”¯å‡º</p>
                <p id="totalExpense" class="text-lg md:text-3xl font-bold text-rose-600">$0</p>
            </div>
            <div class="bg-white p-3 md:p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                <p class="text-gray-500 text-xs font-bold uppercase mb-1">ç¸½æ”¶å…¥</p>
                <p id="totalIncome" class="text-lg md:text-3xl font-bold text-emerald-600">$0</p>
            </div>
            <div class="bg-white p-3 md:p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                <p class="text-gray-500 text-xs font-bold uppercase mb-1">çµé¤˜</p>
                <p id="totalBalance" class="text-lg md:text-3xl font-bold text-blue-600">$0</p>
            </div>
        </div>

        <!-- In-Ledger Analysis Section -->
        <div class="px-6 py-4">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <div class="flex gap-4 overflow-x-auto pb-2">
                    <div class="flex-1 min-w-[300px]">
                        <h4 class="text-xs font-bold text-rose-500 uppercase mb-2 border-b border-rose-100 pb-1">å„é …æ¶ˆè²»çµ±è¨ˆ (ä¾é¡åˆ¥)</h4>
                        <div id="topExpenseList" class="space-y-2"></div>
                    </div>
                    <div class="flex-1 min-w-[300px]">
                        <h4 class="text-xs font-bold text-emerald-500 uppercase mb-2 border-b border-emerald-100 pb-1">å„é …æ”¶å…¥ä¾†æº (ä¾é¡åˆ¥)</h4>
                        <div id="topIncomeList" class="space-y-2"></div>
                    </div>
                    <div class="flex-1 min-w-[300px]">
                        <h4 class="text-xs font-bold text-indigo-500 uppercase mb-2 border-b border-indigo-100 pb-1">å¸¸å»å•†åº— / å°è±¡çµ±è¨ˆ</h4>
                        <div id="topMerchantList" class="space-y-2"></div>
                    </div>
                    <div class="flex-1 min-w-[300px]">
                        <h4 class="text-xs font-bold text-orange-500 uppercase mb-2 border-b border-orange-100 pb-1">é£²é£Ÿç´°é …åˆ†æ (æ—©/åˆ/æ™šé¤)</h4>
                        <div id="dietAnalysisList" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction List -->
        <div class="flex-1 p-6 pt-0">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-[600px]">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-gray-700" id="listHeaderTitle">äº¤æ˜“ç´€éŒ„</h3>
                    <div class="flex items-center gap-2">
                         <button id="bulkDeleteBtn" onclick="app.deleteSelected()" class="hidden text-xs bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded font-bold transition flex items-center gap-1">
                            <i class="fa-solid fa-trash-can"></i> åˆªé™¤é¸å– (<span id="selectedCount">0</span>)
                         </button>
                         <button onclick="app.exportCurrentList()" class="text-xs bg-emerald-100 hover:bg-emerald-200 text-emerald-700 px-3 py-1 rounded font-bold transition flex items-center gap-1">
                            <i class="fa-solid fa-file-export"></i> åŒ¯å‡ºæ¸…å–®
                         </button>
                        <div id="loadingIndicator" class="hidden flex items-center gap-2 text-sm text-gray-500">
                            <div class="loader"></div> åŒæ­¥ä¸­...
                        </div>
                    </div>
                </div>
                <div class="overflow-y-auto flex-1 relative">
                    <table class="w-full text-left border-collapse">
                        <thead class="sticky top-0 bg-gray-50 z-10 shadow-sm">
                            <tr class="text-gray-500 text-sm border-b border-gray-100">
                                <th class="p-4 w-10 text-center"><input type="checkbox" id="selectAllTx" onchange="ui.toggleSelectAll(this)" class="w-4 h-4 cursor-pointer"></th>
                                <th class="p-4 font-medium w-32">æ—¥æœŸ</th>
                                <th class="p-4 font-medium">å•†åº— / é …ç›®é¡åˆ¥</th>
                                <th class="p-4 font-medium text-right w-32">ç¸½é‡‘é¡</th>
                                <th class="p-4 font-medium text-center w-16"></th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <tr><td colspan="5" class="p-8 text-center text-gray-400">å°šæœªé¸æ“‡å¸³æœ¬æˆ–ç„¡è³‡æ–™</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: User Profile & Rename -->
    <div id="userProfileModal" class="fixed inset-0 bg-slate-900/90 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl p-6 m-4 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-id-card text-indigo-500"></i> å€‹äººä¸­å¿ƒ</h3>
                <button onclick="ui.closeModal('userProfileModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>

            <!-- Tabs -->
            <div class="flex gap-4 border-b border-gray-200 mb-4 overflow-x-auto">
                <button onclick="ui.switchProfileTab('overview')" id="tab-overview" class="tab-btn active px-2 py-2 text-sm text-gray-600 hover:text-blue-600 transition whitespace-nowrap">å¸³æœ¬æ¦‚æ³</button>
                <button onclick="ui.switchProfileTab('assets')" id="tab-assets" class="tab-btn px-2 py-2 text-sm text-gray-600 hover:text-blue-600 transition whitespace-nowrap">æˆ‘çš„è³‡ç”¢</button>
                <button onclick="ui.switchProfileTab('settings')" id="tab-settings" class="tab-btn px-2 py-2 text-sm text-gray-600 hover:text-blue-600 transition whitespace-nowrap">å€‹äººè¨­å®š</button>
            </div>

            <div class="overflow-y-auto flex-1 pr-2">
                <!-- TAB 1: Overview -->
                <div id="content-overview">
                    <div class="flex flex-wrap items-center gap-3 mb-4 bg-gray-50 p-3 rounded-xl sticky top-0 z-10 shadow-sm">
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-bold text-gray-500">å¹´ä»½</label>
                            <select id="statYear" class="p-1.5 border border-gray-300 rounded text-sm" onchange="app.loadUserStats()"></select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-bold text-gray-500">æœˆä»½</label>
                            <select id="statMonth" class="p-1.5 border border-gray-300 rounded text-sm" onchange="app.loadUserStats()"></select>
                        </div>
                        <div class="flex items-center gap-2 ml-auto">
                            <input type="checkbox" id="showDetailsCheck" class="w-4 h-4 text-blue-600 rounded" onchange="app.loadUserStats()">
                            <label for="showDetailsCheck" class="text-sm text-gray-600 select-none cursor-pointer">é¡¯ç¤ºè©³ç´°çµ±è¨ˆ</label>
                        </div>
                        <button onclick="app.exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1 shadow-sm">
                            <i class="fa-solid fa-file-excel"></i> åŒ¯å‡ºExcel
                        </button>
                    </div>
                    <div id="statsLoader" class="hidden text-center py-10 text-gray-500"><div class="loader mx-auto mb-2"></div>æ•¸æ“šåˆ†æä¸­...</div>
                    <div id="ledgerStatsContainer" class="space-y-4"></div>
                </div>

                <!-- TAB 2: Assets -->
                <div id="content-assets" class="hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-5 text-white mb-6 shadow-lg">
                        <p class="text-blue-100 text-sm mb-1">å€‹äººè³‡ç”¢ç¸½è¨ˆ</p>
                        <h2 class="text-3xl font-bold" id="totalAssetDisplay">$0</h2>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                        <h4 class="font-bold text-gray-700 mb-3 text-sm" id="assetActionTitle">æ–°å¢ / æ›´æ–°è³‡ç”¢</h4>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="assetNameInput" list="assetNamesList" placeholder="å¸³æˆ¶åç¨± (å¦‚: ç‰å±±éŠ€è¡Œ)" class="flex-1 p-2 border border-gray-300 rounded text-sm">
                            <datalist id="assetNamesList"></datalist>
                            <input type="number" id="assetBalanceInput" placeholder="ç›®å‰é‡‘é¡" class="w-1/3 p-2 border border-gray-300 rounded text-sm">
                        </div>
                        <button onclick="app.saveAsset()" class="w-full bg-slate-800 text-white py-2 rounded text-sm font-bold hover:bg-slate-900 transition">æ›´æ–°é¤˜é¡</button>
                        <p class="text-xs text-gray-400 mt-2">* è‹¥åç¨±ç›¸åŒå‰‡æœƒæ›´æ–°é¤˜é¡ä¸¦è¨˜éŒ„æ­·å²ã€‚</p>
                    </div>
                    <h4 class="font-bold text-gray-700 mb-3 text-sm border-b border-gray-200 pb-2">è³‡ç”¢åˆ—è¡¨</h4>
                    <div id="assetsList" class="space-y-3">
                        <div class="text-center text-gray-400 py-4 text-sm">æš«ç„¡è³‡ç”¢ç´€éŒ„</div>
                    </div>
                </div>

                <!-- TAB 3: Settings -->
                <div id="content-settings" class="hidden">
                    <div class="bg-gray-50 p-5 rounded-xl border border-gray-100">
                        <label class="block text-xs font-bold text-gray-800 uppercase mb-2">ä¿®æ”¹é¡¯ç¤ºåç¨±</label>
                        <div class="flex gap-2">
                            <input type="text" id="renameInput" placeholder="è¼¸å…¥æ–°åç¨±" class="flex-1 p-3 border border-gray-300 rounded-lg font-bold text-gray-700">
                            <button onclick="app.renameUser()" id="renameBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-6 rounded-lg font-bold transition whitespace-nowrap">ç¢ºèª</button>
                        </div>
                        <p class="text-xs text-gray-400 mt-2"><i class="fa-solid fa-circle-exclamation"></i> é€™æœƒæ›´æ–°æ‰€æœ‰å¸³æœ¬ä¸­çš„é¡¯ç¤ºåç¨±ã€‚</p>
                    </div>
                    <div class="mt-4 text-center">
                         <button onclick="ui.logout()" class="text-sm text-red-500 hover:underline"><i class="fa-solid fa-right-from-bracket"></i> ç™»å‡º/åˆ‡æ›å¸³è™Ÿ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Login / User Select (Updated with Delete) -->
    <div id="loginModal" class="fixed inset-0 bg-slate-900/95 z-[90] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-8 m-4 animate-fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl"><i class="fa-solid fa-user-group"></i></div>
                <h3 class="text-xl font-bold text-gray-800">è«‹é¸æ“‡æ‚¨çš„èº«åˆ†</h3>
                <p class="text-gray-500 text-sm">å¤šäººå¸³æœ¬å°‡ä¾æ“šæ­¤èº«åˆ†é€²è¡Œåˆ†å¸³</p>
            </div>
            <div id="existingUserSection" class="mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">é¸æ“‡ç¾æœ‰è§’è‰²</label>
                <!-- Updated: Flex container for Select + Delete Button -->
                <div class="flex gap-2 mb-3">
                    <select id="loginUserSelect" class="flex-1 p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">è¼‰å…¥ä¸­...</option>
                    </select>
                    <button onclick="app.deleteUser()" class="bg-red-50 border border-red-200 text-red-500 px-3 rounded-lg hover:bg-red-100 transition" title="åˆªé™¤æ­¤ä½¿ç”¨è€…">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
                <button onclick="app.loginExistingUser()" class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold transition">ç™»å…¥</button>
            </div>
            <div class="relative flex py-2 items-center mb-6">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">æˆ–</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">å»ºç«‹æ–°è§’è‰²</label>
                <div class="flex gap-2">
                    <input type="text" id="newUserNameInput" placeholder="è¼¸å…¥æ–°æš±ç¨±" class="flex-1 p-3 border border-gray-300 rounded-lg text-sm">
                    <button onclick="app.registerNewUser()" id="btnRegister" class="bg-gray-800 text-white px-4 rounded-lg hover:bg-gray-900 transition">å»ºç«‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TRANSACTION MODAL -->
    <div id="transactionModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 m-4 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="txModalTitle">ğŸ“ æ–°å¢ç´€éŒ„</h3>
                <button onclick="ui.closeModal('transactionModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <form id="transactionForm" onsubmit="app.addTransaction(event)" class="space-y-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">é¡å‹</label><select id="tType" class="w-full p-2 bg-white border border-gray-200 rounded-lg text-sm" onchange="ui.updateCategoriesForRows()"><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">æ—¥æœŸ</label><input type="date" id="tDate" required class="w-full p-2 bg-white border border-gray-200 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">å•†åº—/å°è±¡ (é¸å¡«)</label><input type="text" id="tMerchant" placeholder="ä¾‹å¦‚: 7-11, å…¨è¯" class="w-full p-2 bg-white border border-gray-200 rounded-lg text-sm"></div>
                    <div id="groupPayerField" class="hidden col-span-2 md:col-span-2"><label class="block text-xs font-bold text-yellow-700 uppercase mb-1">ä»˜æ¬¾äºº</label><select id="tPaidBy" class="w-full p-2 bg-white border border-yellow-200 rounded-lg text-sm"></select></div>
                    <div class="col-span-2 md:col-span-4 flex gap-2 items-center bg-yellow-50 p-2 rounded-lg border border-yellow-100">
                        <label class="whitespace-nowrap text-xs font-bold text-yellow-700">å¹£åˆ¥</label>
                        <select id="tCurrency" class="w-24 p-1.5 bg-white border border-yellow-200 rounded text-sm" onchange="app.updateRate()">
                            <option value="TWD">TWD (å°å¹£)</option>
                            <option value="JPY">JPY (æ—¥å¹£)</option>
                            <option value="USD">USD (ç¾é‡‘)</option>
                            <option value="KRW">KRW (éŸ“å…ƒ)</option>
                            <option value="EUR">EUR (æ­å…ƒ)</option>
                            <option value="CNY">CNY (äººæ°‘å¹£)</option>
                        </select>
                        <input type="number" id="tRate" step="0.001" placeholder="åŒ¯ç‡" class="w-20 p-1.5 bg-white border border-yellow-200 rounded text-sm" oninput="ui.updateTotal()">
                        <span id="rateHint" class="text-xs text-yellow-600"></span>
                    </div>
                </div>
                <div class="border rounded-xl overflow-hidden border-gray-200">
                    <div class="bg-gray-100 p-2 grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 text-center"><div class="col-span-5 text-left pl-2">é …ç›®åç¨±</div><div class="col-span-3">åˆ†é¡</div><div class="col-span-3">é‡‘é¡</div><div class="col-span-1"></div></div>
                    <div id="transactionItemsList" class="max-h-60 overflow-y-auto"></div>
                    <div class="p-2 bg-gray-50 border-t border-gray-200"><button type="button" onclick="ui.addItemRow()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-emerald-400 hover:text-emerald-500 transition text-sm font-bold"><i class="fa-solid fa-plus"></i> æ–°å¢å“é …</button></div>
                </div>
                <div class="flex justify-between items-center px-2">
                    <div class="text-sm text-gray-500">å…± <span id="itemCount">1</span> ç­†é …ç›®</div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400 mb-1" id="totalLabel">ç¸½é¡ (ç•¶åœ°å¹£å€¼)</p>
                        <p class="text-2xl font-bold text-emerald-600" id="displayTotal">$0</p>
                        <p id="twdPreview" class="text-xs text-indigo-600 font-bold hidden">æ›ç®— NT$ <span>0</span></p>
                    </div>
                </div>
                <input type="hidden" id="editingTxId">
                <div class="pt-2"><button type="submit" id="submitBtn" class="w-full py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-bold shadow-md transition">ç¢ºèªå„²å­˜</button></div>
            </form>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, getDocs, doc, setDoc, getDoc, updateDoc, deleteDoc, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const FIREBASE_CONFIG = { apiKey: "AIzaSyDqFr0ZkTb9ZdYFaf8S95pjJLEezTF4QwQ", authDomain: "mony-a292c.firebaseapp.com", projectId: "mony-a292c", storageBucket: "mony-a292c.firebasestorage.app", messagingSenderId: "1012872104399", appId: "1:1012872104399:web:8289e7b26d846246fdaaba" };
        
        const DEFAULT_CATEGORIES = { 
            expense: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'é£²æ–™', 'é»å¿ƒ', 'é£²é£Ÿ', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'æ•™è‚²', 'å…¶ä»–'], 
            income: ['è–ªæ°´', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–'] 
        };

        const state = {
            db: null, auth: null, user: null,
            userName: localStorage.getItem('acc_username') || '', 
            ledgers: [], currentLedger: null, transactions: [],
            rates: { TWD: 1, JPY: 0.22, USD: 31.5, KRW: 0.024, EUR: 34.5, CNY: 4.4 },
            categories: JSON.parse(localStorage.getItem('acc_custom_categories')) || DEFAULT_CATEGORIES,
            assets: [], unsubscribeAssets: null
        };

        const app = {
            init: async () => {
                const firebaseApp = initializeApp(FIREBASE_CONFIG);
                state.db = getFirestore(firebaseApp);
                state.auth = getAuth(firebaseApp);

                await signInAnonymously(state.auth);
                onAuthStateChanged(state.auth, (u) => { state.user = u; });

                app.fetchRates();
                app.initDateFilters();

                if (!state.userName) {
                    await app.loadUsersList();
                    ui.openModal('loginModal');
                } else {
                    document.getElementById('sidebarUserName').innerText = state.userName;
                    app.listenLedgers();
                    app.listenAssets(); // Fix: Ensure assets are listened to on reload
                }
            },

            initDateFilters: () => {
                const yr = new Date().getFullYear();
                const ySel = document.getElementById('ledgerYear');
                const mSel = document.getElementById('ledgerMonth');
                let yOpts = `<option value="${yr}">${yr}å¹´</option>`;
                for (let i = 1; i <= 5; i++) yOpts += `<option value="${yr-i}">${yr-i}å¹´</option>`;
                ySel.innerHTML = yOpts;
                ySel.value = yr;

                let mOpts = `<option value="all">å…¨å¹´</option>`;
                for (let i = 1; i <= 12; i++) mOpts += `<option value="${i.toString().padStart(2, '0')}">${i}æœˆ</option>`;
                mSel.innerHTML = mOpts;
                mSel.value = (new Date().getMonth() + 1).toString().padStart(2, '0');
            },

            loadUsersList: async () => {
                try {
                    const s = await getDocs(collection(state.db, "users"));
                    const sl = document.getElementById('loginUserSelect');
                    sl.innerHTML = '<option value="">è«‹é¸æ“‡è§’è‰²...</option>';
                    s.forEach(d => { sl.innerHTML += `<option value="${d.id}">${d.id}</option>`; });
                    if (s.empty) document.getElementById('existingUserSection').classList.add('hidden');
                    else document.getElementById('existingUserSection').classList.remove('hidden');
                } catch (e) { console.error("Load users failed", e); }
            },

            registerNewUser: async () => {
                const n = document.getElementById('newUserNameInput').value.trim();
                if (!n) return alert("è«‹è¼¸å…¥åç¨±");
                const btn = document.getElementById('btnRegister');
                btn.disabled = true;
                try {
                    const userRef = doc(state.db, "users", n);
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        alert("æ­¤åç¨±å·²å­˜åœ¨");
                    } else {
                        await setDoc(userRef, { createdAt: new Date().toISOString(), createdBy: state.user?.uid || 'anon' });
                        app.performLogin(n);
                    }
                } catch (e) {
                    alert("å»ºç«‹å¸³è™Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase æ¬Šé™ã€‚");
                    console.error(e);
                } finally { btn.disabled = false; }
            },

            loginExistingUser: () => {
                const n = document.getElementById('loginUserSelect').value;
                if (!n) return alert("è«‹é¸æ“‡è§’è‰²");
                app.performLogin(n);
            },

            // New: Delete User Function
            deleteUser: async () => {
                const n = document.getElementById('loginUserSelect').value;
                if (!n) return alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è§’è‰²");
                if (!confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ã€Œ${n}ã€é€™å€‹è§’è‰²å—ï¼Ÿ\n(æ³¨æ„ï¼šç›¸é—œçš„è¨˜å¸³è³‡æ–™å¯èƒ½ä¸æœƒè¢«åˆªé™¤ï¼Œä½†è§’è‰²å°‡ç„¡æ³•ç™»å…¥)`)) return;
                
                try {
                    await deleteDoc(doc(state.db, "users", n));
                    alert("å·²åˆªé™¤è§’è‰²");
                    app.loadUsersList(); // Refresh list
                } catch (e) {
                    alert("åˆªé™¤å¤±æ•—: " + e.message);
                }
            },

            performLogin: (n) => {
                state.userName = n;
                localStorage.setItem('acc_username', n);
                document.getElementById('sidebarUserName').innerText = n;
                ui.closeModal('loginModal');
                
                // Fix: Reset View
                state.ledgers = [];
                state.transactions = [];
                state.assets = [];
                document.getElementById('ledgerList').innerHTML = '';
                document.getElementById('transactionTableBody').innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">è¼‰å…¥ä¸­...</td></tr>';
                document.getElementById('totalAssetDisplay').innerText = '$0';
                
                app.listenLedgers();
                app.listenAssets();
            },

            listenAssets: () => {
                if(!state.userName) return;
                if(state.unsubscribeAssets) state.unsubscribeAssets();
                const q = query(collection(state.db, "user_assets"), where("userId", "==", state.userName));
                state.unsubscribeAssets = onSnapshot(q, (snapshot) => {
                    state.assets = [];
                    snapshot.forEach(doc => state.assets.push({ id: doc.id, ...doc.data() }));
                    ui.renderAssets();
                    ui.renderAssetOptions(); 
                });
            },

            saveAsset: async () => {
                const name = document.getElementById('assetNameInput').value.trim();
                const balance = parseFloat(document.getElementById('assetBalanceInput').value);
                if (!name || isNaN(balance)) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");

                const existing = state.assets.find(a => a.name === name);
                const historyEntry = { date: new Date().toISOString(), balance: balance };

                try {
                    if (existing) {
                        const newHistory = [...(existing.history || []), historyEntry];
                        await updateDoc(doc(state.db, "user_assets", existing.id), {
                            currentBalance: balance,
                            updatedAt: new Date().toISOString(),
                            history: newHistory
                        });
                    } else {
                        await addDoc(collection(state.db, "user_assets"), {
                            userId: state.userName,
                            name: name,
                            currentBalance: balance,
                            updatedAt: new Date().toISOString(),
                            history: [historyEntry]
                        });
                    }
                    document.getElementById('assetNameInput').value = '';
                    document.getElementById('assetBalanceInput').value = '';
                    alert("è³‡ç”¢å·²æ›´æ–°");
                } catch (e) {
                    console.error(e);
                    alert("æ›´æ–°å¤±æ•—");
                }
            },

            deleteAsset: async (id) => {
                if(confirm("ç¢ºå®šåˆªé™¤æ­¤è³‡ç”¢ç´€éŒ„ï¼Ÿ")) {
                    await deleteDoc(doc(state.db, "user_assets", id));
                }
            },

            editAsset: (name, balance) => {
                document.getElementById('assetNameInput').value = name;
                document.getElementById('assetBalanceInput').value = balance;
                const contentAssets = document.getElementById('content-assets');
                contentAssets.scrollTop = 0;
                document.getElementById('assetBalanceInput').focus();
            },

            renameUser: async () => {
                const n = document.getElementById('renameInput').value.trim();
                const o = state.userName;
                const btn = document.getElementById('renameBtn');
                
                if (!n) return;
                if (n === o) return alert("åç¨±æœªè®Šæ›´");
                if (!confirm(`ç¢ºå®šè¦æ”¹åç‚º "${n}"ï¼Ÿ`)) return;
                
                btn.disabled = true; 
                btn.innerText = 'æ›´æ–°ä¸­...';
                try { 
                    const bat = writeBatch(state.db); 
                    bat.set(doc(state.db, "users", n), { createdAt: new Date().toISOString() }); 
                    
                    const q = query(collection(state.db, "ledgers"), where("members", "array-contains", o));
                    const snap = await getDocs(q);
                    
                    snap.forEach(d => { 
                        const m = d.data().members.map(x => x === o ? n : x); 
                        bat.update(d.ref, { members: m, ...(d.data().createdBy === o && { createdBy: n }) }); 
                    }); 
                    
                    (await getDocs(query(collection(state.db, "transactions"), where("paidBy", "==", o)))).forEach(d => bat.update(d.ref, { paidBy: n })); 
                    (await getDocs(query(collection(state.db, "transactions"), where("lastEditedBy", "==", o)))).forEach(d => bat.update(d.ref, { lastEditedBy: n })); 
                    bat.delete(doc(state.db, "users", o)); 
                    
                    await bat.commit(); 
                    alert("æ›´åæˆåŠŸ"); 
                    app.performLogin(n); 
                    location.reload(); 
                } catch (e) { 
                    alert("æ›´åå¤±æ•—:" + e.message); 
                    btn.disabled = false; 
                    btn.innerText = 'ç¢ºèª'; 
                } 
            },

            loadUserStats: async () => {
                const y=document.getElementById('statYear').value;
                const m=document.getElementById('statMonth').value;
                const cnt=document.getElementById('ledgerStatsContainer');
                const ldr=document.getElementById('statsLoader');
                if(!y || !m) return;
                
                ldr.classList.remove('hidden');
                cnt.innerHTML='';
                try{
                    let tx=[];
                    const proms=state.ledgers.map(l=>getDocs(query(collection(state.db,"transactions"),where("ledgerId","==",l.id))).then(s=>s.docs.map(d=>({...d.data(),id:d.id,ledgerName:l.name,ledgerType:l.type,ledgerMembers:l.members}))));
                    const res=await Promise.all(proms);
                    tx=res.flat();
                    
                    const ftx=tx.filter(t=>{
                        const d=new Date(t.date);
                        return d.getFullYear().toString()===y&&(m==='all'||(d.getMonth()+1).toString().padStart(2,'0')===m);
                    });
                    
                    if(ftx.length === 0) {
                        cnt.innerHTML='<div class="text-center text-gray-400 py-4">æ­¤å€é–“ç„¡è³‡æ–™</div>';
                    } else {
                        state.ledgers.forEach(l=>{
                            const ltx=ftx.filter(t=>t.ledgerId===l.id);
                            if(ltx.length===0)return;
                            let my=0,tot=0;
                            ltx.forEach(t=>{if(t.type==='expense'){tot+=t.amount;if(l.type==='personal'||t.paidBy===state.userName)my+=t.amount;}});
                            cnt.innerHTML+=`<div class="bg-white p-4 rounded-xl border mb-3"><div class="flex justify-between"><div><h4 class="font-bold text-sm">${l.name}</h4><p class="text-xl font-bold text-blue-600">$${my.toLocaleString()}</p></div><div class="text-xs text-gray-400 text-right">ç¸½æ”¯å‡º: $${tot.toLocaleString()}<br>${l.type==='group'?l.members.length+'äºº':''}</div></div></div>`;
                        });
                    }
                }catch(e){console.error(e);}finally{ldr.classList.add('hidden');}
            },

            exportToExcel: () => { 
                const y = document.getElementById('statYear').value;
                const m = document.getElementById('statMonth').value;
                if (!state.ledgers.length) return alert("ç„¡å¸³æœ¬è³‡æ–™");
                
                // Fetch fresh data for export to ensure accuracy
                app.loadUserStats().then(() => {
                     // Normally would use cached data, but for simplicity triggering loadUserStats
                     alert("è«‹å…ˆé è¦½çµ±è¨ˆè³‡æ–™å¾Œå†å˜—è©¦åŒ¯å‡º (åŠŸèƒ½ç°¡åŒ–ç‰ˆ)");
                });
            },

            fetchRates: async () => {
                try {
                    const r = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                    const d = await r.json();
                    if (d.rates) state.rates = { TWD: 1, JPY: 1/d.rates.JPY, USD: 1/d.rates.USD, KRW: 1/d.rates.KRW, EUR: 1/d.rates.EUR, CNY: 1/d.rates.CNY };
                } catch (e) { console.warn("Rate fetch failed, using defaults."); }
            },

            updateRate: () => {
                const c = document.getElementById('tCurrency').value;
                document.getElementById('tRate').value = state.rates[c] ? state.rates[c].toFixed(3) : 1;
                ui.updateTotal();
            },

            listenLedgers: () => {
                onSnapshot(collection(state.db, "ledgers"), s => {
                    state.ledgers = [];
                    s.forEach(d => {
                        const data = d.data();
                        if (data.members?.includes(state.userName) || data.createdBy === state.userName) {
                            state.ledgers.push({ id: d.id, ...data });
                        }
                    });
                    if (!state.currentLedger && state.ledgers.length > 0) ui.switchLedger(state.ledgers[0].id);
                    ui.renderLedgerList();
                });
            },

            addTransaction: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('submitBtn');
                btn.disabled = true;
                const rows = document.querySelectorAll('.item-row');
                const date = document.getElementById('tDate').value;
                const type = document.getElementById('tType').value;
                const merchant = document.getElementById('tMerchant').value.trim();
                const currency = document.getElementById('tCurrency').value;
                const rate = parseFloat(document.getElementById('tRate').value) || 1;
                const paidBy = document.getElementById('tPaidBy').value || state.userName;
                const groupId = Date.now().toString();

                try {
                    const batch = writeBatch(state.db);
                    rows.forEach(r => {
                        const n = r.querySelector('.item-name').value.trim();
                        const c = r.querySelector('.item-cat').value;
                        const originalAmount = parseFloat(r.querySelector('.item-amount').value) || 0;
                        if (!n && originalAmount === 0) return;
                        const finalAmount = Math.round(originalAmount * rate);

                        batch.set(doc(collection(state.db, "transactions")), {
                            ledgerId: state.currentLedger.id,
                            name: n, category: c, type: type, date: date,
                            amount: finalAmount, originalAmount: originalAmount,
                            currency: currency, exchangeRate: rate,
                            merchant: merchant, paidBy: paidBy, groupId: groupId,
                            createdAt: new Date().toISOString(), lastEditedBy: state.userName
                        });
                    });
                    await batch.commit();
                    ui.closeModal('transactionModal');
                } catch (e) { alert("å„²å­˜å¤±æ•—"); console.error(e); } finally { btn.disabled = false; }
            },

            updateLedgerView: () => {
                if (!state.currentLedger) return;
                const y = document.getElementById('ledgerYear').value;
                const m = document.getElementById('ledgerMonth').value;
                const filtered = state.transactions.filter(t => {
                    const d = new Date(t.date);
                    return d.getFullYear().toString() === y && (m === 'all' || (d.getMonth() + 1).toString().padStart(2, '0') === m);
                });
                ui.renderTransactionList(filtered);
                ui.renderTopStats(filtered);
            }
        };

        const ui = {
            openModal: (id) => document.getElementById(id).classList.remove('hidden'),
            closeModal: (id) => document.getElementById(id).classList.add('hidden'),

            openTransactionModal: () => {
                document.getElementById('transactionForm').reset();
                document.getElementById('transactionItemsList').innerHTML = '';
                document.getElementById('tCurrency').value = 'TWD';
                document.getElementById('tRate').value = '1.000';
                document.getElementById('tDate').valueAsDate = new Date();
                
                if (state.currentLedger?.type === 'group') {
                    const sel = document.getElementById('tPaidBy');
                    sel.innerHTML = state.currentLedger.members.map(m => `<option value="${m}">${m}</option>`).join('');
                    sel.value = state.userName;
                    document.getElementById('groupPayerField').classList.remove('hidden');
                } else {
                    document.getElementById('groupPayerField').classList.add('hidden');
                }

                ui.addItemRow();
                ui.updateTotal();
                ui.openModal('transactionModal');
            },

            addItemRow: () => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-12 gap-2 p-2 border-b item-row';
                const type = document.getElementById('tType').value;
                div.innerHTML = `
                    <div class="col-span-5"><input class="item-name w-full border p-1 rounded" placeholder="å“é …"></div>
                    <div class="col-span-3"><select class="item-cat w-full border p-1 rounded">${state.categories[type].map(c=>`<option>${c}</option>`).join('')}</select></div>
                    <div class="col-span-3"><input type="number" class="item-amount w-full border p-1 rounded" placeholder="0" oninput="ui.updateTotal()"></div>
                    <div class="col-span-1 text-center"><button type="button" onclick="this.parentElement.parentElement.remove();ui.updateTotal()"><i class="fa-solid fa-times text-gray-400"></i></button></div>
                `;
                document.getElementById('transactionItemsList').appendChild(div);
                ui.updateTotal();
            },

            updateTotal: () => {
                let localSum = 0;
                document.querySelectorAll('.item-amount').forEach(i => localSum += parseFloat(i.value) || 0);
                const currency = document.getElementById('tCurrency').value;
                const rate = parseFloat(document.getElementById('tRate').value) || 1;
                const twdSum = Math.round(localSum * rate);

                const displayTotalEl = document.getElementById('displayTotal');
                const twdPreviewEl = document.getElementById('twdPreview');

                displayTotalEl.innerText = (currency !== 'TWD' ? currency + ' ' : '$') + localSum.toLocaleString();
                
                if (currency !== 'TWD' && rate !== 1) {
                    twdPreviewEl.classList.remove('hidden');
                    twdPreviewEl.querySelector('span').innerText = twdSum.toLocaleString();
                } else {
                    twdPreviewEl.classList.add('hidden');
                }
                document.getElementById('itemCount').innerText = document.querySelectorAll('.item-row').length;
            },

            switchLedger: (id) => {
                state.currentLedger = state.ledgers.find(l => l.id === id);
                document.getElementById('currentLedgerTitle').innerText = state.currentLedger.name;
                ui.renderLedgerList();
                onSnapshot(query(collection(state.db, "transactions"), where("ledgerId", "==", id)), snap => {
                    state.transactions = [];
                    snap.forEach(d => state.transactions.push({ id: d.id, ...d.data() }));
                    app.updateLedgerView();
                });
            },

            renderLedgerList: () => {
                const list = document.getElementById('ledgerList');
                list.innerHTML = state.ledgers.map(l => `
                    <li><button onclick="ui.switchLedger('${l.id}')" class="w-full text-left px-4 py-3 rounded-lg flex justify-between ${l.id === state.currentLedger?.id ? 'bg-emerald-600 text-white' : 'text-slate-300 hover:bg-slate-700'}">
                        <span><i class="fa-solid ${l.type==='group'?'fa-users':'fa-book'} mr-2"></i>${l.name}</span>
                    </button></li>
                `).join('');
            },

            renderTransactionList: (list) => {
                const tb = document.getElementById('transactionTableBody');
                if (list.length === 0) { tb.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">å°šç„¡è³‡æ–™</td></tr>'; return; }
                
                let inc = 0, exp = 0;
                tb.innerHTML = list.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => {
                    if (t.type === 'expense') exp += t.amount; else inc += t.amount;
                    return `<tr class="border-b hover:bg-gray-50">
                        <td class="p-4 text-center"><input type="checkbox" class="tx-checkbox w-4 h-4"></td>
                        <td class="p-4 text-sm">${t.date}</td>
                        <td class="p-4">
                            <div class="font-bold">${t.name}</div>
                            <div class="text-xs text-gray-400">${t.category} ${t.merchant ? '@' + t.merchant : ''}</div>
                        </td>
                        <td class="p-4 text-right font-bold ${t.type==='expense'?'text-rose-600':'text-emerald-600'}">
                            ${t.type==='expense'?'-':'+'}${t.amount.toLocaleString()}
                            ${t.currency !== 'TWD' ? `<div class="text-[10px] text-gray-400">${t.currency} ${t.originalAmount}</div>` : ''}
                        </td>
                        <td class="p-4 text-center"><button class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></td>
                    </tr>`;
                }).join('');
                document.getElementById('totalIncome').innerText = '$' + inc.toLocaleString();
                document.getElementById('totalExpense').innerText = '$' + exp.toLocaleString();
                document.getElementById('totalBalance').innerText = '$' + (inc - exp).toLocaleString();
            },

            renderTopStats: (list) => {
                const catMap = {};
                list.filter(t=>t.type==='expense').forEach(t => catMap[t.category] = (catMap[t.category] || 0) + t.amount);
                const sorted = Object.entries(catMap).sort((a,b) => b[1] - a[1]).slice(0,5);
                document.getElementById('topExpenseList').innerHTML = sorted.map(([c, a]) => `<div class="flex justify-between text-xs"><span>${c}</span><span class="font-bold">$${a.toLocaleString()}</span></div>`).join('');
            },

            // Profile UI Methods
            openUserProfile: () => { 
                ui.openModal('userProfileModal'); 
                document.getElementById('renameInput').value = state.userName; 
                ui.switchProfileTab('overview'); 
            },
            switchProfileTab: (tabName) => { 
                ['overview', 'ai-assistant', 'settings', 'assets'].forEach(t => { 
                    const el = document.getElementById(`content-${t}`); 
                    const btn = document.getElementById(`tab-${t}`); 
                    if(el) el.classList.add('hidden'); 
                    if(btn) btn.classList.remove('active'); 
                }); 
                document.getElementById(`content-${tabName}`).classList.remove('hidden'); 
                document.getElementById(`tab-${tabName}`).classList.add('active'); 
                if(tabName === 'overview') app.loadUserStats(); 
            },
            logout: () => { 
                localStorage.removeItem('acc_username'); 
                location.reload(); 
            },
            updateCategoriesForRows: () => { document.querySelectorAll('.item-cat').forEach(s=>s.innerHTML=state.categories[document.getElementById('tType').value].map(c=>`<option>${c}</option>`).join('')); },
            toggleSelectAll: (source) => { document.querySelectorAll('.tx-checkbox').forEach(cb => { cb.checked = source.checked; }); ui.updateBulkActionState(); },
            updateBulkActionState: () => { const count = document.querySelectorAll('.tx-checkbox:checked').length; const btn = document.getElementById('bulkDeleteBtn'); const span = document.getElementById('selectedCount'); if (count > 0) { btn.classList.remove('hidden'); span.innerText = count; } else { btn.classList.add('hidden'); } },
            deleteSelected: async () => {
                const checked = document.querySelectorAll('.tx-checkbox:checked');
                if(checked.length === 0) return;
                if(!confirm(`ç¢ºå®šè¦åˆªé™¤é¸å–çš„ ${checked.length} ç­†/çµ„äº¤æ˜“ç´€éŒ„å—ï¼Ÿ`)) return;
                const btn = document.getElementById('bulkDeleteBtn'); btn.disabled = true; btn.innerHTML = '<div class="loader w-3 h-3 border-red-200 border-t-red-600 mr-2"></div> åˆªé™¤ä¸­...';
                try { const batch = writeBatch(state.db); checked.forEach(cb => { batch.delete(doc(state.db, "transactions", cb.closest('tr').dataset.id)); }); await batch.commit(); document.getElementById('selectAllTx').checked = false; ui.updateBulkActionState(); } catch (e) {  } finally { btn.disabled = false; btn.innerHTML = `<i class="fa-solid fa-trash-can"></i> åˆªé™¤é¸å– (<span id="selectedCount">0</span>)`; }
            },
            exportCurrentList: () => { const list = state.transactions; if (list.length === 0) return alert("ç›®å‰åˆ—è¡¨ç„¡è³‡æ–™"); const exportData = list.map(t => ({ 'æ—¥æœŸ': t.date, 'å•†åº—/å°è±¡': t.merchant || '', 'é …ç›®åç¨±': t.name, 'é¡åˆ¥': t.category, 'é¡å‹': t.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥', 'é‡‘é¡': t.amount, 'å¹£åˆ¥': t.currency, 'ä»˜æ¬¾äºº': t.paidBy || '' })); const ws = XLSX.utils.json_to_sheet(exportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Transactions"); XLSX.writeFile(wb, `äº¤æ˜“æ˜ç´°æ¸…å–®_${new Date().toISOString().slice(0,10)}.xlsx`); },
            openSettings: () => { ui.openModal('settingsModal'); },
            toggleMobileMenu: () => document.getElementById('mobileMenu').classList.toggle('hidden'),
            renderAssets: () => {
                const list = document.getElementById('assetsList');
                list.innerHTML = '';
                let total = 0;
                if (state.assets.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm">æš«ç„¡è³‡ç”¢ç´€éŒ„</div>';
                } else {
                    state.assets.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt)).forEach(asset => {
                        total += asset.currentBalance;
                        const date = new Date(asset.updatedAt).toLocaleDateString();
                        const historyHtml = (asset.history || []).sort((a, b) => new Date(b.date) - new Date(a.date)).map(h => `<li class="flex justify-between text-[10px] text-gray-500 py-1 border-b border-gray-100 last:border-0"><span>${new Date(h.date).toLocaleString()}</span><span class="font-mono">$${h.balance.toLocaleString()}</span></li>`).join('');
                        list.innerHTML += `<div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden mb-2"><div class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-50" onclick="this.nextElementSibling.classList.toggle('hidden')"><div><p class="font-bold text-gray-800">${asset.name}</p><p class="text-xs text-gray-400">æ›´æ–°æ–¼: ${date}</p></div><div class="text-right"><p class="font-mono font-bold text-indigo-600 text-lg">$${asset.currentBalance.toLocaleString()}</p><div class="flex gap-3 justify-end mt-1" onclick="event.stopPropagation()"><button onclick="app.editAsset('${asset.name}', ${asset.currentBalance})" class="text-xs font-bold text-blue-500 hover:text-blue-700"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="app.deleteAsset('${asset.id}')" class="text-xs font-bold text-red-400 hover:text-red-600"><i class="fa-solid fa-trash-can"></i></button></div></div></div><div class="hidden bg-gray-50 p-3 text-xs border-t border-gray-100"><p class="font-bold text-gray-500 mb-2 uppercase">è®Šæ›´æ­·å²</p><ul class="space-y-1 max-h-32 overflow-y-auto">${historyHtml || '<li class="text-center italic">ç„¡æ­·å²ç´€éŒ„</li>'}</ul></div></div>`;
                    });
                }
                document.getElementById('totalAssetDisplay').innerText = '$' + total.toLocaleString();
            },
            renderAssetOptions: () => { const dl = document.getElementById('assetNamesList'); if(!dl) return; dl.innerHTML = ''; const userNames = state.assets.map(a => a.name); const allNames = [...new Set([...['ä¸­è¯éƒµæ”¿', 'å°åŒ—å¯Œé‚¦', 'ä¸­åœ‹ä¿¡è¨—', 'ç‰å±±éŠ€è¡Œ', 'å°æ–°éŠ€è¡Œ', 'åœ‹æ³°ä¸–è¯'], ...userNames])]; allNames.forEach(n => { const opt = document.createElement('option'); opt.value = n; dl.appendChild(opt); }); }
        };

        window.app = app; window.ui = ui;
        app.init();
    </script>
</body>
</html>